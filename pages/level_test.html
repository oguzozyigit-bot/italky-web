<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>italkyAI • Seviye Belirleme</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  #pageContent { height: 100%; overflow: hidden; }
  .wrap { height: 100%; padding: 10px 16px 20px; display: flex; flex-direction: column; gap: 12px; }
  .topbar { display: flex; justify-content: space-between; }
  .chip { padding: 8px 12px; border-radius: 99px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-weight: 800; font-size: 11px; color: #a5b4fc; }
  .card { flex: 1; border-radius: 32px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); padding: 24px; display: flex; flex-direction: column; }
  .q-meta { color: #6366f1; font-weight: 900; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }
  .q-text { font-size: 18px; font-weight: 800; color: #fff; margin-bottom: 20px; line-height: 1.3; }
  .opt { width: 100%; padding: 14px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; font-weight: 700; margin-bottom: 10px; text-align: left; cursor: pointer; transition: 0.2s; }
  .opt.sel { background: #6366f1; border: none; }
  .nav { display: flex; gap: 12px; }
  .btn { flex: 1; height: 50px; border-radius: 16px; font-weight: 900; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; }
  .btn.primary { background: #fff; color: #000; border: none; }
</style>
</head>
<body>
<main id="pageContent">
  <div class="wrap">
    <div class="topbar"><div class="chip" id="langChip">Dil: —</div><div class="chip" id="timerChip">40:00</div></div>
    <div class="card" id="qCard"></div>
    <div class="nav"><button class="btn" id="btnPrev">GERİ</button><button class="btn primary" id="btnNext">İLERİ</button></div>
  </div>
</main>
<script type="module">
  import { mountShell } from "/js/ui_shell.js";
  import { bootPage } from "/js/ui_guard.js";
  import { supabase } from "/js/supabase_client.js";

  mountShell({ scroll: "none" });
  bootPage({ protectedPage: true, header: { nameId: "userName", picId: "userPic" } });

  const teacherId = localStorage.getItem("italky_teacher_pref");
  if(!teacherId) location.href = "/pages/teacher_select.html";

  // Soru Bankası (Kısaltılmış örnek, 50 soru yukarıdaki formatta buraya gelecek)
  const QUESTIONS = [{ id:1, level:"A1", weight:1, question:"I ___ a student.", options:["am","is","are","be"], correct:0 }]; 

  let idx = 0;
  const answers = Array(QUESTIONS.length).fill(null);

  function render() {
    const q = QUESTIONS[idx];
    const picked = answers[idx];
    document.getElementById("qCard").innerHTML = `
      <div class="q-meta">Soru ${idx+1} / ${QUESTIONS.length} • ${q.level}</div>
      <div class="q-text">${q.question}</div>
      ${q.options.map((opt, i) => `<button class="opt ${picked===i?'sel':''}" onclick="window.pick(${i})">${opt}</button>`).join("")}
    `;
    document.getElementById("btnPrev").disabled = (idx === 0);
    document.getElementById("btnNext").textContent = (idx === QUESTIONS.length - 1) ? "BİTİR" : "İLERİ";
  }

  window.pick = (i) => { answers[idx] = i; render(); };

  async function finish() {
    let weighted = 0;
    answers.forEach((ans, i) => { if(ans === QUESTIONS[i].correct) weighted += QUESTIONS[i].weight; });
    
    // Basit eşik: weightedToLevel mantığı
    const level = weighted > 3 ? "B1" : "A1"; 
    
    // Supabase ve Yerel Kayıt
    const { data: { user } } = await supabase.auth.getUser();
    if(user) await supabase.from("profiles").update({ [`level_${teacherId}`]: level }).eq("id", user.id);
    
    localStorage.setItem(`italky_level_${teacherId}`, level);
    location.href = "/pages/plan_select.html";
  }

  document.getElementById("btnPrev").onclick = () => { if(idx > 0) { idx--; render(); } };
  document.getElementById("btnNext").onclick = () => { if(idx < QUESTIONS.length-1) { idx++; render(); } else finish(); };
  
  render();
</script>
</body>
</html>
