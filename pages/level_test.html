<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>italkyAI • Seviye Sınavı</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  #pageContent { height: 100%; overflow: hidden; }
  .wrap { height: 100%; padding: 10px 16px 20px; display: flex; flex-direction: column; gap: 12px; }
  .topbar { display: flex; justify-content: space-between; }
  .chip { padding: 8px 12px; border-radius: 99px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-weight: 800; color: #a5b4fc; font-size: 11px; }
  .card { flex: 1; border-radius: 32px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); padding: 24px; display: flex; flex-direction: column; }
  .q-text { font-size: 18px; font-weight: 800; color: #fff; margin: 20px 0; line-height: 1.3; }
  .opt { width: 100%; padding: 14px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; font-weight: 700; margin-bottom: 10px; text-align: left; cursor: pointer; }
  .opt.sel { background: #6366f1; border: none; }
  .nav { display: flex; gap: 12px; }
  .btn { flex: 1; height: 50px; border-radius: 16px; font-weight: 900; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; }
</style>
</head>
<body>
<main id="pageContent">
  <div class="wrap">
    <div class="topbar"><div class="chip" id="langChip">...</div><div class="chip" id="timerChip">40:00</div></div>
    <div class="card" id="qCard"></div>
    <div class="nav"><button class="btn" id="btnPrev">GERİ</button><button class="btn" id="btnNext" style="background:#fff; color:#000;">İLERİ</button></div>
  </div>
</main>
<script type="module">
  import { mountShell } from "/js/ui_shell.js";
  import { bootPage } from "/js/ui_guard.js";
  import { supabase } from "/js/supabase_client.js";

  const ENTRY_FEE = 200; 
  const MIN_TOKEN = 5; 
  const TOTAL_TIME = 40 * 60;

  mountShell({ scroll: "none" });
  bootPage({ protectedPage: true, header: { nameId: "userName", picId: "userPic" } });

  const teacherId = localStorage.getItem("italky_teacher_pref");
  if(!teacherId) location.href = "/pages/teacher_select.html";

  // Soru Bankası (Gerçekçi 50 soru şablonu)
  const QUESTIONS = [ { id:1, level:"A1", weight:1, question:"Choose the correct form: 'She ___ to the store yesterday.'", options:["go","goes","went","gone"], correct:2 } ]; 

  let idx = 0, remaining = TOTAL_TIME, timer;
  const answers = Array(QUESTIONS.length).fill(null);

  async function startExam() {
    const { data: { user } } = await supabase.auth.getUser();
    const { data: profile } = await supabase.from('profiles').select('tokens').eq('id', user.id).single();
    await supabase.from('profiles').update({ tokens: profile.tokens - ENTRY_FEE }).eq('id', user.id); // Peşin ücret çekimi
    
    timer = setInterval(() => {
      remaining--;
      const m = Math.floor(remaining/60), s = remaining%60;
      document.getElementById("timerChip").textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if (remaining <= 0) finish();
    }, 1000);
    render();
  }

  function render() {
    const q = QUESTIONS[idx], picked = answers[idx];
    document.getElementById("qCard").innerHTML = `<div class="q-text">${q.question}</div>${q.options.map((opt, i) => `<button class="opt ${picked===i?'sel':''}" onclick="window.pick(${i})">${opt}</button>`).join("")}`;
    document.getElementById("btnNext").textContent = (idx === QUESTIONS.length - 1) ? "BİTİR" : "İLERİ";
  }

  window.pick = (i) => { answers[idx] = i; render(); };

  async function finish() {
    clearInterval(timer);
    let weighted = 0;
    answers.forEach((ans, i) => { if(ans === QUESTIONS[i].correct) weighted += QUESTIONS[i].weight; });
    const level = weighted > 45 ? "C1" : weighted > 35 ? "B2" : weighted > 25 ? "B1" : weighted > 15 ? "A2" : "A1"; 
    
    const refund = Math.floor(remaining / 60) * MIN_TOKEN; // Akıllı iade

    const { data: { user } } = await supabase.auth.getUser();
    const { data: profile } = await supabase.from('profiles').select('tokens').eq('id', user.id).single();
    await supabase.from("profiles").update({ [`level_${teacherId}`]: level, tokens: profile.tokens + refund }).eq("id", user.id);
    
    localStorage.setItem(`italky_level_${teacherId}`, level);
    alert(`Seviyeniz: ${level}\nİade: ${refund} Token`);
    location.href = "/pages/plan_select.html";
  }

  document.getElementById("btnNext").onclick = () => { if(idx < QUESTIONS.length-1) { idx++; render(); } else finish(); };
  startExam();
</script>
</body>
</html>
