<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ITALKY ‚Ä¢ Audio Spy (Standalone)</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000900; --radar:#00ffcc; --radar-dim:rgba(0,255,204,.15);
  --alert:#ff3300; --ok:#00e676; --text:#e0fffb; --border:rgba(0,255,204,.3); --gold:#ffb800;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Outfit',sans-serif;color:var(--text)}
.bg{position:absolute;inset:-50%;width:200%;height:200%;
  background-image: radial-gradient(var(--border) 1px, transparent 1px);
  background-size:60px 60px; opacity:.1; animation:spin 60s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;border:1px solid var(--border);
  background:rgba(0,15,10,.9);display:flex;flex-direction:column;z-index:5}
@media(min-width:520px){.app{height:92vh;border-radius:24px;margin-top:4vh}}

.header{
  height:70px; padding-top: var(--safe-top);
  display:flex;align-items:center;justify-content:space-between;padding-left:16px;padding-right:16px;
  border-bottom:1px solid var(--border); background: rgba(0,0,0,0.3);
}
.score-box{text-align:left}
.score{font-family:'Share Tech Mono';font-size:20px;color:var(--radar);text-shadow:0 0 10px var(--radar)}
.pb-chip{font-size:10px;color:var(--gold);font-weight:800}
.btn{
  width:38px;height:38px;border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,40,30,.45);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer; transition:.2s;
}
.btn:active{transform:scale(.96); background:rgba(0,255,204,.12)}

.main{flex:1;padding:16px;display:none;flex-direction:column;justify-content:space-between;padding-bottom:calc(16px + var(--safe-bottom))}

.visual{width:160px;height:160px;border:2px solid var(--border);border-radius:50%;margin:5px auto;
  position:relative;background:radial-gradient(circle,rgba(0,255,204,0.1) 0%,transparent 70%);
  box-shadow:0 0 30px var(--radar-dim)}
.scan{position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(from 0deg,transparent 0deg,rgba(0,255,204,0.12) 60deg,var(--radar) 360deg);
  opacity:.15; animation:scan 4s linear infinite}
@keyframes scan{to{transform:rotate(360deg)}}

.wave{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:4px}
.wave.playing .bar{animation:eq .5s infinite ease-in-out alternate;background:var(--radar)}
.bar{width:5px;height:12px;border-radius:3px;background:var(--radar);opacity:.3}
@keyframes eq{to{height:50px;opacity:1;box-shadow:0 0 10px var(--radar)}}

.listen-btn{margin:5px auto 15px;padding:12px 30px;border-radius:30px;border:2px solid var(--radar);
  background:transparent;color:var(--radar);font-family:'Share Tech Mono';font-size:14px;cursor:pointer;transition:0.2s; font-weight: 900;}
.listen-btn:active:not(:disabled){transform:scale(0.95);background:var(--radar-dim)}
.listen-btn:disabled{opacity:.4; border-color: #555; color: #555;}

.opts{display:flex;flex-direction:column;gap:10px}
.opt{padding:15px;border-radius:14px;border:1px solid var(--border);
  background:rgba(0,40,30,.6);cursor:pointer;font-weight:900;transition:0.2s;text-align:center; font-size: 15px;}
.opt:active{transform:scale(.99)}
.opt.correct{border-color:var(--ok);background:rgba(0,230,118,.2);color:var(--ok)}
.opt.wrong{border-color:var(--alert);background:rgba(255,51,0,.2);color:var(--alert)}

.stats-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 0;font-family:'Share Tech Mono';font-size:11px;color:var(--radar)}

.modal{position:absolute;inset:0;background:rgba(0,0,0,0.96);display:flex;align-items:center;justify-content:center;z-index:100}
.card{background:#001510;border:1px solid var(--radar);border-radius:24px;padding:30px;width:88%;text-align:center}
.lang-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:20px 0}
.lang-btn{padding:12px 0;border-radius:10px;border:1px solid var(--radar);color:var(--radar);
  font-family:'Share Tech Mono';font-weight:900;cursor:pointer;background:transparent}
.lang-btn.active{background:var(--radar);color:#000}
.main-btn{width:100%;padding:16px;border:none;border-radius:14px;background:var(--radar);
  color:#000;font-weight:900;margin-top:15px;cursor:pointer}
.secondary-btn{width:100%;padding:14px;border:1px solid var(--radar);border-radius:14px;background:transparent;
  color:var(--radar);font-weight:900;margin-top:10px;cursor:pointer}
.exit-btn { background: #1a1a1a !important; color: #ff3300 !important; border: 1px solid #ff3300 !important; }
.hidden{display:none!important}
</style>
</head>

<body>
<div class="bg"></div>

<div class="app">
  <div class="header">
    <div class="score-box">
      <div class="score" id="scoreDisp">0</div>
      <div class="pb-chip" id="pbDisp">PB: 0</div>
    </div>
    <div class="title" style="font-family: 'Share Tech Mono';">AUDIO_SPY</div>
    <div class="btn" id="soundBtn">üîä</div>
  </div>

  <div class="main" id="gameArea">
    <div class="visual">
      <div class="scan"></div>
      <div class="wave" id="wave">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>

    <button class="listen-btn" id="listenBtn">‚ñ∂ Sƒ∞NYALƒ∞ Dƒ∞NLE</button>

    <div class="opts" id="optionsArea"></div>

    <div class="stats-bar">
      <div id="momDisp" style="color:var(--ok); font-weight:900">x1.00 MOMENTUM</div>
      <div id="livesDisp">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
  </div>
</div>

<div class="modal" id="startModal">
  <div class="card">
    <h2 style="color:var(--radar);font-family:'Share Tech Mono';margin:0">INCOMING SIGNAL</h2>
    <p style="opacity:.7;font-size:13px;margin:10px 0">Sinyali dinle ve doƒüru √ßeviriyi se√ß.</p>
    <div class="lang-grid">
      <button class="lang-btn active" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="de">DE</button>
      <button class="lang-btn" data-lang="fr">FR</button>
      <button class="lang-btn" data-lang="es">ES</button>
      <button class="lang-btn" data-lang="it">IT</button>
    </div>
    <button class="main-btn" id="startBtn">BA≈ûLAT</button>
  </div>
</div>

<div class="modal hidden" id="endModal">
  <div class="card">
    <h2 id="endTitle" style="color:var(--radar);font-family:'Share Tech Mono';margin:0">SIGNAL COMPLETE</h2>
    <p id="endStats" style="margin:16px 0; font-size:15px; line-height:1.6"></p>
    <button class="main-btn" id="continueBtn">DEVAM ET</button>
    <button class="main-btn exit-btn" id="exitBtn">√áIKI≈û</button>
  </div>
</div>

<script>
// --- KONFIGURASYON ---
const LANGPOOL_BASE = "https://dzeemgfwzwkalrvjthps.supabase.co/storage/v1/object/public/lang";
const CACHE_KEY = (l) => `italky_lang_${l}_v1`;

// --- YARDIMCI FONKSIYONLAR ---
const $ = id => document.getElementById(id);
const norm = (s) => String(s||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[.,!?]/g, "");

// --- LANGPOOL MANUEL ENTEGRASYON ---
async function loadLangPool(lang) {
  const L = String(lang || "").trim().toLowerCase();
  
  // 1. √ñnbellek kontrol√º
  try {
    const raw = localStorage.getItem(CACHE_KEY(L));
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed) return sanitize(parsed);
    }
  } catch {}

  // 2. Supabase'den √ßek
  const url = `${LANGPOOL_BASE}/${encodeURIComponent(L)}.json`;
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error("Dosya bulunamadƒ±");
    const data = await r.json();
    
    // 3. √ñnbelleƒüe yaz
    localStorage.setItem(CACHE_KEY(L), JSON.stringify(data));
    return sanitize(data);
  } catch (e) {
    console.error("Havuz y√ºkleme hatasƒ±:", e);
    return { items: [] };
  }
}

function sanitize(data) {
  const items = Array.isArray(data?.items) ? data.items : [];
  const seen = new Set();
  const out = [];
  for (const it of items) {
    const w = String(it?.w || "").trim();
    const tr = String(it?.tr || "").trim();
    if (!w || !tr) continue;
    const k = norm(w);
    if (seen.has(k)) continue;
    seen.add(k);
    out.push({ w, tr, sentence: String(it?.sentence || it?.ex || "").trim() });
  }
  return { items: out };
}

function createUsedSet(storageKey) {
  let used = new Set();
  try {
    const raw = localStorage.getItem(storageKey);
    const arr = JSON.parse(raw) || [];
    used = new Set(arr);
  } catch {}
  
  const save = () => {
    try { localStorage.setItem(storageKey, JSON.stringify([...used])); } catch {}
  };
  return { used, save };
}

function pick(items, count, usedSet, saveFn) {
  if (!items.length) return [];
  // Filtrele: Hen√ºz kullanƒ±lmamƒ±≈ülar
  const fresh = items.filter(x => x.w && !usedSet.has(norm(x.w)));
  
  // Eƒüer taze kelime kalmadƒ±ysa sƒ±fƒ±rla
  if (fresh.length < count) {
    usedSet.clear();
    saveFn();
    // Hepsini taze kabul et
    return items.sort(() => Math.random() - 0.5).slice(0, count);
  }
  
  // Karƒ±≈ütƒ±r ve se√ß
  const chosen = fresh.sort(() => Math.random() - 0.5).slice(0, count);
  chosen.forEach(x => usedSet.add(norm(x.w)));
  saveFn();
  return chosen;
}

// --- OYUN MANTIƒûI ---
let lang = "en";
let muted = false, totalScore = 0, setScore = 0, momentum = 1.0, lives = 3;
let currentItem = null, cooldown = false;
let setCounter = 0, runActive = false;
let poolItems = [];
let speaking = false;
let lastUtter = null;

const LANGMAP = {en:"en-US", de:"de-DE", fr:"fr-FR", es:"es-ES", it:"it-IT"};

function updatePB() {
  const pb = parseInt(localStorage.getItem(`audio_spy_pb_${lang}`) || "0", 10);
  $("pbDisp").textContent = `PB: ${pb}`;
}

function setListenLabel(state){
  const btn = $("listenBtn");
  if(state === "playing"){ btn.textContent="‚è≥ Sƒ∞NYAL √áALIYOR"; btn.disabled=true; }
  else if(state === "wait"){ btn.textContent="‚Ä¶ BEKLE"; btn.disabled=true; }
  else { btn.textContent="‚ñ∂ Sƒ∞NYALƒ∞ Dƒ∞NLE"; btn.disabled=false; }
}

// Dil Se√ßimi
document.querySelectorAll(".lang-btn").forEach(b => {
  b.onclick = () => {
    document.querySelectorAll(".lang-btn").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    lang = b.dataset.lang;
    updatePB();
  };
});

// Ses A√ß/Kapa
$("soundBtn").onclick = () => {
  muted = !muted;
  $("soundBtn").textContent = muted ? "üîá" : "üîä";
  if(muted) stopSpeak();
};

function warmUpTTS(){
  try{
    if(!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(" ");
    u.volume = 0;
    speechSynthesis.speak(u);
  }catch{}
}

// Ba≈ülat Butonu
$("startBtn").onclick = async () => {
  // LOGIN KONTROL√ú ƒ∞PTAL EDƒ∞LDƒ∞ (TEST ƒ∞√áƒ∞N)
  // ensureDailyTokens(); ...
  const btn = $("startBtn");
  btn.disabled = true;
  btn.textContent = "Y√úKLENƒ∞YOR...";

  warmUpTTS();
  
  // Seti ba≈ülat
  if(!runActive) { totalScore = 0; lives = 3; momentum = 1.0; runActive = true; }
  await initSet();
  
  $("startModal").classList.add("hidden");
  $("gameArea").style.display = "flex";
  btn.disabled = false;
  btn.textContent = "BA≈ûLAT";
};

async function initSet(isBank = false) {
  if(isBank) { lives = 3; momentum = 1.0; }
  setCounter = 0; setScore = 0;
  cooldown = false;
  stopSpeak();
  setListenLabel("idle");

  // Havuzu y√ºkle
  let dataObj = await loadLangPool(lang);
  let data = dataObj.items || [];

  if(data.length < 10){
    alert("Dil havuzu y√ºklenemedi veya √ßok az kelime var.");
    location.reload();
    return;
  }

  const USED_KEY = `used_audio_spy_v2_${lang}`;
  const { used, save } = createUsedSet(USED_KEY);

  // 12 kelime se√ß (8 tanesi oyun i√ßin, 4 yedek)
  let picked = pick(data, 12, used, save);
  poolItems = picked || [];

  updateUI();
  nextSignal();
}

function buildOptions(correct) {
  const correctClean = String(correct||"").trim();
  if(!correctClean) return false;

  const opts = [correctClean];
  let tries=0;
  // Rastgele ≈üƒ±klar √ºret (Havuzdan)
  // Not: poolItems sadece 12 tane olduƒüu i√ßin ≈üƒ±klar sƒ±nƒ±rlƒ± kalabilir.
  // Daha iyi ≈üƒ±klar i√ßin t√ºm data'yƒ± kullanmak gerekir ama basitlik i√ßin poolItems kullanƒ±yoruz.
  // Ger√ßek oyun i√ßin loadLangPool'dan gelen full datayƒ± global tutmak iyidir.
  
  while(opts.length < 4 && tries < 50) {
    tries++;
    // Rasgele bir kelime se√ß
    const r = poolItems[Math.floor(Math.random() * poolItems.length)]?.tr;
    const rClean = String(r||"").trim();
    if(rClean && !opts.some(x=>norm(x)===norm(rClean))) opts.push(rClean);
  }

  // Eƒüer yeterli ≈üƒ±k √ßƒ±kmadƒ±ysa doldur
  while(opts.length < 4) {
     opts.push("???"); 
  }

  opts.sort(() => Math.random() - 0.5);

  const area = $("optionsArea");
  area.innerHTML = "";
  opts.forEach(v => {
    const d = document.createElement("div");
    d.className = "opt";
    d.textContent = v;
    d.onclick = () => handleChoice(d, v);
    area.appendChild(d);
  });
  return true;
}

function nextSignal() {
  $("optionsArea").innerHTML = "";

  if(setCounter >= 8 || lives <= 0) {
    finishSet(lives <= 0);
    return;
  }

  const w = poolItems[setCounter];
  // √ñncelik c√ºmlede, yoksa kelimede
  currentItem = {
    say: String(w?.sentence || w?.w || "").trim(),
    ans: String(w?.tr || "").trim()
  };

  if(!currentItem.say || !currentItem.ans){
    setCounter++;
    nextSignal();
    return;
  }

  const ok = buildOptions(currentItem.ans);
  if(!ok){ // ≈ûƒ±k olu≈üturulamazsa ge√ß
    setCounter++;
    nextSignal();
    return;
  }

  setTimeout(() => playSignal(), 350);
}

function lockOptions(lock=true){
  document.querySelectorAll(".opt").forEach(x => x.style.pointerEvents = lock ? "none" : "auto");
}

function playSignal() {
  if(speaking || cooldown || !currentItem) return;
  setListenLabel("playing");
  $("wave").classList.add("playing");
  speak(currentItem.say, () => {
    $("wave").classList.remove("playing");
    setListenLabel("idle");
  });
}

function handleChoice(el, val) {
  if(cooldown || !currentItem) return;
  cooldown = true;
  lockOptions(true);
  setListenLabel("wait");

  const isCorrect = norm(val) === norm(currentItem.ans);

  if(isCorrect) {
    el.classList.add("correct");
    const gain = Math.round(100 * momentum);
    totalScore += gain; setScore += gain;
    momentum = Math.min(1.6, momentum + 0.05);

    $("wave").classList.add("playing");
    speak(currentItem.say, () => { // Tekrar okur
      $("wave").classList.remove("playing");
      resetSignal();
      nextSignal();
    });
  } else {
    el.classList.add("wrong");
    lives--;
    momentum = Math.max(1.0, momentum - 0.2);

    // Doƒüruyu g√∂ster
    document.querySelectorAll(".opt").forEach(x => {
      if(norm(x.textContent) === norm(currentItem.ans)) x.classList.add("correct");
    });

    $("wave").classList.add("playing");
    speak(currentItem.say, () => { // Tekrar okur
      $("wave").classList.remove("playing");
      resetSignal();
      (lives > 0) ? nextSignal() : finishSet(true);
    });
  }
  updateUI();
}

function resetSignal() {
  cooldown = false;
  setCounter++;
  lockOptions(false);
  setListenLabel("idle");
  currentItem = null;
}

function updateUI() {
  $("scoreDisp").textContent = totalScore;
  $("momDisp").textContent = `x${momentum.toFixed(2)} MOMENTUM`;
  $("livesDisp").textContent = "‚ù§Ô∏è".repeat(Math.max(0, lives)) + "üíÄ".repeat(3 - Math.max(0, lives));
}

function finishSet(died) {
  stopSpeak();
  setListenLabel("idle");

  const pb = parseInt(localStorage.getItem(`audio_spy_pb_${lang}`) || "0", 10);
  if(totalScore > pb) localStorage.setItem(`audio_spy_pb_${lang}`, totalScore);
  updatePB();

  const title = died ? "Oyun Bitti" : "Seviye Tamam";
  const stats = `TOPLAM SKOR: <b>${totalScore}</b><br>MOMENTUM: <b>x${momentum.toFixed(2)}</b>`;

  $("endModal").classList.remove("hidden");
  $("endTitle").textContent = title;
  $("endStats").innerHTML = stats;
  
  // Bank button behavior replacement
  $("bankBtn").onclick = () => {
      // Basit√ße yeni set ba≈ülat, hak yedeklemeyi sim√ºle et
      $("endModal").classList.add("hidden");
      initSet(true); 
  };
  
  $("continueBtn").onclick = () => {
      $("endModal").classList.add("hidden");
      initSet(false);
  };
  
  $("exitBtn").onclick = () => location.reload();
}

function stopSpeak(){
  speaking = false;
  try { speechSynthesis.cancel(); } catch {}
  lastUtter = null;
}

function speak(txt, onDone) {
  if(muted || !txt) { onDone && onDone(); return; }
  stopSpeak();

  const u = new SpeechSynthesisUtterance(txt);
  lastUtter = u;
  u.lang = LANGMAP[lang] || "en-US";
  u.rate = 0.85; // Biraz yava≈ü okusun, daha anla≈üƒ±lƒ±r olsun
  speaking = true;

  const finish = () => {
    if(lastUtter !== u) return;
    speaking = false;
    onDone && onDone();
  };

  u.onend = finish;
  u.onerror = finish;

  try { speechSynthesis.speak(u); }
  catch { finish(); }
}

window.addEventListener('load', () => {
  updatePB();
  setListenLabel("idle");
});
</script>
</body>
</html>
