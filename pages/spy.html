<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY ‚Ä¢ Audio Spy ‚Äî Final</title>
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000900; --radar:#00ffcc; --radar-dim:rgba(0,255,204,.15);
  --alert:#ff3300; --ok:#00e676; --text:#e0fffb; --border:rgba(0,255,204,.3);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:Outfit,sans-serif;color:var(--text)}
.bg{position:absolute;inset:-50%;width:200%;height:200%;
  background-image:
    radial-gradient(var(--border) 1px, transparent 1px),
    radial-gradient(var(--border) 1px, transparent 1px);
  background-size:60px 60px; background-position:0 0,30px 30px;
  opacity:.1; animation:spin 60s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;border:1px solid var(--border);
  background:rgba(0,15,10,.9);display:flex;flex-direction:column}
@media(min-width:520px){.app{height:92vh;border-radius:20px}}

.header{height:70px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--border)}
.btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--radar-dim);
  color:var(--radar);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-family:Share Tech Mono;font-size:20px;letter-spacing:2px;color:var(--radar)}
.badge{font-size:10px;padding:2px 6px;background:var(--radar);color:#000;border-radius:2px;margin-left:8px}

.main{flex:1;padding:16px;display:none;flex-direction:column;justify-content:space-between}

.visual{width:200px;height:200px;border:2px solid var(--border);border-radius:50%;margin:10px auto 0;
  position:relative;background:radial-gradient(circle,rgba(0,255,204,.1) 0%,transparent 70%);
  box-shadow:0 0 30px var(--radar-dim)}
.scan{position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(from 0deg,transparent 0deg,rgba(0,255,204,.12) 60deg,var(--radar) 360deg);
  opacity:.12; animation:scan 4s linear infinite}
@keyframes scan{to{transform:rotate(360deg)}}

.wave{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:4px}
.wave.playing .bar{animation:eq .5s infinite ease-in-out alternate;background:var(--radar)}
.bar{width:6px;height:10px;border-radius:3px;background:var(--radar);opacity:.5}
.bar:nth-child(1){animation-delay:.1s}.bar:nth-child(2){animation-delay:.3s}
.bar:nth-child(3){animation-delay:.0s}.bar:nth-child(4){animation-delay:.4s}
.bar:nth-child(5){animation-delay:.2s}
@keyframes eq{to{height:50px;opacity:1;box-shadow:0 0 10px var(--radar)}}

.listen{margin:-20px auto 10px;padding:12px 30px;border-radius:30px;border:2px solid var(--radar);
  background:var(--bg);color:var(--radar);font-family:Share Tech Mono;font-size:16px;cursor:pointer}

.opts{display:flex;flex-direction:column;gap:12px}
.opt{padding:16px;border-radius:12px;border:1px solid var(--border);
  background:rgba(0,40,30,.6);cursor:pointer}
.opt.correct{border-color:var(--ok);background:rgba(0,230,118,.2);color:var(--ok)}
.opt.wrong{border-color:var(--alert);background:rgba(255,51,0,.2);color:var(--alert)}

.stats{display:flex;justify-content:space-between;font-family:Share Tech Mono;font-size:12px;color:var(--radar)}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:50}
.card{background:#001510;border:1px solid var(--radar);border-radius:16px;padding:26px;width:85%;text-align:center}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:16px}
.lang{padding:10px;border-radius:6px;border:1px solid var(--radar);color:var(--radar);
  font-family:Share Tech Mono;font-weight:900;cursor:pointer}
.lang.active{background:var(--radar);color:#000}
.primary{width:100%;padding:14px;border:none;border-radius:10px;background:var(--radar);
  color:#000;font-weight:900;margin-top:16px}
.secondary{width:100%;padding:14px;border:1px solid var(--radar);border-radius:10px;background:transparent;
  color:var(--radar);font-weight:900;margin-top:10px}

.hidden{display:none!important}
</style>
</head>

<body>
<div class="bg"></div>

<div class="app">
  <div class="header">
    <div class="btn" onclick="location.href='/pages/game.html'">‚Üê</div>
    <div class="title">AUDIO_SPY <span id="langBadge" class="badge">EN</span></div>
    <div class="btn" id="soundBtn">üîä</div>
  </div>

  <div class="main" id="game">
    <div class="visual">
      <div class="scan"></div>
      <div class="wave" id="wave">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>

    <button class="listen" id="listenBtn">‚ñ∂ Sƒ∞NYALƒ∞ Dƒ∞NLE</button>

    <div class="opts" id="opts"></div>

    <div class="stats">
      <span>SIGNAL: <b id="score">0</b>%</span>
      <span>LIVES: <b id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</b></span>
    </div>
  </div>
</div>

<div class="modal" id="start">
  <div class="card">
    <h2 style="color:var(--radar);font-family:Share Tech Mono;margin:0">INCOMING SIGNAL</h2>
    <p style="opacity:.7;font-size:13px">Sinyali dinle ve doƒüru anlamƒ± se√ß.</p>
    <div class="langs" id="langs">
      <div class="lang active" data-lang="en">EN</div>
      <div class="lang" data-lang="de">DE</div>
      <div class="lang" data-lang="fr">FR</div>
      <div class="lang" data-lang="es">ES</div>
      <div class="lang" data-lang="it">IT</div>
    </div>
    <button class="primary" id="startBtn">BA≈ûLA</button>
  </div>
</div>

<div class="modal hidden" id="end">
  <div class="card">
    <h2 style="color:var(--alert);font-family:Share Tech Mono;margin:0">SIGNAL LOST</h2>
    <p id="endTxt" style="margin:14px 0"></p>
    <button class="primary" onclick="restart()">RECONNECT</button>
    <button class="secondary" onclick="location.href='/pages/game.html'">ABORT</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $=id=>document.getElementById(id);

let lang="en";
let muted=false;
let score=0,lives=3;
let current=null;
let playing=false;
let cooldown=false;

const LANGMAP={en:"en-US",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT"};

document.querySelectorAll(".lang").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang=b.dataset.lang;
    $("langBadge").textContent=lang.toUpperCase();
  };
});

$("soundBtn").onclick=()=>{
  muted=!muted;
  $("soundBtn").textContent=muted?"üîá":"üîä";
};

$("startBtn").onclick=async()=>{
  $("start").classList.add("hidden");
  $("game").style.display="flex";
  score=0;lives=3;
  updateUI();
  await next();
};

$("listenBtn").onclick=play;

async function next(){
  if(lives<=0){finish();return;}
  const pool=await loadLangPool(lang);
  const {used,save}=createUsedSet("audio_spy_"+lang);
  const picked=pick(pool,1,used,save);
  const w=picked[0];
  current={ say: (w.sentence || `Please listen: ${w.w}.`), ans:w.tr, w:w.w };
  buildOptions(pool.items.map(x=>x.tr), current.ans);
  setTimeout(play,500);
}

function buildOptions(all,correct){
  const opts=[correct];
  while(opts.length<4){
    const r=all[Math.floor(Math.random()*all.length)];
    if(r && !opts.includes(r)) opts.push(r);
  }
  opts.sort(()=>Math.random()-.5);
  const o=$("opts"); o.innerHTML="";
  opts.forEach(v=>{
    const d=document.createElement("div");
    d.className="opt";
    d.textContent=v;
    d.onclick=()=>choose(d,v);
    o.appendChild(d);
  });
}

function play(){
  if(playing||cooldown||!current) return;
  speak(current.say);
  playing=true;
  $("wave").classList.add("playing");
  setTimeout(()=>{
    playing=false;
    $("wave").classList.remove("playing");
  },2200);
}

function choose(el,val){
  if(cooldown) return;
  cooldown=true;
  document.querySelectorAll(".opt").forEach(x=>x.style.pointerEvents="none");
  if(val===current.ans){
    el.classList.add("correct");
    score=Math.min(100,score+10);
    setTimeout(()=>{ updateUI(); resetOpts(); next(); },900);
  }else{
    el.classList.add("wrong");
    lives--;
    document.querySelectorAll(".opt").forEach(x=>{
      if(x.textContent===current.ans) x.classList.add("correct");
    });
    setTimeout(()=>{ updateUI(); resetOpts(); lives>0?next():finish(); },1200);
  }
}

function resetOpts(){
  cooldown=false;
  document.querySelectorAll(".opt").forEach(x=>x.style.pointerEvents="auto");
}

function updateUI(){
  $("score").textContent=score;
  $("lives").textContent="‚ù§Ô∏è".repeat(lives)+"üíÄ".repeat(3-lives);
}

function finish(){
  $("end").classList.remove("hidden");
  $("endTxt").innerHTML=`Baƒülantƒ± Ba≈üarƒ±sƒ±: <b style="color:var(--radar)">%${score}</b><br><br>
  Son Sinyal:<br><i>${current?.say||""}</i><br><b>${current?.ans||""}</b>`;
  speak(current?.say||"");
}

function restart(){
  $("end").classList.add("hidden");
  $("game").style.display="flex";
  score=0;lives=3;
  updateUI();
  next();
}

function speak(txt){
  if(muted||!txt) return;
  const u=new SpeechSynthesisUtterance(txt);
  u.lang=LANGMAP[lang]||"en-US";
  u.rate=.95;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
</script>
</body>
</html>
