<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Sentence Master 3D</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-deep:#020205; --c-neon-pink:#ff00ff; --c-neon-blue:#00f3ff;
      --c-neon-green:#00e676; --c-error:#ff1744; --border: rgba(255,255,255,.15);
      --shadow-3d: 0 4px 0 rgba(255,255,255,0.15);
    }
    
    /* --- SCROLLBAR Gƒ∞ZLEME (Global) --- */
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; scrollbar-width: none; /* Firefox */ }
    *::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

    html,body{ margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; perspective: 1000px; }
    
    /* --- 3D & BACKGROUND FX --- */
    .cosmos-bg{ position:absolute; inset:0; z-index:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); overflow: hidden;}
    
    /* Y√ºzen 3D Objeler */
    .floating-shape {
        position: absolute;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--c-neon-blue), transparent);
        opacity: 0.15;
        filter: blur(20px);
        animation: floatAnim 10s infinite ease-in-out alternate;
        z-index: 0;
    }
    .shape-1 { width: 150px; height: 150px; top: 10%; left: -50px; background: var(--c-neon-pink); animation-duration: 12s; }
    .shape-2 { width: 200px; height: 200px; bottom: 20%; right: -60px; background: var(--c-neon-green); animation-duration: 15s; }
    .shape-3 { width: 80px; height: 80px; top: 40%; right: 20%; background: var(--c-neon-blue); animation-duration: 8s; }

    @keyframes floatAnim {
        0% { transform: translateY(0) rotate(0deg) scale(1); }
        100% { transform: translateY(-30px) rotate(10deg) scale(1.1); }
    }

    .wrap{ width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }

    /* --- NAV BAR --- */
    .nav-top{ display:flex; align-items:center; justify-content:space-between; padding: 15px 18px; }
    
    .status-chip { 
        background: rgba(255,255,255,0.08); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; 
        border: 1px solid var(--border); letter-spacing: 1px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px);
    }
    .pb-chip { font-size: 10px; color: var(--c-neon-pink); font-weight: 800; text-align: right; margin-top: 4px; text-shadow: 0 0 5px var(--c-neon-pink); }
    
    /* 3D Rozetler */
    .mini-badge{ 
        display:flex; align-items:center; height: 42px; padding: 0 14px; border-radius: 16px; 
        background: rgba(255,255,255,.05); border: 1px solid var(--border); font-weight: 800; font-size: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s;
    }
    .mini-badge:hover { transform: translateY(-2px); }
    
    /* ƒ∞kon Animasyonlarƒ± */
    .anim-pulse { animation: pulse 1.5s infinite; display: inline-block; }
    .anim-float { animation: floatIcon 3s ease-in-out infinite; display: inline-block; }
    .anim-spin { animation: spinIcon 5s linear infinite; display: inline-block; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    @keyframes spinIcon { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

    /* --- STREAK --- */
    @keyframes streakPop { 0% { transform:scale(1); } 50% { transform:scale(1.2) rotate(-3deg); color:var(--c-neon-pink); text-shadow: 0 0 15px var(--c-neon-pink); } 100% { transform:scale(1); } }
    .streak-pop{ animation: streakPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .streak-wrap{ text-align:center; margin-bottom:10px; opacity:0; transition:0.3s; font-weight:900; font-size: 14px; letter-spacing: 1px; }
    .streak-active{ opacity:1; }

    /* --- GAME CARD (3D Effect) --- */
    .game-card{ 
        background: rgba(20, 20, 30, 0.4); border: 1px solid var(--border); border-radius: 32px; 
        backdrop-filter: blur(25px); padding: 25px 20px; margin: 0 14px; position:relative; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.05); 
        transform-style: preserve-3d;
    }
    
    .sentence-text{ font-size: 20px; font-weight: 800; line-height: 1.4; text-align: center; margin-bottom: 15px; text-transform: uppercase; min-height: 60px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .translation-text{ font-size: 15px; color: var(--c-neon-green); font-style: italic; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-bottom: 10px; font-weight: 500; }

    .word-box{ display:flex; flex-wrap:wrap; justify-content:center; gap: 8px; margin: 20px 0; min-height: 45px;}
    .letter-slot{ 
        width: 32px; height: 42px; border-bottom: 3px solid var(--c-neon-blue); display:flex; align-items:center; justify-content:center; 
        font-size: 24px; font-weight: 900; color: var(--c-neon-blue); transition: 0.2s;
    }
    .letter-slot.filled{ 
        border-bottom: none; color: #fff; background: rgba(0, 243, 255, 0.1); border-radius: 8px;
        text-shadow: 0 0 10px var(--c-neon-blue); box-shadow: 0 0 15px rgba(0,243,255,0.2); animation: popIn 0.2s;
    }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* --- 3D KEYBOARD --- */
    .keyboard{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; perspective: 500px; }
    .key-btn{ 
        aspect-ratio:1; display:flex; align-items:center; justify-content:center; 
        background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); 
        border: 1px solid rgba(255,255,255,0.2); border-bottom: 4px solid rgba(0,0,0,0.5); /* 3D Depth */
        border-radius: 12px; color: #fff; font-weight: 800; cursor:pointer; font-size: 16px; 
        transition: all 0.1s; position: relative; top: 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .key-btn:active { top: 3px; border-bottom-width: 1px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    
    .key-btn.correct{ 
        background: var(--c-neon-green) !important; color:#000; border-color: #00b359; border-bottom-width: 4px;
        box-shadow: 0 0 20px var(--c-neon-green); 
    }
    .key-btn.wrong{ 
        background: var(--c-error) !important; color:#fff; border-color: #b3002d; opacity: 0.4; 
        transform: scale(0.9); pointer-events: none; border-bottom-width: 1px; top: 3px;
    }

    /* --- MODALS --- */
    .modal-wrap{ position:absolute; inset:0; background: rgba(0,0,0,.85); backdrop-filter: blur(20px); z-index:1000; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal-card{ 
        width:100%; max-width:360px; background: linear-gradient(160deg, #101018, #050508); 
        border: 1px solid var(--border); border-radius: 40px; padding: 35px 25px; text-align:center; 
        overflow-y:auto; max-height:90vh; box-shadow: 0 20px 80px rgba(0,0,0,0.8);
        animation: slideUp 0.4s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .record-item { display: flex; justify-content: space-between; align-items:center; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 8px; font-size: 12px; border-left: 4px solid #444; transition: 0.2s; }
    .record-item:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
    .record-item.rank-0 { border-left-color: var(--c-neon-pink); background: linear-gradient(90deg, rgba(255,0,255,0.1), transparent); }

    /* --- BUTTONS --- */
    .btn-main{ 
        width:100%; padding: 18px; background: var(--c-neon-green); color:#000; border:none; 
        border-radius: 20px; font-weight: 900; cursor:pointer; margin-top: 12px; font-size: 16px;
        box-shadow: 0 8px 25px rgba(0, 230, 118, 0.4); transition: 0.2s; position: relative; top: 0;
    }
    .btn-main:active { top: 2px; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4); transform: scale(0.98); }

    .lvl-btn { 
        width:100%; display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; 
        border-radius: 22px; border: 1px solid rgba(255,255,255,0.1); background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent); 
        color: #fff; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.2s;
    }
    .lvl-btn:hover { border-color: var(--c-neon-blue); background: rgba(0,243,255,0.05); transform: translateX(5px); }

    .lang-btn{ font-size: 28px; padding: 12px; border-radius: 18px; background: rgba(255,255,255,0.05); border: 2px solid transparent; cursor:pointer; margin: 4px; transition: 0.2s; }
    .lang-btn.active{ border-color: var(--c-neon-blue); background: rgba(0,243,255,0.15); box-shadow: 0 0 20px rgba(0,243,255,0.3); transform: scale(1.1); }
    
    #resInfo { font-size: 13px; color: var(--c-neon-blue); text-align: center; min-height: 20px; margin-bottom: 10px; font-weight: 800; opacity: 0; transition: 0.3s; text-shadow: 0 0 10px rgba(0,243,255,0.5); }
    .back-btn{ color:#fff; text-decoration:none; font-weight:900; font-size:24px; opacity:.8; transition: 0.2s; }
    .back-btn:hover { opacity: 1; transform: translateX(-3px); }
  </style>
</head>
<body>
  <div class="cosmos-bg">
      <div class="floating-shape shape-1"></div>
      <div class="floating-shape shape-2"></div>
      <div class="floating-shape shape-3"></div>
  </div>

  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">‚Üê</a>
      <div style="text-align: center;">
        <div id="statusChip" class="status-chip">EN ‚Ä¢ LEVEL</div>
        <div id="pbDisplay" class="pb-chip">PB: 0</div>
      </div>
      <div style="display:flex; gap:8px;">
        <div class="mini-badge" id="lifeDisplay" style="color:var(--c-neon-pink); border-color: rgba(255,0,255,0.3);">
            <span class="anim-pulse">‚ù§Ô∏è</span><span style="margin-left:4px">3</span>
        </div>
        <div class="mini-badge" id="shieldBadge" style="color:var(--c-neon-blue); display:none; border-color: rgba(0,243,255,0.3);">
            <span class="anim-float">üõ°Ô∏è</span>
        </div>
        <div class="mini-badge" id="scoreBadge" style="border-color: rgba(255,215,0,0.3); color: var(--gold);">
            <span class="anim-float">üèÜ</span> <span id="scoreDisplay" style="margin-left:5px">0</span>
        </div>
      </div>
    </div>
    
    <div id="streakWrap" class="streak-wrap" style="color:var(--c-neon-pink); text-shadow:0 0 10px var(--c-neon-pink);">
        üî• STREAK: <span id="streakCount">0</span>
    </div>

    <div class="game-card">
      <div id="resInfo"></div>
      <div id="sentenceDisplay" class="sentence-text"></div>
      <div id="translationDisplay" class="translation-text"></div>
      <div id="wordBox" class="word-box"></div>
      
      <div class="keyboard" id="keyboard"></div>
      
      <button class="btn-main" style="background:linear-gradient(135deg,#6366f1,#818cf8); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4); color:#fff; margin-top:20px; padding: 16px;" id="jokerBtn">
          ‚ö° JOKER KULLAN (<span id="jokerCount">2</span>)
      </button>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin:0 0 5px; font-size: 28px; background: -webkit-linear-gradient(0deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SENTENCE MASTER</h2>
      <div style="font-size: 12px; color: var(--c-neon-blue); margin-bottom: 25px; opacity: 0.8; font-weight: 700;">ELITE EDITION</div>
      
      <div style="margin-bottom:25px;">
        <button data-lang="en" class="lang-btn active">üá¨üáß</button>
        <button data-lang="de" class="lang-btn">üá©üá™</button>
        <button data-lang="fr" class="lang-btn">üá´üá∑</button>
        <button data-lang="es" class="lang-btn">üá™üá∏</button>
        <button data-lang="it" class="lang-btn">üáÆüáπ</button>
      </div>

      <button class="lvl-btn" data-lvl="A2" style="border-left: 4px solid var(--c-neon-green)"><span>üü¢ KOLAY (A2)</span> <span id="pb-A2" style="opacity:0.6">PB: 0</span></button>
      <button class="lvl-btn" data-lvl="B1" style="border-left: 4px solid var(--c-neon-blue)"><span>üîµ ORTA (B1)</span> <span id="pb-B1" style="opacity:0.6">PB: 0</span></button>
      <button class="lvl-btn" data-lvl="B2" style="border-left: 4px solid var(--c-neon-pink)"><span>üü£ ZOR (B2)</span> <span id="pb-B2" style="opacity:0.6">PB: 0</span></button>

      <h3 style="margin:30px 0 15px; font-size:13px; color:var(--c-neon-pink); letter-spacing: 1px;">üèÜ EN ƒ∞Yƒ∞ SKORLAR</h3>
      <div id="leaderboardBox" style="max-height: 150px; overflow-y: auto; padding-right: 5px;"></div>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <div style="font-size: 60px; margin-bottom: 10px;">üëë</div>
      <h2 id="endTitle" style="color: var(--c-neon-green); text-shadow: 0 0 20px rgba(0,230,118,0.4);">SET TAMAMLANDI</h2>
      <div id="endStats" style="text-align:center; margin:25px 0; font-size:16px; line-height:2; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px;"></div>
      
      <button class="btn-main" id="btnContinue">DEVAM ET (üõ°Ô∏è KALKAN)</button>
      <button class="btn-main" id="btnBank" style="background:var(--c-neon-blue); box-shadow: 0 8px 25px rgba(0,243,255,0.4);">BANKALA (+%5 PUAN)</button>
      <button class="btn-main" id="btnFinish" style="background:transparent; color:#fff; border:2px solid rgba(255,255,255,0.2); box-shadow: none;">KAYDET VE √áIK</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);
let currentLang = "en", currentDiff = "A2", wordList = [], currentIndex = 0;
let mistakes = 0, maxMistakes = 8, lives = 3, maxLives = 3, currentWord = "", currentRaw = "", currentSentence = "", discovered = [], jokers = 2, totalScore = 0, setScore = 0;
let streak = 0, maxStreak = 0, roundStartTime = 0, perfectCount = 0, lastSpoken = 0, runActive = false, shield = false, usedJokerInRound = false;

const LOCALE_MAP = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };

function escapeRegExp(s){ return String(s ?? "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function shuffle(a) {
  const arr = [...a];
  for(let i=arr.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* =========================
   GAMEKIT MIN (ONLY GATING)
   ========================= */
const DAILY_FREE_TOKENS = 25;

function isoDateLocal(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function getUser(){ try{ return JSON.parse(localStorage.getItem("italky_user_v1")||"{}"); }catch{ return {}; } }
function isPro(u){
  const p = String(u?.plan||"").toUpperCase().trim();
  return p==="PRO" || p==="PREMIUM" || p==="PLUS";
}
function uid(u){ return String(u.user_id||u.id||u.email||"guest").toLowerCase().trim(); }
function tokenKey(u){ return `italky_game_tokens::${uid(u)}::${isoDateLocal()}`; }
function tokenInitKey(u){ return `italky_game_tokens_init::${uid(u)}::${isoDateLocal()}`; }

function ensureDailyTokens(){
  const u=getUser();
  if(isPro(u)) return;
  if(localStorage.getItem(tokenInitKey(u))) return;
  localStorage.setItem(tokenKey(u), String(DAILY_FREE_TOKENS));
  localStorage.setItem(tokenInitKey(u), "1");
}
function getTokens(){
  const u=getUser();
  if(isPro(u)) return 9999;
  const v = Number(localStorage.getItem(tokenKey(u))||"0");
  return Number.isFinite(v) ? Math.max(0,v) : 0;
}
function spendToken(){
  const u=getUser();
  if(isPro(u)) return true;
  const t=getTokens();
  if(t<=0) return false;
  localStorage.setItem(tokenKey(u), String(t-1));
  return true;
}
/* ========================= */

function updateLeaderboardUI() {
  const records = JSON.parse(localStorage.getItem('italky_sentence_hof_v62') || '[]');
  const badges = ["üëë", "ü•à", "ü•â"];

  $('leaderboardBox').innerHTML = records.map((r, i) => `
    <div class="record-item rank-${i < 3 ? i : 'rest'}">
      <span>${i < 3 ? badges[i] : i+1 + '.'} <b>${r.score}</b> <small style="color:#888">${r.lang}-${r.lvl}</small></span>
      <span style="color:var(--c-neon-pink); font-weight:800;">üî•${r.streak}</span>
    </div>
  `).join('') || '<div style="font-size:12px; opacity:0.5; padding:10px;">Hen√ºz rekor yok.</div>';

  ['A2', 'B1', 'B2'].forEach(lvl => {
    const local = records.filter(r => r.lang === currentLang.toUpperCase() && r.lvl === lvl);
    const top = local.length > 0 ? Math.max(...local.map(r => r.score)) : 0;
    $(`pb-${lvl}`).textContent = `PB: ${top}`;
    if (lvl === currentDiff) $('pbDisplay').textContent = `PB (${currentLang.toUpperCase()}-${lvl}): ${top}`;
  });
}

function speak(text) {
  const now = Date.now();
  if (now - lastSpoken < 250) return;
  lastSpoken = now;
  window.speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = LOCALE_MAP[currentLang] || 'en-US';
  msg.rate = 0.85;
  window.speechSynthesis.speak(msg);
}

async function initGame(diff, isBank = false) {
  try {
    currentDiff = diff;
    updateLeaderboardUI();

    const pool = await loadLangPool(currentLang);
    if (!pool || !Array.isArray(pool.items)) throw new Error("Pool error");

    const randomizedItems = shuffle([...pool.items]);
    const { used, save } = createUsedSet(`used_sentence_v62_${currentLang}_${currentDiff}`);

    if (!runActive || isBank) {
      const cfg = { A2: { l:4, j:2, m:8 }, B1: { l:3, j:2, m:7 }, B2: { l:3, j:1, m:6 } }[currentDiff];
      maxLives = cfg.l; lives = maxLives;
      jokers = isBank ? jokers : cfg.j;
      maxMistakes = cfg.m;
      runActive = true;
    }

    const setSize = currentDiff === "A2" ? 10 : 12;

    wordList = pick({ items: randomizedItems }, setSize, used, save, (it) => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const target = currentDiff.toUpperCase();
      const lvlMatch = (target === "A2") ? ["A1","A2"].includes(itLvl) : (itLvl === target);
      return lvlMatch && it.sentence && it.w && !it.w.trim().includes(" ");
    });

    try { save(wordList.map(x => x.w)); } catch(e) {}

    if(!wordList.length) {
        alert("Havuz t√ºkendi! Liste sƒ±fƒ±rlanƒ±yor.");
        localStorage.removeItem(`used_sentence_v62_${currentLang}_${currentDiff}`);
        location.reload(); return;
    }

    $("startModal").style.display = "none";
    $("endModal").style.display = "none";
    $("btnContinue").disabled = false; $("btnBank").disabled = false;
    currentIndex = 0; setScore = 0;
    startRound();
  } catch (e) { alert("Sistem hatasƒ±! L√ºtfen sayfayƒ± yenileyin."); }
}

function startRound() {
  if (currentIndex >= wordList.length || lives <= 0) { finishSet(); return; }

  const data = wordList[currentIndex];
  currentRaw = String(data.w || "").trim();
  currentSentence = String(data.sentence || "");

  const loc = LOCALE_MAP[currentLang] || 'en-US';
  currentWord = currentRaw.toLocaleUpperCase(loc).normalize("NFC").replace(/[^A-Z√áƒûƒ∞√ñ≈û√ú√Ä-√ø-]/gu, "");

  mistakes = 0;
  usedJokerInRound = false;
  discovered = new Array(currentWord.length).fill(false);
  roundStartTime = Date.now();

  const escaped = escapeRegExp(currentRaw);
  const regex = new RegExp(`(^|[^\\p{L}'-])(${escaped})(?=[^\\p{L}'-]|$)`, "giu");
  const masked = currentSentence.replace(regex, `$1____`);

  $("sentenceDisplay").textContent = masked.toUpperCase();
  $("translationDisplay").textContent = data.tr || "";
  $("resInfo").style.opacity = "0";

  if (shield) {
    $("resInfo").textContent = `üõ°Ô∏è KALKAN AKTƒ∞F!`;
    $("resInfo").style.opacity = "1";
  }

  renderWord();
  renderDynamicKeyboard();
  updateUI();
}

function renderWord() {
  const box = $("wordBox"); box.innerHTML = "";
  currentWord.split("").forEach((ch, i) => {
    const d = document.createElement("div");
    d.className = `letter-slot ${discovered[i] ? "filled" : ""}`;
    d.textContent = discovered[i] ? ch : "";
    box.appendChild(d);
  });
}

function renderDynamicKeyboard() {
  const kb = $("keyboard"); kb.innerHTML = "";
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZABC√áDEFGƒûHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ√Ä√à√â√å√ç√í√ì√ô√ö";
  const wordChars = [...new Set(currentWord.split("").filter(Boolean))];
  const wrongChars = alphabet.split("").filter(c => !wordChars.includes(c)).sort(() => Math.random() - 0.5).slice(0, 12);
  const finalKeys = [...wordChars, ...wrongChars].sort((a,b)=>a.localeCompare(b, currentLang));

  finalKeys.forEach(char => {
    const b = document.createElement("button");
    b.className = "key-btn";
    b.textContent = char;
    b.onclick = () => handleGuess(char, b);
    kb.appendChild(b);
  });
}

function handleGuess(char, btn) {
  if (!btn || btn.disabled) return;
  btn.disabled = true;

  if (currentWord.includes(char)) {
    btn.classList.add("correct");
    currentWord.split("").forEach((c, i) => { if (c === char) discovered[i] = true; });
    renderWord();
    if (discovered.every(v => v)) {
      calculatePuan();
      shield = false;
      $("resInfo").innerHTML = `‚úÖ <span style="color:var(--c-neon-green)">${currentRaw.toUpperCase()}</span>`;
      $("resInfo").style.opacity = "1";
      speak(currentSentence);
      setTimeout(() => { currentIndex++; startRound(); }, 1200);
    }
  } else {
    if (shield) {
      shield = false;
      btn.style.opacity = "0.4";
      btn.style.borderColor = "var(--c-neon-blue)";
      $("resInfo").textContent = `üõ°Ô∏è KALKAN KULLANILDI!`;
      $("resInfo").style.opacity = "1";
      updateUI();
      return;
    }

    btn.classList.add("wrong");
    mistakes++;
    streak = 0;
    updateUI();

    if (mistakes >= maxMistakes) {
      lives--;
      const penalty = { A2: 5, B1: 8, B2: 12 }[currentDiff];
      totalScore = Math.max(0, totalScore - penalty);
      speak(currentSentence);
      if (lives <= 0) finishSet();
      else { currentIndex++; setTimeout(() => startRound(), 1500); }
    } else {
      $("resInfo").textContent = `HATA: ${mistakes}/${maxMistakes}`;
      $("resInfo").style.opacity = "1";
    }
  }
}

function calculatePuan() {
  streak++;
  maxStreak = Math.max(maxStreak, streak);
  const multiplier = Math.min(streak <= 3 ? streak : (3 + (streak - 3) * 0.25), 6);
  const base = (maxMistakes - mistakes) * 10;
  const timeUsed = (Date.now() - roundStartTime) / 1000;

  let speedBonus = !usedJokerInRound ? (timeUsed < 6 ? 10 : (timeUsed < 10 ? 5 : 0)) : 0;
  let perfectBonus = (!usedJokerInRound && mistakes === 0) ? { A2:15, B1:20, B2:25 }[currentDiff] : 0;

  if (mistakes === 0 && !usedJokerInRound) perfectCount++;

  const roundTotal = Math.round((base * multiplier) + speedBonus + perfectBonus);
  totalScore += roundTotal;
  setScore += roundTotal;

  const sw = $("streakWrap");
  sw.classList.add("streak-pop");
  setTimeout(() => sw.classList.remove("streak-pop"), 380);
  updateUI();
}

function updateUI() {
  $("lifeDisplay").innerHTML = '<span class="anim-pulse">‚ù§Ô∏è</span> ' + lives;
  $("scoreDisplay").textContent = totalScore;
  $("jokerCount").textContent = jokers;
  $("streakCount").textContent = streak;
  $("shieldBadge").style.display = shield ? "flex" : "none";
  if (streak >= 2) $("streakWrap").classList.add("streak-active");
  else $("streakWrap").classList.remove("streak-active");
}

function saveRecord() {
  if (totalScore <= 0) return false;
  const records = JSON.parse(localStorage.getItem('italky_sentence_hof_v62') || '[]');
  const now = new Date();
  const newRecord = {
    id: now.getTime() + "-" + Math.random().toString(16).slice(2),
    score: totalScore,
    lang: currentLang.toUpperCase(),
    lvl: currentDiff,
    streak: maxStreak,
    time: now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) + ' ' + now.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })
  };
  records.push(newRecord);
  records.sort((a,b) => b.score - a.score);
  const top10 = records.slice(0, 10);
  localStorage.setItem('italky_sentence_hof_v62', JSON.stringify(top10));
  updateLeaderboardUI();
  return top10.some(r => r.id === newRecord.id);
}

function finishSet() {
  $("endModal").style.display = "flex";
  if (lives <= 0) {
    const isNew = saveRecord();
    $("endTitle").textContent = isNew ? "YENƒ∞ REKOR! üëë" : "Eƒûƒ∞Tƒ∞M Bƒ∞TTƒ∞ üíÄ";
    $("endTitle").style.color = isNew ? "var(--gold)" : "var(--c-error)";
    $("btnContinue").style.display = "none"; $("btnBank").style.display = "none";
    runActive = false; shield = false;
  } else {
    $("endTitle").textContent = "SET TAMAMLANDI üèÜ";
    $("endTitle").style.color = "var(--c-neon-green)";
    $("btnContinue").style.display = "block"; $("btnBank").style.display = "block";
  }
  $("endStats").innerHTML = `TOPLAM SKOR: <b style="color:#fff; font-size:1.2em">${totalScore}</b><br>MAX SERƒ∞: <b style="color:var(--c-neon-pink)">üî• ${maxStreak}</b>`;
}

function returnToMenu() {
  saveRecord();
  runActive = false; shield = false;
  totalScore = 0; setScore = 0; streak = 0; maxStreak = 0;
  $("scoreDisplay").textContent = "0";
  $("endModal").style.display = "none";
  $("startModal").style.display = "flex";
  updateLeaderboardUI();
}

/* ===== Bindings ===== */
document.querySelectorAll(".lang-btn").forEach(btn => {
  btn.onclick = () => {
    currentLang = btn.dataset.lang;
    document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateLeaderboardUI();
  };
});

document.querySelectorAll("[data-lvl]").forEach(btn => {
  btn.onclick = () => {
    ensureDailyTokens();
    const u=getUser();
    if(!isPro(u) && !spendToken()){
      alert("Hakkƒ±n bitti. Hak kazan veya PRO‚Äôya ge√ß.");
      location.href="/pages/game.html";
      return;
    }
    initGame(btn.dataset.lvl);
  };
});

$("btnContinue").onclick = () => {
  ensureDailyTokens();
  const u=getUser();
  if(!isPro(u) && !spendToken()){
    alert("Hakkƒ±n bitti. Hak kazan veya PRO‚Äôya ge√ß.");
    location.href="/pages/game.html";
    return;
  }

  $("btnContinue").disabled = true; $("btnBank").disabled = true;
  shield = true;
  setScore = 0;
  initGame(currentDiff);
};

$("btnBank").onclick = () => {
  ensureDailyTokens();
  const u=getUser();
  if(!isPro(u) && !spendToken()){
    alert("Hakkƒ±n bitti. Hak kazan veya PRO‚Äôya ge√ß.");
    location.href="/pages/game.html";
    return;
  }

  $("btnContinue").disabled = true; $("btnBank").disabled = true;
  const bonus = Math.round(setScore * 0.05);
  totalScore += bonus;
  setScore = 0;
  jokers = Math.min(5, jokers + 1);
  streak = 0; shield = false;
  $("resInfo").textContent = `BANKA BONUSU +${bonus} PUAN & +1 JOKER ‚ö°`;
  $("resInfo").style.opacity = "1";
  initGame(currentDiff, true);
};

$("btnFinish").onclick = returnToMenu;

$("jokerBtn").onclick = () => {
  if (jokers <= 0 || usedJokerInRound) return;
  const hiddenIdx = discovered.map((v, i) => v ? -1 : i).filter(i => i !== -1);
  if (!hiddenIdx.length) return;
  const char = currentWord[hiddenIdx[Math.floor(Math.random() * hiddenIdx.length)]];
  jokers--;
  usedJokerInRound = true;
  document.querySelectorAll(".key-btn").forEach(b => { if (b.textContent === char) handleGuess(char, b); });
  updateUI();
};

window.addEventListener('load', updateLeaderboardUI);
</script>
</body>
</html>
