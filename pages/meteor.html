<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY ‚Ä¢ Meteor Defense ‚Äî Final</title>
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#020005;--panel:rgba(18,18,26,.92);
  --blue:#00f3ff;--red:#ff0055;--green:#00ff66;--gold:#ffb800;
  --border:rgba(255,255,255,.14);--text:#fff
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;background:var(--bg);font-family:Outfit,sans-serif;overflow:hidden;color:var(--text)}
.space{position:absolute;inset:0;background:radial-gradient(circle at bottom,#1a0033,#000)}
.stars{position:absolute;inset:0;background-image:radial-gradient(#fff 1px,transparent 1px);background-size:50px 50px;opacity:.3}

.game{position:relative;max-width:480px;height:100%;margin:0 auto;border-left:1px solid var(--border);border-right:1px solid var(--border);display:flex;flex-direction:column}
.header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 14px}
.score{font-family:Space Grotesk;font-weight:900;color:var(--blue);text-shadow:0 0 10px var(--blue)}
.combo{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,243,255,.3)}
.lives{letter-spacing:2px}
.powerbar{display:flex;gap:6px}
.pbtn{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;font-weight:900;cursor:pointer}
.pbtn:disabled{opacity:.4}

.stage{flex:1;position:relative;overflow:hidden}
.turret{position:absolute;bottom:230px;left:50%;transform:translateX(-50%);width:40px;height:40px;background:var(--blue);border-radius:50% 50% 0 0;box-shadow:0 0 15px var(--blue)}

.meteor{position:absolute;top:-140px;width:110px;height:120px;display:flex;align-items:center;justify-content:center}
.meteor.boss .meteor-body{box-shadow:0 0 28px var(--gold);border-color:var(--gold)}
.meteor-body{width:72px;height:72px;border-radius:50%;background:radial-gradient(circle,#ffcc00,#ff4400);box-shadow:0 0 20px #ff4400;border:2px solid #fff;display:flex;align-items:center;justify-content:center}
.meteor-text{font-family:Space Grotesk;font-weight:900;font-size:13px;color:#000;text-align:center;padding:0 6px}

.laser{position:absolute;height:4px;background:var(--green);box-shadow:0 0 10px var(--green);transform-origin:0 50%}
.explosion{position:absolute;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,#fff,#ffaa00,transparent);animation:boom .45s forwards;pointer-events:none}
@keyframes boom{0%{transform:scale(.2);opacity:1}100%{transform:scale(2);opacity:0}}

.panel{height:240px;background:var(--panel);border-top:2px solid var(--blue);padding:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.opt{border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.06);color:#fff;font-weight:900;font-size:16px;cursor:pointer}
.opt.correct{background:var(--green);color:#000}
.opt.wrong{background:var(--red)}

.toast{position:absolute;left:12px;right:12px;bottom:252px;background:rgba(10,10,18,.85);border:1px solid var(--border);border-radius:14px;padding:10px;display:none;align-items:center;justify-content:space-between;gap:10px}
.toast.show{display:flex}
.toast b{font-family:Space Grotesk}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:99}
.card{background:#101015;border:1px solid var(--blue);border-radius:20px;padding:24px;text-align:center;width:85%}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px 0}
.lang{padding:10px;border:1px solid var(--border);border-radius:8px;font-weight:900;cursor:pointer}
.lang.active{background:var(--blue);color:#000}
.btn{width:100%;padding:14px;margin-top:10px;border:none;border-radius:12px;font-weight:900;background:var(--blue);color:#000}
</style>
</head>

<body>
<div class="space"></div>
<div class="stars"></div>

<div class="game">
  <div class="header">
    <div class="score"><span id="score">0</span> P</div>
    <div class="combo" id="combo">COMBO x0</div>
    <div class="powerbar">
      <button class="pbtn" id="slowBtn" title="Yava≈ülat">‚è≥</button>
      <button class="pbtn" id="nukeBtn" title="Nuke">üí£</button>
    </div>
    <div class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  </div>

  <div class="stage" id="stage">
    <div class="turret"></div>
  </div>

  <div class="toast" id="toast">
    <div><b id="tTitle">‚Äî</b><br><small id="tMsg">‚Äî</small></div>
    <button class="pbtn" id="tSpeak">Oku</button>
  </div>

  <div class="panel" id="panel"></div>
</div>

<div class="modal" id="start">
  <div class="card">
    <h2 style="color:var(--blue)">METEOR DEFENSE</h2>
    <div class="langs" id="langs">
      <div class="lang active" data-lang="en">EN</div>
      <div class="lang" data-lang="de">DE</div>
      <div class="lang" data-lang="fr">FR</div>
      <div class="lang" data-lang="es">ES</div>
      <div class="lang" data-lang="it">IT</div>
    </div>
    <button class="btn" id="startBtn">BA≈ûLA</button>
  </div>
</div>

<div class="modal" id="end" style="display:none">
  <div class="card">
    <h2 style="color:var(--red)">OYUN Bƒ∞TTƒ∞</h2>
    <div style="font-size:28px;font-weight:900" id="final">0</div>
    <button class="btn" onclick="location.reload()">TEKRAR</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";
const $=id=>document.getElementById(id);

let lang="en";
let pool=[],queue=[];
let meteor=null;
let y=0,baseSpeed=.9,speed=.9;
let score=0,lives=3,combo=0;
let running=false,slowTicks=0,nukes=1;
let bossEvery=7,killCount=0;
let lastSpeak="";

const LANGMAP={en:"en-US",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT"};

document.querySelectorAll(".lang").forEach(b=>b.onclick=()=>{
  document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
  b.classList.add("active"); lang=b.dataset.lang;
});

$("#startBtn").onclick=async()=>{
  $("#start").style.display="none";
  const data=await loadLangPool(lang);
  const {used,save}=createUsedSet("meteor_final_"+lang);
  pool=pick(data,80,used,save);
  queue=[...pool];
  score=0;lives=3;combo=0;killCount=0;baseSpeed=.9;speed=.9;slowTicks=0;nukes=1;
  updateUI();
  spawn(true);
  running=true;
  requestAnimationFrame(loop);
};

function spawn(immediate=false){
  if(!queue.length) queue=[...pool];
  const w=queue.shift();
  const el=document.createElement("div");
  el.className="meteor";
  const isBoss = (++killCount % bossEvery === 0);
  if(isBoss) el.classList.add("boss");
  el.innerHTML=`<div class="meteor-body"><div class="meteor-text">${w.w}</div></div>`;
  el.style.left=Math.random()*(360-110)+20+"px";
  $("#stage").appendChild(el);
  meteor={el,data:w,boss:isBoss};
  y=-140;
  baseSpeed=Math.min(baseSpeed+(immediate?0:.05),2.2);
  speed=baseSpeed*(slowTicks>0?.4:1);
  buildOptions(w);
}

function buildOptions(w){
  const panel=$("#panel"); panel.innerHTML="";
  const opts=[w.tr];
  while(opts.length<4){
    const r=pool[Math.floor(Math.random()*pool.length)].tr;
    if(!opts.includes(r)) opts.push(r);
  }
  opts.sort(()=>Math.random()-.5);
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="opt"; b.textContent=o;
    b.onclick=()=>answer(b,o,w.tr);
    panel.appendChild(b);
  });
}

function answer(btn,sel,correct){
  if(!meteor) return;
  if(sel===correct){
    btn.classList.add("correct");
    fire();
    const gain=10+Math.min(combo,5)*5+(meteor.boss?20:0);
    score+=gain; combo++;
    speak(meteor.data.w);
    toast("DOƒûRU",`+${gain} ‚Ä¢ ${meteor.data.w} ‚Üí ${correct}`,meteor.data.w);
    destroy();
  }else{
    btn.classList.add("wrong");
    combo=0; lives--; updateUI();
    toast("YANLI≈û",`Kalan can: ${lives}`,"");
    if(lives<=0) gameOver();
  }
}

function destroy(){
  const m=meteor; if(!m) return;
  const exp=document.createElement("div");
  exp.className="explosion";
  exp.style.left=(m.el.offsetLeft-10)+"px";
  exp.style.top=(y-10)+"px";
  $("#stage").appendChild(exp);
  setTimeout(()=>exp.remove(),500);
  m.el.remove(); meteor=null;
  updateUI();
  setTimeout(()=>spawn(false),400);
}

function fire(){
  const s=$("#stage");
  const laser=document.createElement("div");
  laser.className="laser";
  laser.style.left="50%"; laser.style.top="100%";
  laser.style.width="300px"; laser.style.transform="rotate(-90deg)";
  s.appendChild(laser);
  setTimeout(()=>laser.remove(),150);
}

function loop(){
  if(!running) return;
  if(meteor){
    if(slowTicks>0){ slowTicks--; speed=baseSpeed*.4; }
    else speed=baseSpeed;
    y+=speed; meteor.el.style.top=y+"px";
    if(y>($("#stage").offsetHeight-140)){
      lives--; combo=0; updateUI();
      meteor.el.remove(); meteor=null;
      if(lives<=0){gameOver();return;}
      spawn(false);
    }
  }
  requestAnimationFrame(loop);
}

function updateUI(){
  $("#score").textContent=score;
  $("#combo").textContent="COMBO x"+combo;
  $("#lives").textContent="‚ù§Ô∏è".repeat(lives)+"üíÄ".repeat(3-lives);
  $("#slowBtn").disabled=slowTicks>0;
  $("#nukeBtn").disabled=nukes<=0;
}

function toast(t,m,s){
  lastSpeak=s||""; $("#tTitle").textContent=t; $("#tMsg").textContent=m;
  $("#toast").classList.add("show");
  setTimeout(()=>$("#toast").classList.remove("show"),700);
}

function speak(t){
  if(!t) return;
  const u=new SpeechSynthesisUtterance(t);
  u.lang=LANGMAP[lang]||"en-US";
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

$("#tSpeak").onclick=()=>{ if(lastSpeak) speak(lastSpeak); };

$("#slowBtn").onclick=()=>{ slowTicks=240; };
$("#nukeBtn").onclick=()=>{
  if(nukes<=0) return;
  nukes--; if(meteor){ destroy(); }
};

function gameOver(){
  running=false;
  $("#end").style.display="flex";
  $("#final").textContent=score;
}
</script>
</body>
</html>
