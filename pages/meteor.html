<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);

let lang = "en";
let pool = [];
let deck = [];
let currentMeteor = null;
let totalScore = 0, setScore = 0, combo = 0, momentum = 1.0, lives = 3;
let y = -160, running = false, rafId = 0, killCount = 0, setCounter = 0;
const SET_SIZE = 10; 
let baseSpeed = 1.1;
const speedCap = 3.5;

const LANGMAP = { en:"en-US", de:"de-DE", fr:"fr-FR", es:"es-ES", it:"it-IT" };

function shuffle(a){
  const arr = [...a];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function updatePB(){
  const pb = Number(localStorage.getItem(`meteor_pb_${lang}`) || 0);
  $("pb").textContent = `PB: ${pb}`;
}

document.querySelectorAll(".lang").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); 
    lang = b.dataset.lang; 
    updatePB();
  };
});

function toast(msg, color="var(--blue)"){
  const t = $("resToast");
  t.textContent = msg; t.style.borderColor = color; t.style.color = color; t.style.opacity = "1";
  clearTimeout(window.__tto); window.__tto = setTimeout(()=> t.style.opacity="0", 1500);
}

function laserPulse(){
  const l = $("laser"); l.style.opacity = "1"; l.style.height = "300px";
  setTimeout(()=>{ l.style.opacity = "0"; l.style.height = "0px"; }, 150);
}

function updateUI(){
  $("score").textContent = totalScore;
  $("combo").textContent = "COMBO x" + combo;
  $("momVal").textContent = "x" + momentum.toFixed(2);
  $("lives").textContent = "â¤ï¸".repeat(Math.max(0,lives)) + "ğŸ–¤".repeat(3 - Math.max(0,lives));
}

function safeSpeak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = LANGMAP[lang] || "en-US"; u.rate = 0.9;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch{}
}

function stopGameLoop() {
  running = false;
  if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
}

async function initGame(isBank=false){
  stopGameLoop();
  if(isBank){ lives = 3; momentum = 1.0; baseSpeed = 1.1; combo = 0; }
  setScore = 0; setCounter = 0;
  
  const data = await loadLangPool(lang);
  if (!data?.items?.length) {
    toast("Veri paketi yÃ¼klenemedi! âš ï¸", "var(--red)");
    $("startModal").classList.remove("hidden");
    return;
  }

  const USED_KEY = `used_meteor_v4_${lang}`;
  const { used, save } = createUsedSet(USED_KEY);

  // âœ… Used mantÄ±ÄŸÄ±: save fonksiyonunu pick'e bÄ±rakÄ±yoruz baÅŸkanÄ±m.
  pool = pick(data, 50, used, save);

  // âœ… Eternal DÃ¶ngÃ¼: Recursion yerine temiz sÄ±fÄ±rlama
  if (!pool || pool.length < 15){
    localStorage.removeItem(USED_KEY);
    // Tek seferlik manuel tetikleme
    const cleanUsed = new Set();
    pool = pick(data, 50, cleanUsed, save);
  }

  deck = shuffle(pool).slice(0, SET_SIZE);
  spawnNext();
  running = true;
  rafId = requestAnimationFrame(loop);
}

function spawnNext(){
  if (setCounter >= SET_SIZE){ finishSet(false); return; }

  const w = deck[setCounter];
  const isBoss = (killCount > 0 && killCount % 5 === 0);

  const el = document.createElement("div");
  el.className = `meteor ${isBoss ? "boss" : ""}`;
  el.innerHTML = `<div class="meteor-body"><div class="meteor-text">${String(w.w || "").toUpperCase()}</div></div>`;
  
  const stage = $("stage");
  const left = Math.random() * (stage.offsetWidth - 118);
  el.style.left = Math.max(10, left) + "px";
  stage.appendChild(el);

  currentMeteor = { el, data: w, boss: isBoss, armor: isBoss ? 2 : 1 };
  y = -160;
  currentMeteor.speed = Math.min(baseSpeed + (setCounter * 0.1) + (momentum * 0.1), speedCap) * (isBoss ? 0.7 : 1);

  buildOptions(w);
  updateUI();
}

function buildOptions(w){
  const p = $("panel"); p.innerHTML = "";
  const correct = String(w.tr || "").trim();
  const opts = [correct];

  while(opts.length < 4){
    const r = pool[Math.floor(Math.random() * pool.length)];
    const cand = String(r.tr || "").trim();
    if (cand && !opts.includes(cand)) opts.push(cand);
  }

  shuffle(opts).forEach(o=>{
    const b = document.createElement("button");
    b.className = "opt"; b.textContent = o;
    b.onclick = ()=> checkAnswer(b, o, correct);
    p.appendChild(b);
  });
}

function setButtonsState(disabled) {
  document.querySelectorAll(".opt").forEach(btn => btn.disabled = disabled);
}

function checkAnswer(btn, sel, correct){
  if (!running || !currentMeteor) return;

  if (sel === correct){
    setButtonsState(true); // âœ… Double-click korumasÄ±
    btn.classList.add("correct");
    laserPulse();
    safeSpeak(currentMeteor.data.w);

    // Boss ZÄ±rh MekaniÄŸi
    if (currentMeteor.boss && currentMeteor.armor > 1){
      currentMeteor.armor--;
      toast("ZIRH HASAR ALDI! ğŸ›¡ï¸", "var(--gold)");
      setTimeout(()=> {
        btn.classList.remove("correct");
        buildOptions(currentMeteor.data); // âœ… SeÃ§enekleri karÄ±ÅŸtÄ±r ki farm yapÄ±lmasÄ±n
        setButtonsState(false);
      }, 400);
      return;
    }

    const gain = Math.round((currentMeteor.boss ? 150 : 100) * momentum);
    totalScore += gain; setScore += gain;
    combo++; momentum = Math.min(momentum + 0.05, 1.6);
    killCount++; setCounter++;

    // âœ… Dinamik merkez hesaplama baÅŸkanÄ±m
    const rect = currentMeteor.el.getBoundingClientRect();
    const stageRect = $("stage").getBoundingClientRect();
    const centerX = rect.left - stageRect.left + (rect.width / 2);
    const centerY = y + (rect.height / 2);
    destroyMeteor(centerX, centerY);

    setTimeout(spawnNext, 400);
  } else {
    btn.classList.add("wrong");
    combo = 0; momentum = Math.max(1.0, momentum - 0.2);
    lives--;
    updateUI();
    toast(`DOÄRUSU: ${correct}`, "var(--red)");
    if (lives <= 0) finishSet(true);
  }
}

function destroyMeteor(cx, cy){
  const exp = document.createElement("div");
  exp.className = "explosion";
  exp.style.left = (cx - 80) + "px"; exp.style.top = (cy - 80) + "px";
  $("stage").appendChild(exp);
  setTimeout(()=> exp.remove(), 450);
  if (currentMeteor?.el) currentMeteor.el.remove();
  currentMeteor = null;
}

function loop(){
  if (!running) return;
  if (currentMeteor){
    y += currentMeteor.speed;
    currentMeteor.el.style.top = y + "px";

    if (y > ($("stage").offsetHeight - 100)){
      lives -= currentMeteor.boss ? 2 : 1;
      combo = 0; momentum = 1.0;
      currentMeteor.el.remove(); currentMeteor = null;
      setCounter++;
      if (lives <= 0) finishSet(true);
      else spawnNext();
      updateUI();
    }
  }
  if (running) rafId = requestAnimationFrame(loop);
}

function finishSet(died){
  stopGameLoop();
  if (currentMeteor?.el) currentMeteor.el.remove();
  currentMeteor = null;

  const pb = Number(localStorage.getItem(`meteor_pb_${lang}`) || 0);
  if (totalScore > pb) localStorage.setItem(`meteor_pb_${lang}`, String(totalScore));

  $("endModal").classList.remove("hidden");
  $("endTitle").textContent = died ? "SAVUNMA Ã‡Ã–KTÃœ ğŸ’€" : "SEKTÃ–R TEMÄ°Z ğŸ›°ï¸";
  $("endTitle").style.color = died ? "var(--red)" : "var(--green)";
  $("endStats").innerHTML = `TOPLAM SKOR: <b>${totalScore}</b><br>MOMENTUM: x${momentum.toFixed(2)}<br>METEOR Ä°MHA: ${killCount}`;

  if (died){
    $("btnContinue").classList.add("hidden"); $("btnBank").classList.add("hidden");
  } else {
    $("btnContinue").classList.remove("hidden"); $("btnBank").classList.remove("hidden");
  }
  updatePB();
}

$("startBtn").onclick = async ()=>{
  $("startBtn").disabled = true;
  $("startModal").classList.add("hidden");
  totalScore = 0; lives = 3; momentum = 1.0; baseSpeed = 1.1; combo = 0; killCount = 0;
  updateUI(); 
  await initGame(false);
  $("startBtn").disabled = false;
};

$("btnContinue").onclick = ()=>{
  $("endModal").classList.add("hidden");
  baseSpeed = Math.min(baseSpeed + 0.1, 2.0);
  initGame(false);
};

$("btnBank").onclick = ()=>{
  const bonus = Math.round(setScore * 0.05);
  totalScore += bonus;
  toast(`BANKA: +${bonus} BONUS ğŸ’°`, "var(--gold)");
  $("endModal").classList.add("hidden");
  initGame(true);
};

$("btnExit").onclick = ()=> location.reload();

window.onload = ()=>{ updatePB(); updateUI(); };
</script>
