<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>italkyAI ‚Ä¢ NEURAL VOID</title>
  <style>
    :root {
      --void-bg: #010008;
      --ai-grad: linear-gradient(135deg, #a5b4fc 0%, #6366f1 50%, #ec4899 100%);
      --neon-red: #ff0033;
      --neon-green: #00ff9d;
      --p-lavender: #e9d5ff;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--void-bg); color: #fff; font-family: 'Outfit', sans-serif; height: 100dvh; overflow: hidden; }

    /* üåå G√ñRSEL ≈ûOV */
    .nebula { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #010008 100%); z-index: -1; }
    .stars { position: fixed; inset: 0; background: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.4; z-index: -1; }

    .app-container { width: 100%; max-width: 480px; height: 100%; margin: 0 auto; display: flex; flex-direction: column; position: relative; z-index: 10; }

    /* üõ†Ô∏è Gƒ∞Rƒ∞≈û / KURALLAR EKRANI */
    .setup-overlay { position: absolute; inset: 0; background: var(--void-bg); z-index: 2000; padding: 25px; display: flex; flex-direction: column; }
    .brand-3d { font-family: 'Space Grotesk'; font-size: 40px; font-weight: 900; text-align: center; margin-bottom: 30px; background: var(--ai-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -2px; }
    
    .section-label { font-size: 11px; font-weight: 900; color: #6366f1; letter-spacing: 2px; margin: 15px 0 10px; text-transform: uppercase; }
    
    .grid-select { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .opt-card { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 14px; padding: 12px 5px; text-align: center; cursor: pointer; transition: 0.3s; }
    .opt-card.active { border-color: #6366f1; background: rgba(99, 102, 241, 0.2); transform: scale(1.05); }
    .opt-card span { display: block; font-size: 20px; margin-bottom: 4px; }
    .opt-card label { font-size: 10px; font-weight: 900; pointer-events: none; }

    .diff-select { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .diff-card { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 16px; padding: 15px 10px; text-align: center; cursor: pointer; }
    .diff-card.active { border-color: var(--neon-green); background: rgba(0, 255, 157, 0.1); }
    .diff-card b { display: block; font-size: 12px; margin-bottom: 4px; color: #fff; }
    .diff-card p { margin: 0; font-size: 8px; color: rgba(255,255,255,0.4); font-weight: 700; }

    .start-btn { width: 100%; padding: 20px; border-radius: 20px; border: none; background: var(--ai-grad); color: #fff; font-weight: 900; font-size: 18px; margin-top: 30px; cursor: pointer; box-shadow: 0 10px 30px rgba(99,102,241,0.4); }

    /* HIGH SCORE BAR */
    .best-node { margin-top: auto; background: rgba(255,255,255,0.03); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); }
    .best-node label { display: block; font-size: 9px; font-weight: 900; color: rgba(255,255,255,0.4); margin-bottom: 5px; letter-spacing: 1px; }
    .best-val { display: flex; justify-content: space-between; align-items: center; }
    .best-val b { font-size: 20px; color: var(--p-lavender); }
    .best-val span { font-size: 10px; color: rgba(255,255,255,0.3); font-weight: 800; }

    /* OYUN ƒ∞√áƒ∞ */
    .visual-zone { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .gallows { width: 140px; height: 180px; position: relative; animation: neuralSwing 4s infinite ease-in-out; }
    .g-part { position: absolute; background: #fff; box-shadow: 0 0 10px #fff; display: none; }
    .g-part.fixed { display: block; }
    .g-part.active { display: block; }

    /* Direkler (3 Kademe) */
    .p-base { width: 100px; height: 4px; bottom: 0; left: 20px; }
    .p-up { width: 4px; height: 100%; left: 40px; }
    .p-top { width: 80px; height: 4px; left: 40px; top: 0; }
    .p-rope { width: 2px; height: 25px; left: 110px; top: 0; background: #aaa; }

    /* Adam */
    .p-head { width: 24px; height: 24px; border: 3px solid #fff; border-radius: 50%; left: 99px; top: 25px; }
    .p-body { width: 3px; height: 50px; left: 110px; top: 49px; }
    .p-larm { width: 18px; height: 3px; left: 93px; top: 62px; transform: rotate(-30deg); }
    .p-rarm { width: 18px; height: 3px; left: 110px; top: 62px; transform: rotate(30deg); }
    .p-lleg { width: 18px; height: 3px; left: 93px; top: 98px; transform: rotate(-45deg); }
    .p-rleg { width: 18px; height: 3px; left: 110px; top: 98px; transform: rotate(45deg); }

    .word-area { padding: 15px; text-align: center; }
    .slot { width: 28px; height: 38px; border-bottom: 3px solid rgba(99,102,241,0.2); display: inline-flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 900; margin: 0 3px; }
    .slot.filled { border-bottom-color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green); }

    .kb { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 15px; background: rgba(0,0,0,0.4); border-radius: 30px 30px 0 0; }
    .key { height: 42px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.05); color: #fff; font-weight: 800; font-size: 13px; cursor: pointer; }
    .key.hit { background: var(--neon-green); color: #000; box-shadow: 0 0 10px var(--neon-green); pointer-events: none; }
    .key.miss { background: var(--neon-red); opacity: 0.3; pointer-events: none; }

    @keyframes neuralSwing { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
  </style>
</head>
<body>

  <div class="nebula"></div>
  <div class="stars"></div>

  <div class="app-container">
    
    <div class="setup-overlay" id="setup">
      <div class="brand-3d">italkyAI<br>NEURAL VOID</div>

      <div class="section-label">Dƒ∞L SE√áƒ∞Mƒ∞</div>
      <div class="grid-select" id="langGrid">
        <div class="opt-card active" data-val="en"><span>üá¨üáß</span><label>EN</label></div>
        <div class="opt-card" data-val="de"><span>üá©üá™</span><label>DE</label></div>
        <div class="opt-card" data-val="fr"><span>üá´üá∑</span><label>FR</label></div>
        <div class="opt-card" data-val="it"><span>üáÆüáπ</span><label>IT</label></div>
        <div class="opt-card" data-val="es"><span>üá™üá∏</span><label>ES</label></div>
      </div>

      <div class="section-label">PROTOKOL (ZORLUK)</div>
      <div class="diff-select" id="diffGrid">
        <div class="diff-card active" data-val="easy"><b>KOLAY</b><p>6 Yanlƒ±≈ü Hak</p></div>
        <div class="diff-card" data-val="normal"><b>NORMAL</b><p>4 Yanlƒ±≈ü Hak</p></div>
        <div class="diff-card" data-val="hard"><b>ZOR</b><p>3 Yanlƒ±≈ü Hak</p></div>
      </div>

      <button class="start-btn" onclick="bootGame()">BAƒûLANTIYI KUR</button>

      <div class="best-node">
        <label>GALAKTƒ∞K REKOR</label>
        <div class="best-val">
          <b id="bestScore">0</b>
          <span id="bestDate">-</span>
        </div>
      </div>
    </div>

    <header style="padding: 15px; display: flex; justify-content: space-between;">
      <div onclick="location.href='/pages/game.html'" style="cursor:pointer; font-size:24px;">‚Äπ</div>
      <div style="text-align:right">
        <span style="font-size:10px; opacity:0.5;">CAN:</span> <b id="hp" style="color:var(--neon-green)">3</b><br>
        <span style="font-size:10px; opacity:0.5;">PUAN:</span> <b id="score">0</b>
      </div>
    </header>

    <div class="visual-zone">
      <div class="gallows">
        <div class="g-part fixed p-base"></div>
        <div class="g-part fixed p-up"></div>
        <div class="g-part fixed p-top"></div>
        <div class="g-part fixed p-rope"></div>
        <div class="g-part p-head" id="head"></div>
        <div class="g-part p-body" id="body"></div>
        <div class="g-part p-larm" id="larm"></div>
        <div class="g-part p-rarm" id="rarm"></div>
        <div class="g-part p-lleg" id="lleg"></div>
        <div class="g-part p-rleg" id="rleg"></div>
      </div>
      <div id="hint" style="margin-top:20px; font-weight:900; color:rgba(255,255,255,0.4); text-transform:uppercase; font-size:12px;"></div>
    </div>

    <div class="word-area" id="wordMatrix"></div>

    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
      <button onclick="useJ()" id="jokerBtn" style="padding:10px 20px; border-radius:12px; background:rgba(99,102,241,0.2); border:1px solid #6366f1; color:#fff; font-weight:900;">JOKER (3)</button>
    </div>

    <div class="kb" id="keyboard"></div>

  </div>

  <script type="module">
    import { loadLangPool } from "/js/langpool.js";
    import { supabase } from "/js/supabase_client.js";

    let pool, target, guessed = [], mistakes = 0, jokers = 3;
    let score = 0, hp = 3, lang = 'en', diff = 'easy';

    // UI Controls
    document.getElementById('langGrid').onclick = (e) => {
      const c = e.target.closest('.opt-card'); if(!c) return;
      document.querySelectorAll('#langGrid .opt-card').forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); lang = c.dataset.val;
    };
    document.getElementById('diffGrid').onclick = (e) => {
      const c = e.target.closest('.diff-card'); if(!c) return;
      document.querySelectorAll('#diffGrid .diff-card').forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); diff = c.dataset.val;
    };

    // Load High Score
    const bestData = JSON.parse(localStorage.getItem('italky_hangman_best') || '{"s":0,"d":"-"}');
    document.getElementById('bestScore').innerText = bestData.s;
    document.getElementById('bestDate').innerText = bestData.d;

    window.bootGame = async () => {
      pool = await loadLangPool(lang);
      document.getElementById('setup').style.display = 'none';
      newRound();
    };

    function newRound() {
      guessed = []; mistakes = 0; jokers = 3;
      document.getElementById('jokerBtn').innerText = `JOKER (${jokers})`;
      
      const items = (pool.items || pool).filter(x => x.w.length >= 3);
      target = items[Math.floor(Math.random() * items.length)];

      renderWord();
      renderKB();
      updateVis();
      document.getElementById('score').innerText = score;
      document.getElementById('hp').innerText = hp;
    }

    function renderWord() {
      document.getElementById('wordMatrix').innerHTML = target.w.split('').map(l => 
        `<div class="slot ${guessed.includes(l.toUpperCase())?'filled':''}">${guessed.includes(l.toUpperCase())?l.toUpperCase():''}</div>`
      ).join('');
      document.getElementById('hint').innerText = target.tr;
    }

    function renderKB() {
      const tLetters = [...new Set(target.w.toUpperCase().split(''))];
      const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
      const fillers = abc.filter(l => !tLetters.includes(l)).sort(()=>0.5-Math.random()).slice(0, 13);
      const keys = [...tLetters, ...fillers].sort((a,b)=>a.localeCompare(b));
      
      document.getElementById('keyboard').innerHTML = keys.map(l => 
        `<button class="key" id="k-${l}" onclick="makeG('${l}')">${l}</button>`
      ).join('');
    }

    window.makeG = (l) => {
      if(guessed.includes(l)) return;
      const key = document.getElementById(`k-${l}`);
      if(target.w.toUpperCase().includes(l)) {
        guessed.push(l); key.classList.add('hit'); renderWord();
        if(target.w.split('').every(c => guessed.includes(c.toUpperCase()))) finish(true);
      } else {
        mistakes++; key.classList.add('miss'); updateVis();
        const limit = {easy:6, normal:4, hard:3}[diff];
        if(mistakes >= limit) finish(false);
      }
    };

    function updateVis() {
      document.querySelectorAll('.g-part:not(.fixed)').forEach(p => p.classList.remove('active'));
      const seq = {
        easy: ['head','body','larm','rarm','lleg','rleg'],
        normal: ['head','body','larm','rarm','lleg','rleg'], // 4 yanlƒ±≈üta bitsin diye altta filter yapƒ±yoruz
        hard: ['head','body','larm','rarm','lleg','rleg']
      };
      
      let toShow = [];
      if(diff==='easy') toShow = seq.easy.slice(0, mistakes);
      if(diff==='normal') {
        const nSeq = [['head'],['body'],['larm','rarm'],['lleg','rleg']];
        nSeq.slice(0, mistakes).forEach(g => toShow.push(...g));
      }
      if(diff==='hard') {
        const hSeq = [['head','body'],['larm','rarm'],['lleg','rleg']];
        hSeq.slice(0, mistakes).forEach(g => toShow.push(...g));
      }
      toShow.forEach(id => document.getElementById(id).classList.add('active'));
    }

    function finish(win) {
      if(win) {
        score += (target.w.length * 10);
        if(mistakes === 0 && jokers === 3) { hp++; alert("M√úKEMMEL! +1 CAN KAZANDIN!"); }
        const u = new SpeechSynthesisUtterance(target.w); u.lang = lang==='en'?'en-US':'tr-TR'; speechSynthesis.speak(u);
        setTimeout(newRound, 2000);
      } else {
        hp--;
        if(hp <= 0) {
          if(score > bestData.s) {
            const d = new Date().toLocaleDateString('tr-TR');
            localStorage.setItem('italky_hangman_best', JSON.stringify({s:score, d:d}));
          }
          alert("GAME OVER! Skorun: " + score); location.reload();
        } else {
          alert("OLMADI! Kelime: " + target.w.toUpperCase()); newRound();
        }
      }
    }

    window.useJ = () => {
      if(jokers <= 0) return;
      const rem = target.w.toUpperCase().split('').filter(l => !guessed.includes(l));
      if(rem.length) { jokers--; document.getElementById('jokerBtn').innerText = `JOKER (${jokers})`; makeG(rem[0]); }
    };
  </script>
</body>
</html>
