<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Neon Hangman</title>
  <link rel="icon" href="data:,"/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <style>
    /* --- TEMA: NEON CYBERPUNK --- */
    :root { 
      --bg-deep: #05020a; --text-main: #fff; 
      --c-neon-pink: #ff00ff; --c-neon-blue: #00f3ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --border: rgba(255, 255, 255, 0.15); 
      --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); position:fixed; }
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at center, #1a0a2e 0%, #000 100%); z-index:0; }
    .grid-lines { position: absolute; inset: 0; background-image: linear-gradient(rgba(255, 0, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px); background-size: 40px 40px; opacity: 0.5; }
    #effectCanvas { position: absolute; inset: 0; pointer-events: none; z-index: 9999; display: none; }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
    
    /* HEADER */
    .game-header { flex: 0 0 60px; display:flex; justify-content:space-between; align-items:center; padding:0 20px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); }
    .gh-left { display: flex; flex-direction: column; }
    .gh-brand { font-family: 'Space Grotesk', sans-serif; font-size: 10px; color: var(--c-neon-blue); letter-spacing: 2px; font-weight: 700; }
    .gh-title { font-size: 18px; font-weight: 800; color: #fff; text-shadow: 0 0 10px var(--c-neon-pink); }
    .gh-score { font-family: 'Space Grotesk', sans-serif; font-size: 20px; font-weight: 700; color: var(--c-neon-green); text-align: right; }
    
    .nav-btn { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.1); border-radius:10px; cursor:pointer; color:#fff; font-weight:bold; }

    /* GAME STAGE */
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; padding:10px; position:relative; overflow-y:auto; }
    
    /* HANGMAN VISUAL */
    .gallows-box { position:relative; width:140px; height:160px; margin-bottom:10px; opacity: 0.8; }
    .g-base { position:absolute; bottom:0; left:10px; width:120px; height:4px; background:#fff; border-radius:2px; }
    .g-pole { position:absolute; bottom:0; left:30px; width:4px; height:150px; background:#fff; border-radius:2px; }
    .g-top { position:absolute; top:10px; left:30px; width:80px; height:4px; background:#fff; border-radius:2px; }
    .g-rope { position:absolute; top:10px; right:30px; width:2px; height:20px; background:var(--c-neon-pink); }
    
    .man-part { position:absolute; background:var(--c-neon-pink); border-radius:2px; opacity:0; transition:0.2s; box-shadow: 0 0 5px var(--c-neon-pink); }
    .p1 { top:30px; right:15px; width:30px; height:30px; border:3px solid var(--c-neon-pink); border-radius:50%; background:transparent; } 
    .p2 { top:60px; right:29px; width:2px; height:40px; } 
    .p3 { top:65px; right:31px; width:25px; height:2px; transform:rotate(-20deg); transform-origin:left; } 
    .p4 { top:65px; right:4px; width:25px; height:2px; transform:rotate(20deg); transform-origin:right; } 
    .p5 { top:98px; right:29px; width:2px; height:30px; transform:rotate(25deg); transform-origin:top; } 
    .p6 { top:98px; right:29px; width:2px; height:30px; transform:rotate(-25deg); transform-origin:top; } 
    
    .boss-tag { display:none; background:var(--c-error); color:#fff; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:800; margin-bottom:5px; animation: pulse 1s infinite; }
    .boss-mode .boss-tag { display:inline-block; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }

    /* WORD & KEYBOARD */
    .word-box { display:flex; flex-wrap:wrap; justify-content:center; gap:6px; margin-bottom:15px; min-height:40px; }
    .letter-slot { width:32px; height:40px; border-bottom:3px solid var(--c-neon-blue); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:800; color:#fff; text-transform:uppercase; font-family:'Space Grotesk', sans-serif; }
    .letter-slot.filled { border-bottom-color:transparent; text-shadow:0 0 10px var(--c-neon-blue); animation:popIn 0.3s; }
    .letter-slot.missed { color:var(--c-error); text-shadow:0 0 10px var(--c-error); }

    .hint-box { background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:8px 16px; border-radius:12px; font-size:14px; color:rgba(255,255,255,0.8); text-align:center; margin-bottom:15px; width:100%; min-height:40px; display:flex; align-items:center; justify-content:center; font-style:italic; }
    
    .keyboard { display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; width:100%; max-width:400px; }
    .key-btn { aspect-ratio:1; background:rgba(255,255,255,0.1); border:1px solid var(--border); border-radius:8px; color:#fff; font-weight:700; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.1s; }
    .key-btn:active { transform:scale(0.95); }
    .key-btn.used { opacity:0.3; pointer-events:none; }
    .key-btn.correct { background:var(--c-neon-green); border-color:var(--c-neon-green); color:#000; box-shadow:0 0 15px var(--c-neon-green); opacity:1; }
    .key-btn.wrong { background:var(--c-error); border-color:var(--c-error); color:#fff; opacity:0.5; }

    .power-bar { display:flex; justify-content:center; gap:10px; margin-top:15px; width:100%; }
    .pwr-btn { background:linear-gradient(45deg, #ff00ff, #00f3ff); border:none; padding:10px 20px; border-radius:20px; color:#fff; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 5px 15px rgba(255,0,255,0.3); display:flex; align-items:center; gap:5px; transition:0.2s; }
    .pwr-btn:active { transform:scale(0.95); }
    .pwr-btn.disabled { opacity:0.5; filter:grayscale(1); pointer-events:none; }

    /* MODAL */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(20px); padding:20px; }
    .modal-card { width:100%; max-width:320px; background:#101014; border:1px solid var(--border); border-radius:24px; padding:24px; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,1); animation: popIn 0.5s; }
    .modal-title { font-size:24px; font-weight:800; margin-bottom:10px; color:var(--c-neon-blue); font-family:'Space Grotesk', sans-serif; }
    
    .lang-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:5px; margin:15px 0; }
    .lang-btn { padding:10px 0; background:rgba(255,255,255,0.1); border-radius:8px; border:1px solid transparent; cursor:pointer; font-size:20px; transition:0.2s; }
    .lang-btn.active { background:var(--c-neon-blue); color:#000; box-shadow:0 0 10px var(--c-neon-blue); }

    .diff-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:20px; }
    .diff-btn { padding:12px; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:12px; color:#fff; font-weight:700; cursor:pointer; }
    .diff-btn:hover { background:rgba(255,255,255,0.1); }
    
    .btn-primary { width:100%; padding:14px; background:var(--c-neon-green); color:#000; border:none; border-radius:12px; font-weight:800; font-size:16px; cursor:pointer; }
    .btn-sec { background:rgba(255,255,255,0.1); color:#fff; margin-top:10px; }

    @keyframes popIn { from{transform:scale(0.8); opacity:0} to{transform:scale(1); opacity:1} }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="grid-lines"></div></div>
  <canvas id="effectCanvas"></canvas>

  <div class="wrap">
    <div class="game-header">
      <div class="gh-left">
        <div class="gh-brand">ITALKY</div>
        <div class="gh-title">HANGMAN</div>
      </div>
      <div class="gh-score" id="scoreDisplay">0</div>
    </div>

    <div style="position: absolute; top: 10px; right: 10px; z-index: 50;">
        <button class="nav-btn" onclick="window.location.href='/pages/game.html'" style="background: rgba(255,0,0,0.3); border:1px solid rgba(255,0,0,0.5);">‚úï</button>
    </div>

    <div class="stage" id="gameStage">
      <div class="boss-tag">‚ö†Ô∏è BOSS ROUND</div>
      
      <div class="gallows-box">
        <div class="g-base"></div><div class="g-pole"></div><div class="g-top"></div><div class="g-rope"></div>
        <div class="man-part p1"></div><div class="man-part p2"></div><div class="man-part p3"></div>
        <div class="man-part p4"></div><div class="man-part p5"></div><div class="man-part p6"></div>
      </div>

      <div class="hint-box" id="hintBox">...</div>
      <div class="word-box" id="wordBox"></div>
      <div class="keyboard" id="keyboard"></div>

      <div class="power-bar">
        <button class="pwr-btn" id="btnPowerUp" onclick="window.usePowerUp()">
          ‚ö° ƒ∞PUCU (<span id="powerCount">1</span>)
        </button>
      </div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">NEON HANGMAN</div>
      <div style="font-size:12px; opacity:0.7">Hedef Dil:</div>
      <div class="lang-grid">
        <div class="lang-btn active" onclick="setLang('en', this)">üá¨üáß</div>
        <div class="lang-btn" onclick="setLang('de', this)">üá©üá™</div>
        <div class="lang-btn" onclick="setLang('fr', this)">üá´üá∑</div>
        <div class="lang-btn" onclick="setLang('es', this)">üá™üá∏</div>
        <div class="lang-btn" onclick="setLang('it', this)">üáÆüáπ</div>
      </div>
      
      <div style="font-size:12px; opacity:0.7; margin-bottom:5px">Zorluk Seviyesi:</div>
      <div class="diff-grid">
        <button class="diff-btn" onclick="selectLevel('A2')">A2<br><span style="font-size:10px;opacity:0.6">Kolay</span></button>
        <button class="diff-btn" onclick="selectLevel('B1')">B1<br><span style="font-size:10px;opacity:0.6">Orta</span></button>
        <button class="diff-btn" onclick="selectLevel('B2')">B2<br><span style="font-size:10px;opacity:0.6">Zor</span></button>
      </div>
      <div id="loading" style="display:none; color:var(--c-neon-blue)">Kelime Havuzu Hazƒ±rlanƒ±yor...</div>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <div class="modal-title" id="endTitle">OYUN Bƒ∞TTƒ∞</div>
      <p id="endMsg" style="opacity:0.8; margin-bottom:20px; line-height:1.5"></p>
      <button class="btn-primary" id="retryBtn">YENƒ∞DEN OYNA</button>
      <button class="btn-sec btn-primary" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);

let currentLang = "en";
let currentDiff = "A2";
let wordList = [];
let currentIndex = 0;
let score = 0;
let powerups = 1;
let mistakes = 0;
let currentWord = "";
let discovered = [];
let maxErrors = 6;
let isBossRound = false;

// ‚úÖ HATA 1: A2 Lives 7 -> 6 yapƒ±ldƒ± (Daraƒüacƒ± ile e≈üle≈üti)
const SETTINGS = {
  A2: { min:3, max:6, lives:6 },
  B1: { min:6, max:9, lives:6 },
  B2: { min:9, max:15, lives:5 }
};

// ‚úÖ HATA 2: Unicode Harf Desteƒüi (√Ñ, √ñ, √ë vb.)
function isLetterChar(ch){
  return !!ch && /\p{L}/u.test(ch); // T√ºm dillerdeki harfleri kapsar
}

function getAlphabet(lang){
  const base = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  if(lang === "de") return base + "√Ñ√ñ√ú√ü";
  if(lang === "es") return base + "√ë√Å√â√ç√ì√ö√ú";
  if(lang === "fr") return base + "√Ä√Ç√Ü√á√â√à√ä√ã√é√è√î≈í√ô√õ√ú≈∏";
  if(lang === "it") return base; // ƒ∞talyanca genelde standart alfabe kullanƒ±r
  return base;
}

// ‚úÖ NORMALƒ∞ZASYON: Aksanlarƒ± KORU (Klavye e≈üle≈ümesi i√ßin)
function normalize(s){
  return String(s||"").trim().toUpperCase().replace(/[.,!?]/g, "");
}

window.setLang = (l, el) => {
  currentLang = l;
  document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove("active"));
  if(el) el.classList.add("active");
  // Ses motorunu burada ƒ±sƒ±tmayalƒ±m, oyun ba≈ülarken yapalƒ±m
};

window.selectLevel = (diff) => {
  currentDiff = diff;
  initGame();
};

// --------------------------------------------------------
// 1. DATA LOADING (LANGPOOL)
// --------------------------------------------------------
async function initGame() {
  $("loading").style.display = "block";
  const startBtns = document.querySelectorAll(".diff-btn");
  startBtns.forEach(b => b.disabled = true);

  try {
    const pool = await loadLangPool(currentLang);
    
    if(!pool || pool.length === 0) {
      alert("Dil paketi y√ºklenemedi!");
      return;
    }

    const { used, save } = createUsedSet(`used_hangman_${currentLang}_${currentDiff}`);
    const cfg = SETTINGS[currentDiff];

    // ‚úÖ HATA 3: Uzunluk sayarken sadece harfleri say (bo≈üluk/tire hari√ß)
    const filterFn = (item) => {
      const w = normalize(item.w); // Aksanlƒ± haliyle al
      const lettersOnly = w.replace(/[^\p{L}]/gu, ""); // Sadece harfleri say
      const len = lettersOnly.length;
      return len >= cfg.min && len <= cfg.max;
    };

    let selected = pick(pool, 15, used, save, filterFn);

    // Fallback: Filtre √ßok dar geldiyse esnet
    if(selected.length < 5) {
       selected = pick(pool, 15, used, save, (item) => item.w.length >= 3);
    }

    // Oyuna Hazƒ±rla
    wordList = selected.map(item => ({
        w: normalize(item.w), // Aksanlƒ± b√ºy√ºk harf
        t: item.tr
    }));

    $("loading").style.display = "none";
    startBtns.forEach(b => b.disabled = false);
    startGameFlow();

  } catch (err) {
    console.error(err);
    alert("Hata: " + err.message);
    $("loading").style.display = "none";
    startBtns.forEach(b => b.disabled = false);
  }
}

// --------------------------------------------------------
// 2. GAME FLOW
// --------------------------------------------------------
function startGameFlow() {
  // ‚úÖ HATA 4: Ses motorunu oyun ba≈ülarken garantiye al
  ensureAudio();
  
  $("startModal").style.display = "none";
  $("endModal").style.display = "none";
  
  currentIndex = 0;
  score = 0;
  powerups = 1;
  updateScoreUI();
  
  startRound();
}

function startRound() {
  if(currentIndex >= wordList.length) {
    gameOver(true); 
    return;
  }

  const data = wordList[currentIndex];
  currentWord = data.w; // Artƒ±k aksanlƒ± gelebilir (√ñrn: √úBER)
  const translation = data.t;
  
  isBossRound = (currentIndex + 1) % 5 === 0;
  maxErrors = isBossRound ? 3 : SETTINGS[currentDiff].lives;
  
  if(isBossRound) {
    $("gameStage").classList.add("boss-mode");
    $("hintBox").textContent = `‚ö†Ô∏è BOSS: ${translation}`;
  } else {
    $("gameStage").classList.remove("boss-mode");
    $("hintBox").textContent = translation;
  }

  mistakes = 0;
  discovered = new Array(currentWord.length).fill(false);
  
  renderHangman();
  renderWord();
  renderKeyboard();
}

// --------------------------------------------------------
// 3. UI RENDERERS
// --------------------------------------------------------
function renderWord() {
  const box = $("wordBox");
  box.innerHTML = "";
  for(let i=0; i<currentWord.length; i++) {
    const d = document.createElement("div");
    const char = currentWord[i];
    // ‚úÖ Harf kontrol√º (Unicode uyumlu)
    const isLetter = isLetterChar(char);
    
    if(!isLetter) {
        d.className = "letter-slot filled";
        d.textContent = char;
        d.style.borderBottom = "none";
        discovered[i] = true;
    } else {
        d.className = `letter-slot ${discovered[i] ? 'filled' : ''}`;
        d.textContent = discovered[i] ? char : "";
    }
    box.appendChild(d);
  }
}

function renderHangman() {
  for(let i=1; i<=6; i++) {
    const el = document.querySelector(`.p${i}`);
    if(el) {
      const threshold = Math.ceil((mistakes / maxErrors) * 6);
      el.style.opacity = (i <= threshold && mistakes > 0) ? 1 : 0;
    }
  }
}

function renderKeyboard() {
  const kb = $("keyboard");
  kb.innerHTML = "";
  
  // ‚úÖ Dile √∂zg√º alfabe (√Ñ, √ñ, √ë vb. dahil)
  const fullAlphabet = getAlphabet(currentLang);
  let keysToShow = fullAlphabet.split("");
  
  // A2'de klavyeyi sadele≈ütir
  if(currentDiff === "A2") {
    const needed = new Set(currentWord.replace(/[^\p{L}]/gu, "").split(""));
    const extraPool = fullAlphabet.split("");
    
    // Kelimede olmayan harflerden rastgele ekle
    while(needed.size < (currentWord.length + 8)) {
      needed.add(extraPool[Math.floor(Math.random() * extraPool.length)]);
    }
    // Alfabetik sƒ±raya sok
    keysToShow = Array.from(needed).sort((a,b) => fullAlphabet.indexOf(a) - fullAlphabet.indexOf(b));
  }

  keysToShow.forEach(char => {
    const btn = document.createElement("div");
    btn.className = "key-btn";
    btn.textContent = char;
    btn.onclick = () => handleGuess(char, btn);
    kb.appendChild(btn);
  });
}

// --------------------------------------------------------
// 4. GAME LOGIC
// --------------------------------------------------------
function handleGuess(char, btn) {
  if(btn.classList.contains("used")) return;
  btn.classList.add("used");
  
  if(currentWord.includes(char)) {
    SFX.click();
    btn.classList.add("correct");
    for(let i=0; i<currentWord.length; i++) {
      if(currentWord[i] === char) discovered[i] = true;
    }
    renderWord();
    checkWin();
  } else {
    SFX.fail();
    btn.classList.add("wrong");
    mistakes++;
    renderHangman();
    
    if(mistakes >= maxErrors) {
      teacherSolve(); 
    }
  }
}

function checkWin() {
  if(discovered.every(Boolean)) {
    SFX.win();
    score += (maxErrors - mistakes) * 10;
    if(isBossRound) score += 50;
    if((currentIndex+1) % 3 === 0) powerups++;
    
    updateScoreUI();
    startConfetti();
    
    setTimeout(() => {
      currentIndex++;
      startRound();
    }, 1500);
  }
}

window.usePowerUp = () => {
  if(powerups <= 0 || isBossRound) return;
  let targets = [];
  for(let i=0; i<currentWord.length; i++) {
    if(!discovered[i] && isLetterChar(currentWord[i])) targets.push(currentWord[i]);
  }
  if(targets.length === 0) return;
  
  const char = targets[Math.floor(Math.random() * targets.length)];
  const keys = document.querySelectorAll(".key-btn");
  for(let btn of keys) {
    if(btn.textContent === char) {
      powerups--;
      updateScoreUI();
      handleGuess(char, btn);
      break;
    }
  }
};

function updateScoreUI() {
  $("scoreDisplay").textContent = score;
  $("powerCount").textContent = powerups;
  const pb = $("btnPowerUp");
  if(powerups > 0 && !isBossRound) pb.classList.remove("disabled");
  else pb.classList.add("disabled");
}

function teacherSolve() {
  const slots = document.querySelectorAll(".letter-slot");
  for(let i=0; i<currentWord.length; i++) {
    if(!discovered[i]) {
      slots[i].textContent = currentWord[i];
      slots[i].classList.add("missed");
    }
  }
  // Seslendirme ekle (Opsiyonel)
  speakWord(wordList[currentIndex].w);
  setTimeout(() => { gameOver(false); }, 1500);
}

function gameOver(win) {
  $("endModal").style.display = "flex";
  $("endTitle").textContent = win ? "TEBRƒ∞KLER! üèÜ" : "OYUN Bƒ∞TTƒ∞";
  $("endTitle").style.color = win ? "var(--c-neon-green)" : "var(--c-error)";
  $("endMsg").innerHTML = `Skor: ${score}<br>${win ? 'T√ºm kelimeleri bildin!' : 'Bir dahaki sefere!'}`;
}

// ‚úÖ HATA 5: Retry yapƒ±nca modal'ƒ± hemen gizle
$("retryBtn").onclick = () => {
  $("endModal").style.display = "none"; 
  initGame();
};

// SES
let audioCtx = null;
function ensureAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = AC ? new AC() : null;
  }
  if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
}

const SFX = {
  click: () => {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.frequency.value = 800; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(.05, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, audioCtx.currentTime + .1);
    o.start(); o.stop(audioCtx.currentTime + .1);
  },
  win: () => {
    if(!audioCtx) return;
    [523,659,783].forEach((f,i)=>{
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(.05,audioCtx.currentTime+i*.1);
      g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+i*.1+.3);
      o.start(audioCtx.currentTime+i*.1); o.stop(audioCtx.currentTime+i*.1+.3);
    });
  },
  fail: () => {
    if(!audioCtx) return;
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='sawtooth'; o.frequency.value=100;
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(.1,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.5);
    o.start(); o.stop(audioCtx.currentTime+.5);
  }
};

// Basit TTS
function speakWord(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = currentLang === 'en' ? 'en-US' : 
           currentLang === 'de' ? 'de-DE' :
           currentLang === 'fr' ? 'fr-FR' :
           currentLang === 'es' ? 'es-ES' : 'it-IT';
  u.rate = 0.8;
  try { window.speechSynthesis.speak(u); } catch{}
}

// CONFETTI
const cvs = $("effectCanvas"), ctx = cvs.getContext("2d");
let particles = [];
function startConfetti() {
  particles = [];
  cvs.style.display = "block";
  cvs.width = window.innerWidth;
  cvs.height = window.innerHeight;
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: cvs.width / 2, y: cvs.height / 2,
      vx: (Math.random() - .5) * 15, vy: (Math.random() - .5) * 15,
      color: `hsl(${Math.random() * 360},100%,50%)`, life: 50
    });
  }
  requestAnimationFrame(loopConfetti);
}
function loopConfetti() {
  if (particles.length <= 0) { cvs.style.display = "none"; return; }
  ctx.clearRect(0, 0, cvs.width, cvs.height);
  for (let i = 0; i < particles.length; i++) {
    let p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life--;
    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = p.color; ctx.fill();
    if (p.life <= 0) { particles.splice(i, 1); i--; }
  }
  requestAnimationFrame(loopConfetti);
}
window.addEventListener("resize", () => {
  if (cvs.style.display === "block") { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
});
</script>
</body>
</html>
