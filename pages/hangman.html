<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

async function initGame(retryCount = 0) {
    document.getElementById("setupView").style.display = "none";
    document.getElementById("modalMsg").innerHTML = "Havuz Hazırlanıyor...<br><span style='font-size:10px'>Lütfen bekleyin</span>";
    
    try {
        const rawPool = await loadLangPool(currentLang);
        
        // KRİTİK DÜZELTME: Görseldeki gibi {"items": [...]} yapısını veya doğrudan diziyi destekler
        const pool = Array.isArray(rawPool) ? rawPool : (rawPool.items || []); 
        
        if (pool.length === 0 && retryCount < 2) {
            console.warn("Havuz boş veya henüz yüklenmedi, tekrar deneniyor...");
            setTimeout(() => initGame(retryCount + 1), 1000);
            return;
        }

        const { used, save } = createUsedSet(`italky_used_hangman_${currentLang}_${currentDiff}`);
        
        // Filtreleme Stratejisi (A2 = A1 + A2 Kuralı Uygulandı)
        const checkLevel = (lvl) => (currentDiff === "A2" ? ["A1", "A2"].includes(lvl) : lvl === currentDiff);

        let selected = pick(pool, 15, used, save, (it) => {
            const w = it.w.trim();
            return checkLevel(it.lvl) && w.length >= 3;
        });

        if (selected.length === 0) {
            document.getElementById("modalMsg").textContent = "Uygun kelime bulunamadı. Lütfen başka bir seviye seçin.";
            document.getElementById("setupView").style.display = "block";
            return;
        }

        wordList = selected;
        startGame();
    } catch (e) {
        console.error("Havuz yükleme hatası:", e);
        document.getElementById("modalMsg").textContent = "Bağlantı hatası!";
        document.getElementById("setupView").style.display = "block";
    }
}
</script>
