<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Arena Championship V19</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030305;
      --border: rgba(255,255,255,0.12);
      --pA: #00f0ff; --pB: #ff0055;
      --green: #00e676; --red: #ff1744; --gold: #ffd700;
      --font-main: 'Outfit', sans-serif;
      --font-display: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: var(--font-main); color: #fff; overflow: hidden; position: fixed; }

    /* ARKA PLAN */
    .bg-fx { position: absolute; inset: 0; z-index: 0; background: radial-gradient(circle at 50% 50%, #0a0a12 0%, #000 100%); }
    .nebula { position: absolute; width: 100%; height: 100%; filter: blur(80px); opacity: 0.15; animation: pulseBg 10s infinite alternate; }
    @keyframes pulseBg { 0% { opacity: 0.1; } 100% { opacity: 0.2; } }

    /* HEADER */
    .app-header { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; pointer-events: none; }
    .header-logo { font-family: var(--font-display); font-weight: 700; font-size: 18px; opacity: 0.8; pointer-events: auto; }
    .header-back { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: rgba(255,255,255,0.1); text-decoration: none; color: #fff; font-size: 18px; pointer-events: auto; border: 1px solid rgba(255,255,255,0.1); }

    /* OYUN ALANI */
    .arena-wrap { position: relative; z-index: 10; width: 100%; height: 100dvh; display: flex; flex-direction: column; }
    
    .player-zone { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; transition: all 0.4s ease; overflow: hidden; opacity: 0.4; filter: blur(3px) grayscale(0.8); pointer-events: none; }
    .player-zone.active { opacity: 1; filter: blur(0) grayscale(0); pointer-events: auto; background: radial-gradient(circle at center, rgba(255,255,255,0.03) 0%, transparent 70%); }
    
    #zoneB { border-bottom: 1px solid var(--border); align-items: flex-end; padding-bottom: 20px; }
    #zoneB .card-content { transform: rotate(180deg); }
    #zoneA { border-top: 1px solid var(--border); align-items: flex-end; padding-bottom: 40px; }

    .card-content { width: 90%; max-width: 360px; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
    
    .main-word { font-family: var(--font-display); font-size: 38px; font-weight: 700; line-height: 1.1; margin: 5px 0; }
    .sub-word { font-size: 18px; color: rgba(255,255,255,0.7); margin-bottom: 25px; min-height: 24px; font-weight: 500; }

    .player-header { display: flex; align-items: center; gap: 10px; margin-top:10px; margin-bottom: 10px; }
    .player-label { font-size: 12px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
    
    #zoneA .player-label { color: var(--pA); } #zoneB .player-label { color: var(--pB); }

    /* CONTROLS */
    .controls { display: flex; gap: 8px; width: 100%; margin-top: auto; }
    .btn { border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); color: #fff; padding: 16px 0; border-radius: 14px; font-family: var(--font-display); font-weight: 700; font-size: 13px; cursor: pointer; flex: 1; transition: 0.1s; }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: grayscale(1); }
    
    .btn-mic { flex: 2; background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }
    .btn.listening { background: #fff !important; color: #000 !important; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 100% { box-shadow: 0 0 0 15px rgba(255,255,255,0); } }

    .btn-var { flex: 0.8; color: var(--gold); border-color: rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.05); font-size: 11px; }

    /* CENTER SCOREBOARD */
    .arena-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 60px; background: #000; border: 1px solid var(--border); border-radius: 30px; display: flex; align-items: center; justify-content: center; z-index: 20; box-shadow: 0 0 40px rgba(0,0,0,0.8); gap: 10px; }
    
    .score-box { display:flex; flex-direction:column; align-items:center; line-height:1; }
    .score-val { font-family: var(--font-display); font-size: 22px; font-weight: 700; }
    .set-val { font-size: 10px; font-weight: 700; opacity: 0.6; color:#fff; }
    
    .vs-logo { width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:900; color:#888; }

    /* MODAL */
    .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.92); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-box { width: 90%; max-width: 360px; background: #121216; border: 1px solid var(--border); border-radius: 32px; padding: 30px; text-align: center; }
    
    .mode-select { display: flex; gap: 10px; margin-bottom: 20px; }
    .mode-btn { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; font-weight: 700; opacity: 0.6; transition: 0.2s; }
    .mode-btn.active { opacity: 1; background: var(--pA); color: #000; border-color: var(--pA); }
    .mode-btn.vocab.active { background: var(--pB); border-color: var(--pB); }

    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .name-input { width: 100%; background: #1a1a20; border: 1px solid var(--border); color: #fff; padding: 14px; border-radius: 12px; font-weight: 700; text-align: center; }
    
    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
    .lang-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; border-radius: 12px; padding: 10px 0; font-size: 20px; cursor: pointer; }
    .lang-btn.active { background: #fff; color: #000; }

    .btn-block { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 16px; cursor: pointer; background: #fff; color: #000; }

    /* OVERLAY */
    .result-overlay { position: absolute; inset: -20px; z-index: 50; background: rgba(8, 8, 10, 0.96); backdrop-filter: blur(12px); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; opacity: 0; pointer-events: none; transform: scale(0.9); transition: 0.25s; }
    .result-overlay.show { opacity: 1; transform: scale(1); }
    .res-title { font-size: 40px; font-weight: 800; font-family: var(--font-display); margin:0; line-height:1; }
    .res-sub { margin-top: 10px; font-size: 16px; color:#ccc; }
    .badge { margin-top: 15px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.1); }
  </style>
</head>
<body>

  <div class="bg-fx"></div>
  <div class="nebula" style="background:var(--pA); top:-20%; left:-20%;"></div>
  <div class="nebula" style="background:var(--pB); bottom:-20%; right:-20%;"></div>

  <div class="app-header">
    <a href="game.html" class="header-back">‚úï</a>
    <div class="header-logo">italkyAI</div>
    <div style="width:36px"></div>
  </div>

  <div class="arena-wrap">
    <div class="player-zone" id="zoneB">
      <div class="card-content">
        <div class="result-overlay" id="ovB"><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        <div class="controls">
          <button class="btn btn-var" id="varB" onclick="game.action('var', 'B')">HAKEM</button>
          <button class="btn" id="passB" onclick="game.action('pass', 'B')">PAS (1)</button>
          <button class="btn btn-mic" id="micB" onclick="game.action('mic', 'B')">üéôÔ∏è CEVAPLA</button>
        </div>
        <div style="margin: auto 0;">
          <div class="main-word" id="wB">...</div>
          <div class="sub-word" id="mB">...</div>
        </div>
        <div class="player-header" style="justify-content:center; margin-top:20px;">
          <div class="player-label" id="lblB">OYUNCU B</div>
        </div>
      </div>
    </div>

    <div class="arena-center">
      <div class="score-box">
        <span class="set-val" id="setB">SET: 0</span>
        <span class="score-val" style="color:var(--pB)" id="sB">0</span>
      </div>
      <div class="vs-logo">VS</div>
      <div class="score-box">
        <span class="set-val" id="setA">SET: 0</span>
        <span class="score-val" style="color:var(--pA)" id="sA">0</span>
      </div>
    </div>

    <div class="player-zone" id="zoneA">
      <div class="card-content">
        <div class="result-overlay" id="ovA"><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        <div class="player-header" style="justify-content:center; margin-bottom:20px;">
          <div class="player-label" id="lblA">OYUNCU A</div>
        </div>
        <div style="margin: auto 0;">
          <div class="main-word" id="wA">...</div>
          <div class="sub-word" id="mA">...</div>
        </div>
        <div class="controls">
          <button class="btn" id="passA" onclick="game.action('pass', 'A')">PAS (1)</button>
          <button class="btn btn-mic" id="micA" onclick="game.action('mic', 'A')">üéôÔ∏è CEVAPLA</button>
          <button class="btn btn-var" id="varA" onclick="game.action('var', 'A')">HAKEM</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="setupModal">
    <div class="modal-box">
      <div class="header-logo" style="font-size:24px; margin-bottom:20px;">ARENA SETUP</div>
      
      <div class="mode-select">
        <div class="mode-btn active" onclick="setup.setMode('pron')" id="btnModePron">üéôÔ∏è TELAFFUZ</div>
        <div class="mode-btn vocab" onclick="setup.setMode('vocab')" id="btnModeVocab">üß† KELƒ∞ME</div>
      </div>

      <div class="input-group">
        <input type="text" class="name-input" id="inpA" placeholder="Oyuncu A">
        <input type="text" class="name-input p2" id="inpB" placeholder="Oyuncu B">
      </div>

      <div class="lang-grid">
        <button class="lang-btn active" data-lang="en">üá¨üáß</button>
        <button class="lang-btn" data-lang="de">üá©üá™</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑</button>
        <button class="lang-btn" data-lang="es">üá™üá∏</button>
        <button class="lang-btn" data-lang="it">üáÆüáπ</button>
      </div>

      <button class="btn-block" onclick="game.init()">BA≈ûLA (5 SET)</button>
    </div>
  </div>

  <div class="modal hidden" id="pauseModal">
    <div class="modal-box">
      <div style="font-family:var(--font-display); font-weight:700; font-size:20px; margin-bottom:15px; color:#fff;" id="pauseTitle">SET √ñZETƒ∞</div>
      
      <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span style="color:var(--pA); font-weight:700" id="statNameA">A</span>
          <span id="statScoreA">0 Puan</span>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span style="color:var(--pB); font-weight:700" id="statNameB">B</span>
          <span id="statScoreB">0 Puan</span>
        </div>
      </div>

      <div style="font-size:22px; font-weight:800; color:var(--gold); margin-bottom:25px;" id="setWinnerMsg">...</div>
      
      <button class="btn-block" style="background:var(--green); color:#000" id="btnContinue" onclick="game.continueGame()">SONRAKƒ∞ SET</button>
      <button class="btn-block" style="background:rgba(255,255,255,0.1); color:#fff; margin-top:10px;" onclick="location.href='game.html'">√áIKI≈û</button>
    </div>
  </div>

<script>
// --- UTILS ---
function normalize(str) { 
  return str.toLowerCase().replace(/√ü/g, "ss").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9 ]/g, "").trim(); 
}

function getBestMatchScore(target, spoken) {
  const normTarget = normalize(target);
  const normSpoken = normalize(spoken);
  if (normSpoken.includes(normTarget)) return 100;
  
  let bestScore = similarity(normTarget, normSpoken);
  normSpoken.split(" ").forEach(w => {
    const score = similarity(normTarget, w);
    if (score > bestScore) bestScore = score;
  });
  return Math.floor(bestScore * 100);
}

function similarity(s1, s2) {
  let longer = s1, shorter = s2;
  if (s1.length < s2.length) { longer = s2; shorter = s1; }
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
  const costs = new Array();
  for (let i = 0; i <= s1.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else if (j > 0) {
        let newValue = costs[j - 1];
        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

// --- DATA ---
const DB = {
  en: [{w:"Excellent",tr:"M√ºkemmel"},{w:"Challenge",tr:"Meydan Okuma"},{w:"Opportunity",tr:"Fƒ±rsat"},{w:"Journey",tr:"Yolculuk"},{w:"Environment",tr:"√áevre"},{w:"Necessary",tr:"Gerekli"},{w:"Dangerous",tr:"Tehlikeli"},{w:"Knowledge",tr:"Bilgi"},{w:"Experience",tr:"Deneyim"},{w:"Incredible",tr:"ƒ∞nanƒ±lmaz"},{w:"Understand",tr:"Anlamak"},{w:"Remember",tr:"Hatƒ±rlamak"},{w:"Solution",tr:"√á√∂z√ºm"},{w:"Together",tr:"Birlikte"},{w:"Success",tr:"Ba≈üarƒ±"},{w:"Future",tr:"Gelecek"},{w:"Freedom",tr:"√ñzg√ºrl√ºk"},{w:"Victory",tr:"Zafer"},{w:"Quality",tr:"Kalite"},{w:"Ambition",tr:"Hƒ±rs"}],
  de: [{w:"Entscheidung",tr:"Karar"},{w:"M√∂glichkeit",tr:"ƒ∞mkan"},{w:"Erfahrung",tr:"Deneyim"},{w:"Nat√ºrlich",tr:"Doƒüal"},{w:"Wichtig",tr:"√ñnemli"},{w:"Zusammen",tr:"Birlikte"},{w:"Schmetterling",tr:"Kelebek"},{w:"Gef√§hrlich",tr:"Tehlikeli"},{w:"Entschuldigung",tr:"√ñz√ºr Dilerim"}],
  fr: [{w:"Bonjour",tr:"Merhaba"},{w:"Amour",tr:"A≈ük"},{w:"Voiture",tr:"Araba"},{w:"Maison",tr:"Ev"},{w:"Magnifique",tr:"Muhte≈üem"},{w:"Toujours",tr:"Her zaman"}],
  es: [{w:"Coraz√≥n",tr:"Kalp"},{w:"Amigo",tr:"Arkada≈ü"},{w:"Tiempo",tr:"Zaman"},{w:"Vida",tr:"Hayat"},{w:"Felicidad",tr:"Mutluluk"},{w:"Peligroso",tr:"Tehlikeli"}],
  it: [{w:"Ciao",tr:"Merhaba"},{w:"Grazie",tr:"Te≈üekk√ºrler"},{w:"Famiglia",tr:"Aile"},{w:"Piccolo",tr:"K√º√ß√ºk"},{w:"Mangiare",tr:"Yemek"},{w:"Dormire",tr:"Uyumak"}]
};

const setup = {
  mode: 'pron',
  lang: 'en',
  setMode: function(m) {
    this.mode = m;
    document.getElementById('btnModePron').className = `mode-btn ${m==='pron'?'active':''}`;
    document.getElementById('btnModeVocab').className = `mode-btn vocab ${m==='vocab'?'active':''}`;
  }
};

document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    setup.lang = btn.getAttribute('data-lang');
  }
});

// --- GAME ENGINE ---
const STATE = { IDLE:0, LISTENING:1, RESOLVING:2, PAUSED:3, END:4 };

const game = {
  state: STATE.IDLE,
  turn: 'A',
  words: [],
  idx: 0,
  scores: { A:0, B:0 }, // Anlƒ±k Puan
  setsWon: { A:0, B:0 }, // Kazanƒ±lan Setler
  passRights: { A:1, B:1 },
  varRights: { A:1, B:1 },
  names: { A:'A', B:'B' },
  wordsPlayedA: 0,
  wordsPlayedB: 0,
  activeMicId: null,
  watchdog: null,

  init: function() {
    const nA = document.getElementById('inpA').value.trim();
    const nB = document.getElementById('inpB').value.trim();
    if(!nA || !nB) { alert("L√ºtfen isimleri giriniz."); return; }
    
    this.names = { A:nA, B:nB };
    this.loadWords();
    this.scores = {A:0, B:0};
    this.setsWon = {A:0, B:0};
    this.resetSetMetrics();
    
    document.getElementById('lblA').innerText = nA;
    document.getElementById('lblB').innerText = nB;
    document.getElementById('setupModal').classList.add('hidden');
    
    this.turn = Math.random() > 0.5 ? 'A' : 'B';
    this.state = STATE.IDLE;
    this.render();
    this.autoSpeak();
  },

  resetSetMetrics: function() {
    this.passRights = {A:1, B:1};
    this.varRights = {A:1, B:1};
    this.wordsPlayedA = 0;
    this.wordsPlayedB = 0;
    this.scores = {A:0, B:0}; // Her set puanƒ± sƒ±fƒ±rdan ba≈ülar
  },

  loadWords: function() {
    let raw = DB[setup.lang] || DB.en;
    // B√ºy√ºk havuz olu≈ütur
    this.words = [...raw, ...raw, ...raw, ...raw].sort(()=>Math.random()-0.5);
    this.idx = 0;
  },

  action: function(type, p) {
    if (this.state !== STATE.IDLE) return;
    if (this.turn !== p) return;

    if (type === 'pass') this.usePass(p);
    else if (type === 'var') this.useVar(p);
    else if (type === 'mic') this.startListening(p);
  },

  usePass: function(p) {
    if (this.passRights[p] > 0) {
      this.passRights[p]--;
      this.idx++; // Yeni kelime
      if(this.idx >= this.words.length) this.loadWords();
      
      // Pas yapƒ±nca sƒ±ra DEƒûƒ∞≈ûMEZ, oyuncu yeni kelimeyi dener.
      // Ancak "oynanmƒ±≈ü kelime" sayƒ±sƒ± artmaz (hakkƒ±nƒ± kullanƒ±yor).
      this.render();
      this.autoSpeak();
    }
  },

  useVar: function(p) {
    if (this.varRights[p] > 0) {
      this.varRights[p]--;
      this.state = STATE.RESOLVING;
      // Hakem jokerinde +2 puan
      this.showOverlay(p, true, 100, this.words[this.idx].w, true);
    }
  },

  startListening: function(p) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("Tarayƒ±cƒ± desteklemiyor"); return; }

    this.state = STATE.LISTENING;
    this.updateControls(); // Kilit

    const btn = document.getElementById(`mic${p}`);
    btn.classList.add('listening');
    this.activeMicId = `mic${p}`;

    const rec = new SR();
    rec.lang = (setup.lang === 'en') ? 'en-US' : (setup.lang==='de'?'de-DE':(setup.lang==='fr'?'fr-FR':(setup.lang==='es'?'es-ES':'it-IT')));
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    this.watchdog = setTimeout(() => { rec.stop(); this.resetState(); }, 8000);

    rec.onresult = (e) => {
      clearTimeout(this.watchdog);
      const txt = e.results[0][0].transcript;
      this.checkAnswer(txt, p);
    };

    rec.onerror = () => { clearTimeout(this.watchdog); this.resetState(); };
    rec.onend = () => { /* Watchdog handles logic */ };
    rec.start();
  },

  checkAnswer: function(spoken, p) {
    if(this.activeMicId) {
      document.getElementById(this.activeMicId).classList.remove('listening');
      this.activeMicId = null;
    }

    const target = this.words[this.idx].w;
    const score = getBestMatchScore(target, spoken);
    const isCorrect = score >= 90; // %90 E≈ûƒ∞K
    
    this.state = STATE.RESOLVING;
    this.showOverlay(p, isCorrect, score, target);
  },

  showOverlay: function(p, isCorrect, score, target, isVar = false) {
    const el = document.getElementById(`ov${p}`);
    const title = el.querySelector('.res-title');
    const sub = el.querySelector('.res-sub');
    const badge = el.querySelector('.badge');

    el.classList.add('show');
    badge.innerText = isVar ? "HAKEM KARARI" : `%${score} BENZERLƒ∞K`;

    if (isCorrect) {
      title.innerText = "HARƒ∞KA!"; title.style.color = "var(--green)";
      let pts = 2; // Doƒüru +2
      sub.innerText = `+${pts} PUAN`;
      this.scores[p] += pts;
      badge.style.color = "var(--green)";
      // Doƒüruysa ses √ßal
      this.playSound('correct');
      setTimeout(() => this.finishRound(p), 1500);
    } else {
      title.innerText = "OLMADI"; title.style.color = "var(--red)";
      sub.innerText = `Doƒürusu: ${target}`;
      badge.style.color = "var(--red)";
      
      // Yanlƒ±≈ü: -1 Puan
      let pts = -1;
      // Skor 0'ƒ±n altƒ±na d√º≈ümesin (isteƒüe baƒülƒ±, ≈üimdilik d√º≈üs√ºn rekabet artsƒ±n)
      this.scores[p] += pts;
      
      this.playSound('wrong');
      // YANLI≈ûTA TEKRAR OKUMA YOK
      setTimeout(() => this.finishRound(p), 2000);
    }
  },

  finishRound: function(p) {
    document.querySelectorAll('.result-overlay').forEach(el => el.classList.remove('show'));
    
    // ƒ∞statistik g√ºncelle
    if (p === 'A') this.wordsPlayedA++;
    else this.wordsPlayedB++;

    // Set Kontrol√º: ƒ∞kisi de 20 kelime oynadƒ± mƒ±?
    if (this.wordsPlayedA >= 20 && this.wordsPlayedB >= 20) {
      this.endSet();
    } else {
      this.nextTurn();
    }
  },

  nextTurn: function() {
    this.idx++;
    if(this.idx >= this.words.length) { this.loadWords(); this.idx = 0; }
    
    this.turn = (this.turn === 'A') ? 'B' : 'A';
    this.resetState();
    this.autoSpeak();
  },

  resetState: function() {
    clearTimeout(this.watchdog);
    if(this.activeMicId) document.getElementById(this.activeMicId).classList.remove('listening');
    this.state = STATE.IDLE;
    this.render();
  },

  autoSpeak: function() {
    // Sadece sƒ±rasƒ± gelene kelimeyi bir kere okut
    const item = this.words[this.idx];
    if(item) this.speak(item.w);
  },

  render: function() {
    // Zone Aktifliƒüi
    const zA = document.getElementById('zoneA');
    const zB = document.getElementById('zoneB');
    if (this.turn === 'A') { zA.classList.add('active'); zB.classList.remove('active'); }
    else { zB.classList.add('active'); zA.classList.remove('active'); }

    // Kelimeler
    const item = this.words[this.idx];
    const wA = document.getElementById('wA'); const mA = document.getElementById('mA');
    const wB = document.getElementById('wB'); const mB = document.getElementById('mB');

    if (setup.mode === 'pron') {
      wA.innerText = item.w; mA.innerText = item.tr;
      wB.innerText = item.w; mB.innerText = item.tr;
    } else {
      wA.innerText = item.tr; mA.innerText = "???";
      wB.innerText = item.tr; mB.innerText = "???";
    }

    // Skorlar
    document.getElementById('sA').innerText = this.scores.A;
    document.getElementById('sB').innerText = this.scores.B;
    
    // Set Skorlarƒ±
    document.getElementById('setA').innerText = `SET: ${this.setsWon.A}`;
    document.getElementById('setB').innerText = `SET: ${this.setsWon.B}`;

    // Buton Metinleri (Haklar)
    document.getElementById('passA').innerText = `PAS (${this.passRights.A})`;
    document.getElementById('passB').innerText = `PAS (${this.passRights.B})`;
    document.getElementById('varA').innerText = `HAKEM (${this.varRights.A})`;
    document.getElementById('varB').innerText = `HAKEM (${this.varRights.B})`;

    this.updateControls();
  },

  updateControls: function() {
    const allBtns = document.querySelectorAll('.btn');
    
    if (this.state !== STATE.IDLE) {
      allBtns.forEach(b => b.disabled = true);
      return;
    }

    allBtns.forEach(b => b.disabled = true); // Reset

    const p = this.turn;
    document.getElementById(`mic${p}`).disabled = false;
    
    // Hak varsa a√ß
    if (this.passRights[p] > 0) document.getElementById(`pass${p}`).disabled = false;
    if (this.varRights[p] > 0) document.getElementById(`var${p}`).disabled = false;
  },

  speak: function(txt) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    const langMap = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    u.lang = langMap[setup.lang];
    window.speechSynthesis.speak(u);
  },

  playSound: function(type) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    
    if (type === 'correct') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(600, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.5);
      osc.start(); osc.stop(ctx.currentTime+0.5);
    } else {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.3);
      osc.start(); osc.stop(ctx.currentTime+0.3);
    }
  },

  endSet: function() {
    this.state = STATE.PAUSED;
    
    // Set Kazananƒ±
    let winner = null;
    if (this.scores.A > this.scores.B) { winner = 'A'; this.setsWon.A++; }
    else if (this.scores.B > this.scores.A) { winner = 'B'; this.setsWon.B++; }
    
    // Ma√ß Bitti mi? (Best of 5 -> 3 alan kazanƒ±r)
    if (this.setsWon.A === 3 || this.setsWon.B === 3) {
      this.endGame(this.setsWon.A === 3 ? 'A' : 'B');
      return;
    }

    document.getElementById('pauseModal').classList.remove('hidden');
    document.getElementById('pauseTitle').innerText = "SET SONUCU";
    document.getElementById('statNameA').innerText = this.names.A;
    document.getElementById('statScoreA').innerText = `${this.scores.A} Puan`;
    document.getElementById('statNameB').innerText = this.names.B;
    document.getElementById('statScoreB').innerText = `${this.scores.B} Puan`;
    
    const msgEl = document.getElementById('setWinnerMsg');
    if (winner) {
      msgEl.innerText = `${this.names[winner]} SETƒ∞ KAZANDI!`;
      msgEl.style.color = (winner==='A' ? 'var(--pA)' : 'var(--pB)');
    } else {
      msgEl.innerText = "SET BERABERE!";
      msgEl.style.color = "#fff";
    }
  },

  endGame: function(winner) {
    document.getElementById('pauseModal').classList.remove('hidden');
    document.getElementById('pauseTitle').innerText = "≈ûAMPƒ∞YON!";
    document.getElementById('setWinnerMsg').innerText = `${this.names[winner]} MA√áI KAZANDI!`;
    document.getElementById('setWinnerMsg').style.fontSize = "32px";
    
    // Butonu deƒüi≈ütir
    const btn = document.getElementById('btnContinue');
    btn.innerText = "YENƒ∞ MA√á";
    btn.onclick = () => location.reload();
  },

  continueGame: function() {
    document.getElementById('pauseModal').classList.add('hidden');
    this.resetSetMetrics();
    this.state = STATE.IDLE;
    this.render();
    this.autoSpeak();
  }
};
</script>
</body>
</html>
