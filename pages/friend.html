<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY â€¢ Friend Arena Eternal</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-deep: #020205; 
      --text-main: #ffffff;
      --c-p1: #00f3ff; 
      --c-p2: #ff0066; 
      --c-green: #00e676;
      --c-red: #ff1744;
      --c-gold: #ffb800;
      --border: rgba(255, 255, 255, 0.1);
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); position:fixed; }

    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.3; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; }
    
    .wrap { 
      width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; 
      padding-top: var(--safe-top); padding-bottom: var(--safe-bottom);
    }

    .game-logo-header { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; padding-top: 10px; margin-bottom: 5px; }
    .gl-title { font-family: 'Space Grotesk', sans-serif; font-weight: 900; font-size: 22px; background: linear-gradient(to right, var(--c-p1), var(--c-p2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }

    .grid { flex:1; display:grid; grid-template-rows: 1fr 60px 1fr; gap:8px; padding:0 10px 10px; overflow:hidden; }

    .pane {
      position:relative; border-radius:20px; border:1px solid var(--border);
      background: rgba(255,255,255,0.03); backdrop-filter:blur(10px);
      display:flex; flex-direction:column; overflow:hidden; transition: 0.3s;
    }
    #paneA.active { border-color:var(--c-p1); box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); }
    #paneB.active { border-color:var(--c-p2); box-shadow: 0 0 30px rgba(255, 0, 102, 0.2); }

    #paneB { transform: rotate(180deg); }
    #paneB > * { transform: rotate(180deg); } 

    .bar { flex:0 0 40px; padding:0 12px; background:rgba(0,0,0,0.3); display:flex; justify-content:space-between; align-items:center; font-size:13px; }
    .p-score { font-weight:800; color: var(--c-p1); }
    #paneB .p-score { color: var(--c-p2); }

    .body { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:2px; padding:10px; text-align:center; }
    .word { font-size: 32px; font-weight:800; font-family:'Space Grotesk'; }
    .meaning { font-size: 16px; opacity: 0.6; }

    .actions { flex:0 0 60px; padding:8px; display:flex; gap:8px; }
    .mic-btn { flex:2; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:#fff; font-weight:700; cursor:pointer; }
    .mic-btn.active-mic { background: var(--c-p1); color: #000; }
    #paneB .mic-btn.active-mic { background: var(--c-p2); color: #fff; }
    .pass-btn { flex:1; border-radius:12px; border:1px solid var(--border); background:transparent; color:rgba(255,255,255,0.5); font-weight:700; cursor:pointer; }

    .wave-box { border-radius:16px; background:rgba(0,0,0,0.6); border:1px solid var(--border); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; }
    .wave-status { font-size:10px; font-weight:700; letter-spacing:1px; color:var(--c-p1); }

    .result-overlay { position:absolute; inset:0; z-index:20; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(8px); text-align:center; }
    .result-overlay.show { display:flex; }
    .res-text { font-size:24px; font-weight:900; text-transform:uppercase; }
    .success .res-text { color: var(--c-green); }
    .error .res-text { color: var(--c-red); }

    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.95); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(20px); }
    .modal-card { width:90%; max-width:340px; background:#101014; border:1px solid var(--border); border-radius:24px; padding:24px; text-align:center; }
    .mode-btn { width:100%; padding:16px; border-radius:16px; border:none; margin-bottom:10px; font-weight:800; font-size:15px; cursor:pointer; }
    .mode-pronounce { background: var(--c-p1); color:#000; }
    .mode-vocab { background: var(--c-p2); color:#fff; }

    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; }
    .lang-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 8px; padding: 10px 0; cursor: pointer; font-size: 20px; }
    .lang-btn.active { background: var(--c-p1); color: #000; border-color: var(--c-p1); }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>

  <div class="wrap">
    <div class="game-logo-header">
      <div class="gl-title">FRIEND ARENA</div>
    </div>

    <div class="grid">
      <section class="pane top" id="paneB">
        <div class="bar">
          <div class="p-name">OYUNCU B</div>
          <div class="p-score" id="scoreB">SET: 0</div>
        </div>
        <div class="body">
          <div class="word" id="wordB">---</div>
          <div class="meaning" id="meanB">---</div>
        </div>
        <div class="actions">
          <button class="pass-btn" id="passB" disabled>PAS</button>
          <button class="mic-btn" id="micB" disabled>ğŸ™ï¸ CEVAPLA</button>
        </div>
        <div class="result-overlay" id="ovB"></div>
      </section>

      <div class="wave-box" id="waveBox">
        <div class="wave-status" id="waveStatus">HAZIR</div>
      </div>

      <section class="pane" id="paneA">
        <div class="bar">
          <div class="p-name">OYUNCU A</div>
          <div class="p-score" id="scoreA">SET: 0</div>
        </div>
        <div class="body">
          <div class="word" id="wordA">---</div>
          <div class="meaning" id="meanA">---</div>
        </div>
        <div class="actions">
          <button class="pass-btn" id="passA" disabled>PAS</button>
          <button class="mic-btn" id="micA" disabled>ğŸ™ï¸ CEVAPLA</button>
        </div>
        <div class="result-overlay" id="ovA"></div>
      </section>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="color:var(--c-p1)">ARENA BOOT</h2>
      <div class="lang-grid">
        <div class="lang-btn active" data-lang="en">ğŸ‡¬ğŸ‡§</div>
        <div class="lang-btn" data-lang="de">ğŸ‡©ğŸ‡ª</div>
        <div class="lang-btn" data-lang="fr">ğŸ‡«ğŸ‡·</div>
        <div class="lang-btn" data-lang="es">ğŸ‡ªğŸ‡¸</div>
        <div class="lang-btn" data-lang="it">ğŸ‡®ğŸ‡¹</div>
      </div>
      <button class="mode-btn mode-pronounce" id="btnPron">TELAFFUZ LÄ°GÄ°</button>
      <button class="mode-btn mode-vocab" id="btnVocab">KELÄ°ME LÄ°GÄ°</button>
    </div>
  </div>

  <div class="modal-wrap hidden" id="setModal">
    <div class="modal-card">
      <h2 id="setTitle">SET BÄ°TTÄ°</h2>
      <p id="setResult"></p>
      <button class="mode-btn mode-pronounce" id="nextSetBtn">DEVAM ET</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);

let currentLang = 'en';
let gameMode = "pronunciation";
let wordPool = [];
let usedWords = null;
let wordList = [];
let idx = 0;
let turn = "A";
let isBusy = false;
let setsWon = { A:0, B:0 };
let setStats = { A:0, B:0 };

const LANG_CONFIG = {
  en: { code: 'en-US' }, de: { code: 'de-DE' },
  fr: { code: 'fr-FR' }, es: { code: 'es-ES' }, it: { code: 'it-IT' }
};

document.querySelectorAll(".lang-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentLang = btn.dataset.lang;
  };
});

$("btnPron").onclick = () => startArena("pronunciation");
$("btnVocab").onclick = () => startArena("vocabulary");

async function startArena(mode) {
  gameMode = mode;
  $("startModal").classList.add("hidden");
  
  const data = await loadLangPool(currentLang);
  const USED_KEY = `used_duo_${currentLang}`;
  const usedHelper = createUsedSet(USED_KEY);
  usedWords = usedHelper;

  // Havuz Ã§ekimi
  wordPool = pick(data, 50, usedHelper.used, usedHelper.save);

  // Eternal GÃ¼venliÄŸi
  if(!wordPool || wordPool.length < 20) {
    localStorage.removeItem(USED_KEY);
    location.reload();
  }

  startSet();
}

function startSet() {
  idx = 0;
  setStats = { A:0, B:0 };
  // Her set baÅŸÄ± havuzdan 10 benzersiz kelime Ã§ek
  wordList = wordPool.splice(0, 10);
  
  // EÄŸer havuzda kelime azaldÄ±ysa (Eternal DÃ¶ngÃ¼)
  if(wordPool.length < 10) {
    localStorage.removeItem(`used_duo_${currentLang}`);
  }

  renderWord();
  updateUI();
}

function renderWord() {
  const w = wordList[idx];
  if(!w) return;

  const showMeaning = gameMode === "pronunciation";
  $("wordA").textContent = w.w; $("meanA").textContent = showMeaning ? w.tr : "???";
  $("wordB").textContent = w.w; $("meanB").textContent = showMeaning ? w.tr : "???";
}

function updateUI() {
  $("scoreA").textContent = `SET: ${setsWon.A} | DOÄRU: ${setStats.A}`;
  $("scoreB").textContent = `SET: ${setsWon.B} | DOÄRU: ${setStats.B}`;

  $("paneA").classList.toggle("active", turn === "A");
  $("paneB").classList.toggle("active", turn === "B");
  $("micA").classList.toggle("active-mic", turn === "A");
  $("micB").classList.toggle("active-mic", turn === "B");
  
  $("micA").disabled = turn !== "A"; $("passA").disabled = turn !== "A";
  $("micB").disabled = turn !== "B"; $("passB").disabled = turn !== "B";
  
  $("waveStatus").textContent = `SIRA: OYUNCU ${turn}`;
}

async function handleAnswer(player, spoken) {
  if(isBusy) return;
  isBusy = true;
  
  const w = wordList[idx];
  const target = gameMode === "pronunciation" ? w.w : w.tr;
  
  const isCorrect = spoken.toLowerCase().includes(target.toLowerCase()) || 
                    target.toLowerCase().includes(spoken.toLowerCase());

  if(isCorrect) {
    setStats[player]++;
    showResult(player, "success", "HARÄ°KA!", "+10 PUAN");
    await speak(w.w);
    setTimeout(nextTurn, 1200);
  } else {
    showResult(player, "error", "YANLIÅ!", `DoÄŸrusu: ${target}`);
    await speak(w.w);
    setTimeout(nextTurn, 2500);
  }
}

function nextTurn() {
  idx++;
  turn = turn === "A" ? "B" : "A";
  isBusy = false;
  
  if(idx >= wordList.length) {
    finishSet();
  } else {
    renderWord();
    updateUI();
  }
}

function finishSet() {
  const win = setStats.A > setStats.B ? "A" : (setStats.B > setStats.A ? "B" : "BERABERE");
  if(win !== "BERABERE") setsWon[win]++;

  $("setModal").classList.remove("hidden");
  $("setTitle").textContent = win === "BERABERE" ? "BERABERE!" : `OYUNCU ${win} KAZANDI`;
  $("setResult").textContent = `A: ${setStats.A} - B: ${setStats.B}`;
}

$("nextSetBtn").onclick = () => {
  $("setModal").classList.add("hidden");
  startSet();
};

$("passA").onclick = () => nextTurn();
$("passB").onclick = () => nextTurn();

// STT Entegrasyonu
function listen(player) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return;
  const rec = new SR();
  rec.lang = gameMode === "vocabulary" ? "tr-TR" : LANG_CONFIG[currentLang].code;
  
  $("waveStatus").textContent = "DÄ°NLÄ°YOR...";
  rec.start();
  
  rec.onresult = (e) => {
    const text = e.results[0][0].transcript;
    handleAnswer(player, text);
  };
}

$("micA").onclick = () => listen("A");
$("micB").onclick = () => listen("B");

function showResult(player, type, title, sub) {
  const ov = $(player === "A" ? "ovA" : "ovB");
  ov.className = `result-overlay show ${type}`;
  ov.innerHTML = `<div class="res-text">${title}</div><div style="font-size:14px">${sub}</div>`;
  setTimeout(() => ov.classList.remove("show"), 2000);
}

function speak(txt) {
  return new Promise(res => {
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = LANG_CONFIG[currentLang].code;
    u.onend = res;
    window.speechSynthesis.speak(u);
  });
}
</script>
</body>
</html>
