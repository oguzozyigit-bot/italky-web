<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Arena Final V25</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030305;
      --border: rgba(255,255,255,0.12);
      --p0: #00f0ff; --p1: #ff0055; --p2: #00e676; --p3: #ffd700;
      --green: #00e676; --red: #ff1744; --gold: #ffd700;
      --font-main: 'Outfit', sans-serif;
      --font-display: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: var(--font-main); color: #fff; overflow: hidden; position: fixed; }

    /* ARKA PLAN */
    .bg-fx { position: absolute; inset: 0; z-index: 0; background: radial-gradient(circle at 50% 50%, #0a0a12 0%, #000 100%); }
    .nebula { position: absolute; width: 100%; height: 100%; filter: blur(90px); opacity: 0.15; animation: pulseBg 10s infinite alternate; }
    @keyframes pulseBg { 0% { opacity: 0.1; } 100% { opacity: 0.2; } }

    /* HEADER */
    .app-header { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; pointer-events: none; }
    .header-logo { font-family: var(--font-display); font-weight: 700; font-size: 18px; opacity: 0.8; pointer-events: auto; }
    .header-back { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: rgba(255,255,255,0.1); text-decoration: none; color: #fff; font-size: 18px; pointer-events: auto; border: 1px solid rgba(255,255,255,0.1); }

    /* OYUN ALANI */
    .arena-wrap { position: relative; z-index: 10; width: 100%; height: 100dvh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    .active-card-container {
      width: 90%; max-width: 380px; height: 65%;
      position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 30px;
      backdrop-filter: blur(12px); padding: 20px;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    
    /* Oyuncu Renkleri */
    .active-card-container.p0 { border-color: var(--p0); box-shadow: 0 0 40px rgba(0, 240, 255, 0.15); }
    .active-card-container.p1 { border-color: var(--p1); box-shadow: 0 0 40px rgba(255, 0, 85, 0.15); }
    .active-card-container.p2 { border-color: var(--p2); box-shadow: 0 0 40px rgba(0, 230, 118, 0.15); }
    .active-card-container.p3 { border-color: var(--p3); box-shadow: 0 0 40px rgba(255, 215, 0, 0.15); }

    .player-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .player-name { font-family: var(--font-display); font-size: 22px; font-weight: 700; text-transform: uppercase; }
    .turn-badge { font-size: 12px; font-weight: 800; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; letter-spacing: 1px; }

    .word-display { text-align: center; margin-bottom: 30px; width: 100%; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .main-word { font-family: var(--font-display); font-size: 40px; font-weight: 700; line-height: 1.1; margin-bottom: 5px; }
    .sub-word { font-size: 18px; color: rgba(255,255,255,0.6); font-weight: 500; min-height: 24px; }
    .letter-slots { font-family: monospace; font-size: 32px; letter-spacing: 4px; color: var(--gold); margin-top: 15px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    .hint-info { font-size: 10px; opacity: 0.5; margin-top: 5px; letter-spacing: 1px; }

    .controls { display: flex; gap: 10px; width: 100%; margin-top: auto; height: 60px; }
    .btn { border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: #fff; border-radius: 16px; font-family: var(--font-display); font-weight: 700; font-size: 13px; cursor: pointer; flex: 1; transition: 0.15s; }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    
    .btn-mic { flex: 2; background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); font-size: 15px; }
    .btn.listening { background: #fff !important; color: #000 !important; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 100% { box-shadow: 0 0 0 15px rgba(255,255,255,0); } }

    .btn-hint { flex: 0.7; color: #00e676; border-color: rgba(0, 230, 118, 0.3); background: rgba(0, 230, 118, 0.05); }

    /* ALT SKOR BANDI */
    .bottom-bar {
      position: absolute; bottom: 20px; left: 10px; right: 10px; height: 70px;
      background: #080808; border: 1px solid var(--border); border-radius: 20px;
      display: flex; align-items: center; justify-content: space-around; padding: 0 5px; z-index: 20;
    }
    .mini-score { display: flex; flex-direction: column; align-items: center; opacity: 0.4; transition: 0.3s; transform: scale(0.9); }
    .mini-score.active { opacity: 1; transform: scale(1.1); }
    .ms-name { font-size: 9px; font-weight: 700; margin-bottom: 3px; text-transform: uppercase; }
    .ms-val { font-family: var(--font-display); font-size: 18px; font-weight: 700; line-height: 1; }
    .ms-sets { font-size: 8px; color: var(--gold); font-weight: 700; margin-top: 2px; }

    /* OVERLAY */
    .result-overlay { position: absolute; inset: -1px; z-index: 50; background: rgba(5, 5, 8, 0.98); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 30px; opacity: 0; pointer-events: none; transform: scale(0.95); transition: 0.25s; }
    .result-overlay.show { opacity: 1; transform: scale(1); pointer-events: auto; }
    
    .res-title { font-size: 40px; font-weight: 800; font-family: var(--font-display); margin:0; line-height:1; }
    .res-sub { margin-top: 10px; font-size: 16px; color:#ccc; margin-bottom: 25px; }
    
    .overlay-actions { display: flex; gap: 10px; width: 85%; }
    .btn-var-action { padding: 16px; border-radius: 12px; font-weight: 800; flex: 1; border: none; cursor: pointer; font-size: 14px; }
    .btn-object { background: var(--gold); color: #000; box-shadow: 0 0 25px rgba(255, 215, 0, 0.25); }
    .btn-continue { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .badge { margin-top: 15px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.1); }

    /* MODAL */
    .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-box { width: 90%; max-width: 360px; background: #121216; border: 1px solid var(--border); border-radius: 32px; padding: 30px; text-align: center; max-height: 90vh; overflow-y: auto; }
    
    .toggle-grp { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .toggle-btn { flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 700; opacity: 0.6; transition: 0.2s; }
    .toggle-btn.active { background: #fff; color: #000; opacity: 1; }
    
    .btn-block { width: 100%; padding: 18px; margin-top: 10px; border-radius: 16px; border: none; font-weight: 800; font-size: 16px; cursor: pointer; background: #fff; color: #000; }
    .name-input { width: 100%; background: #1a1a20; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 10px; font-family: var(--font-main); font-weight: 600; text-align: center; margin-bottom: 8px; }
    
    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
    .lang-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; border-radius: 12px; padding: 10px 0; font-size: 20px; cursor: pointer; }
    .lang-btn.active { background: #fff; color: #000; }
  </style>
</head>
<body>

  <div class="bg-fx"></div>
  <div class="nebula" style="background:var(--p0); top:-20%; left:-20%;"></div>

  <div class="app-header">
    <a href="game.html" class="header-back">‚úï</a>
    <div class="header-logo">italkyAI</div>
    <div style="width:36px"></div>
  </div>

  <div class="arena-wrap">
    <div class="active-card-container" id="gameCard">
      
      <div class="result-overlay" id="overlay">
        <div class="res-title" id="ovTitle">OLMADI</div>
        <div class="res-sub" id="ovSub">...</div>
        
        <div class="overlay-actions" id="varActions" style="display:none">
          <button class="btn-var-action btn-object" onclick="game.varObjection()">ƒ∞Tƒ∞RAZ (VAR)</button>
          <button class="btn-var-action btn-continue" onclick="game.varContinue()">DEVAM ET</button>
        </div>
        <div class="badge" id="ovBadge" style="display:none"></div>
      </div>
      
      <div class="player-header">
        <div class="player-name" id="pName">OYUNCU</div>
        <div class="turn-badge" id="pCounter">0/20</div>
      </div>

      <div class="word-display">
        <div class="main-word" id="wMain">...</div>
        <div class="sub-word" id="wSub">...</div>
        <div class="letter-slots" id="wSlots" style="display:none">_ _ _ _ _</div>
        <div class="hint-info" id="wHintInfo" style="display:none"></div>
      </div>

      <div class="controls">
        <button class="btn btn-hint" id="btnHint" onclick="game.action('hint')" style="display:none">HARF (5)</button>
        <button class="btn" id="btnPass" onclick="game.action('pass')">PAS (1)</button>
        <button class="btn btn-mic" id="btnMic" onclick="game.action('mic')">üéôÔ∏è CEVAPLA</button>
      </div>
    </div>
  </div>

  <div class="bottom-bar" id="scoreBar"></div>

  <div class="modal" id="setupModal">
    <div class="modal-box">
      <div class="header-logo" style="font-size:24px; margin-bottom:20px;">CHAMPIONSHIP</div>
      
      <div style="font-size:12px; opacity:0.6; margin-bottom:5px">OYUNCU SAYISI</div>
      <div class="toggle-grp">
        <div class="toggle-btn active" onclick="setup.setPlayers(2)" id="pl2">2 Ki≈üi</div>
        <div class="toggle-btn" onclick="setup.setPlayers(3)" id="pl3">3 Ki≈üi</div>
        <div class="toggle-btn" onclick="setup.setPlayers(4)" id="pl4">4 Ki≈üi</div>
      </div>

      <div id="nameInputs">
        <input type="text" class="name-input" id="inp0" placeholder="Oyuncu 1 Adƒ±" value="Oyuncu 1" style="border-color:var(--p0)">
        <input type="text" class="name-input" id="inp1" placeholder="Oyuncu 2 Adƒ±" value="Oyuncu 2" style="border-color:var(--p1)">
      </div>

      <div style="font-size:12px; opacity:0.6; margin:15px 0 5px">Dƒ∞L & MOD</div>
      <div class="lang-grid">
        <button class="lang-btn active" data-lang="en">üá¨üáß</button>
        <button class="lang-btn" data-lang="de">üá©üá™</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑</button>
        <button class="lang-btn" data-lang="es">üá™üá∏</button>
        <button class="lang-btn" data-lang="it">üáÆüáπ</button>
      </div>

      <div class="toggle-grp">
        <div class="toggle-btn active" onclick="setup.setMode('pron')" id="modPron">üéôÔ∏è Telaffuz</div>
        <div class="toggle-btn" onclick="setup.setMode('vocab')" id="modVocab">üß† Kelime</div>
      </div>

      <button class="btn-block" onclick="game.init()">BA≈ûLA (3 SET)</button>
    </div>
  </div>

  <div class="modal hidden" id="pauseModal">
    <div class="modal-box">
      <div style="font-family:var(--font-display); font-weight:700; font-size:20px; margin-bottom:15px; color:#fff;" id="pauseTitle">SET SONUCU</div>
      <div id="setStats" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:20px; text-align:left;"></div>
      <div style="font-size:20px; font-weight:800; color:var(--gold); margin-bottom:20px;" id="setWinnerMsg">...</div>
      <button class="btn-block" style="background:var(--green); color:#000" id="btnContinue" onclick="game.continueGame()">DEVAM ET</button>
    </div>
  </div>

<script>
// --- UTILS ---
function normalize(str) { return str.toLowerCase().replace(/√ü/g, "ss").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9 ]/g, "").trim(); }

function getBestMatchScore(target, spoken) {
  const normTarget = normalize(target);
  const normSpoken = normalize(spoken);
  if (normSpoken.includes(normTarget)) return 100;
  let bestScore = similarity(normTarget, normSpoken);
  normSpoken.split(" ").forEach(w => {
    const score = similarity(normTarget, w);
    if (score > bestScore) bestScore = score;
  });
  return Math.floor(bestScore * 100);
}

function similarity(s1, s2) {
  let longer = s1, shorter = s2;
  if (s1.length < s2.length) { longer = s2; shorter = s1; }
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
  const costs = new Array();
  for (let i = 0; i <= s1.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else if (j > 0) {
        let newValue = costs[j - 1];
        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

// --- DATA ---
const DB = {
  en: [{w:"Excellent",tr:"M√ºkemmel"},{w:"Challenge",tr:"Meydan Okuma"},{w:"Opportunity",tr:"Fƒ±rsat"},{w:"Journey",tr:"Yolculuk"},{w:"Environment",tr:"√áevre"},{w:"Necessary",tr:"Gerekli"},{w:"Dangerous",tr:"Tehlikeli"},{w:"Knowledge",tr:"Bilgi"},{w:"Experience",tr:"Deneyim"},{w:"Incredible",tr:"ƒ∞nanƒ±lmaz"},{w:"Understand",tr:"Anlamak"},{w:"Remember",tr:"Hatƒ±rlamak"},{w:"Solution",tr:"√á√∂z√ºm"},{w:"Together",tr:"Birlikte"},{w:"Success",tr:"Ba≈üarƒ±"},{w:"Future",tr:"Gelecek"},{w:"Freedom",tr:"√ñzg√ºrl√ºk"},{w:"Victory",tr:"Zafer"},{w:"Quality",tr:"Kalite"},{w:"Ambition",tr:"Hƒ±rs"}],
  de: [{w:"Entscheidung",tr:"Karar"},{w:"M√∂glichkeit",tr:"ƒ∞mkan"},{w:"Erfahrung",tr:"Deneyim"},{w:"Nat√ºrlich",tr:"Doƒüal"},{w:"Wichtig",tr:"√ñnemli"},{w:"Zusammen",tr:"Birlikte"},{w:"Schmetterling",tr:"Kelebek"},{w:"Gef√§hrlich",tr:"Tehlikeli"},{w:"Entschuldigung",tr:"√ñz√ºr Dilerim"}],
  fr: [{w:"Bonjour",tr:"Merhaba"},{w:"Amour",tr:"A≈ük"},{w:"Voiture",tr:"Araba"},{w:"Maison",tr:"Ev"},{w:"Magnifique",tr:"Muhte≈üem"},{w:"Toujours",tr:"Her zaman"}],
  es: [{w:"Coraz√≥n",tr:"Kalp"},{w:"Amigo",tr:"Arkada≈ü"},{w:"Tiempo",tr:"Zaman"},{w:"Vida",tr:"Hayat"},{w:"Felicidad",tr:"Mutluluk"},{w:"Peligroso",tr:"Tehlikeli"}],
  it: [{w:"Ciao",tr:"Merhaba"},{w:"Grazie",tr:"Te≈üekk√ºrler"},{w:"Famiglia",tr:"Aile"},{w:"Piccolo",tr:"K√º√ß√ºk"},{w:"Mangiare",tr:"Yemek"},{w:"Dormire",tr:"Uyumak"}]
};

const LANG_CODES = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };

// --- SETUP ---
const setup = {
  playerCount: 2,
  mode: 'pron',
  lang: 'en',
  setPlayers: function(n) {
    this.playerCount = n;
    document.querySelectorAll('#setupModal .toggle-grp:first-of-type .toggle-btn').forEach((el,i) => {
      el.className = `toggle-btn ${i+2===n?'active':''}`;
    });
    const container = document.getElementById('nameInputs');
    container.innerHTML = '';
    const colors = ['var(--p0)', 'var(--p1)', 'var(--p2)', 'var(--p3)'];
    for(let i=0; i<n; i++) {
      container.innerHTML += `<input type="text" class="name-input" id="inp${i}" placeholder="Oyuncu ${i+1}" value="Oyuncu ${i+1}" style="border-color:${colors[i]}">`;
    }
  },
  setMode: function(m) {
    this.mode = m;
    document.getElementById('modPron').className = `toggle-btn ${m==='pron'?'active':''}`;
    document.getElementById('modVocab').className = `toggle-btn ${m==='vocab'?'active':''}`;
  }
};

document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    setup.lang = btn.getAttribute('data-lang');
  }
});

// --- GAME STATE MACHINE ---
const STATE = { IDLE:0, LISTENING:1, RESOLVING:2, SPEAKING:3 };

const game = {
  players: [],
  turnIndex: 0,
  words: [],
  usedWords: new Set(),
  idx: 0,
  state: STATE.IDLE,
  setNum: 1,
  activeMicId: null,
  
  init: function() {
    this.players = [];
    for(let i=0; i<setup.playerCount; i++) {
      const name = document.getElementById(`inp${i}`).value.trim() || `P${i+1}`;
      this.players.push({
        id: i, name: name, score: 0, setWins: 0,
        wordsPlayed: 0, passRight: 1, varRight: 1, hintRight: 5 // Joker Ma√ß Boyu
      });
    }
    this.loadWords();
    this.idx = 0;
    this.turnIndex = 0;
    this.usedWords.clear();
    
    document.getElementById('setupModal').classList.add('hidden');
    this.createScoreBar();
    this.startTurn();
  },

  loadWords: function() {
    let raw = DB[setup.lang] || DB.en;
    // Benzersiz kelime garantisi i√ßin havuzu geni≈ület
    this.words = [...raw, ...raw, ...raw, ...raw, ...raw].sort(()=>Math.random()-0.5);
  },

  createScoreBar: function() {
    const bar = document.getElementById('scoreBar');
    bar.innerHTML = '';
    this.players.forEach((p, i) => {
      bar.innerHTML += `
        <div class="mini-score" id="ms${i}">
          <div class="ms-name" style="color:var(--p${i})">${p.name}</div>
          <div class="ms-val" id="score${i}">0</div>
          <div class="ms-sets" id="sets${i}">SET: 0</div>
        </div>
      `;
    });
  },

  updateUI: function() {
    const p = this.players[this.turnIndex];
    const container = document.getElementById('gameCard');
    
    container.className = `active-card-container p${p.id}`;
    document.getElementById('pName').innerText = p.name;
    document.getElementById('pName').style.color = `var(--p${p.id})`;
    document.getElementById('pCounter').innerText = `${p.wordsPlayed}/20`;

    const item = this.words[this.idx];
    if (setup.mode === 'pron') {
      document.getElementById('wMain').innerText = item.w;
      document.getElementById('wSub').innerText = item.tr;
      document.getElementById('wSlots').style.display = 'none';
      document.getElementById('btnHint').style.display = 'none';
    } else {
      document.getElementById('wMain').innerText = item.tr;
      document.getElementById('wSub').innerText = "???";
      document.getElementById('wSlots').style.display = 'block';
      document.getElementById('btnHint').style.display = 'block';
      
      if (!p.tempSlots) {
        let slots = item.w.split('').map((l,i) => i===0 ? l : '_'); 
        p.tempSlots = slots;
        p.tempHintUsed = false;
      }
      document.getElementById('wSlots').innerText = p.tempSlots.join(' ');
      // Harf bilgisi
      let revealed = p.tempSlots.filter(x => x!=='_').length;
      document.getElementById('wHintInfo').innerText = `A√áILAN HARF: ${revealed}/${item.w.length}`;
    }

    document.getElementById('btnPass').innerText = `PAS (${p.passRight})`;
    document.getElementById('btnHint').innerText = `HARF (${p.hintRight})`;

    // BUTON VE Mƒ∞KROFON DURUMU (MERKEZƒ∞ Y√ñNETƒ∞M)
    const allBtns = document.querySelectorAll('.btn');
    const micBtn = document.getElementById('btnMic');

    if (this.state === STATE.LISTENING) {
      allBtns.forEach(b => b.disabled = true);
      micBtn.innerText = "üëÇ...";
      micBtn.classList.add('listening');
    } else if (this.state === STATE.SPEAKING || this.state === STATE.RESOLVING) {
      allBtns.forEach(b => b.disabled = true);
      micBtn.innerText = "üéôÔ∏è CEVAPLA";
      micBtn.classList.remove('listening');
    } else {
      // IDLE
      allBtns.forEach(b => b.disabled = true); // Reset
      micBtn.disabled = false;
      micBtn.innerText = "üéôÔ∏è CEVAPLA";
      micBtn.classList.remove('listening');
      if (p.passRight > 0) document.getElementById('btnPass').disabled = false;
      if (p.hintRight > 0) document.getElementById('btnHint').disabled = false;
    }
    
    // VAR Butonu overlayde, burada gizli
    document.getElementById('btnVar').style.display = 'none';

    this.players.forEach((pl, i) => {
      document.getElementById(`score${i}`).innerText = pl.score;
      document.getElementById(`sets${i}`).innerText = `SET: ${pl.setWins}`;
      document.getElementById(`ms${i}`).className = `mini-score ${i===this.turnIndex ? 'active' : ''}`;
    });
  },

  // isRetry: VAR sonrasƒ± aynƒ± kelimeyi tekrar sormak i√ßin
  startTurn: function(isRetry = false) {
    // Set Bitti mi?
    if (this.players.every(p => p.wordsPlayed >= 20)) {
      this.endSet();
      return;
    }
    // Sƒ±radaki oyuncu kotasƒ±nƒ± doldurduysa atla
    if (this.players[this.turnIndex].wordsPlayed >= 20) {
      this.nextPlayer();
      return;
    }

    // YENƒ∞ KELƒ∞ME (Eƒüer retry deƒüilse)
    if (!isRetry) {
      // Sonsuz d√∂ng√º korumasƒ±: Havuz dolduysa temizle
      if (this.usedWords.size >= this.words.length) {
        this.usedWords.clear();
      }

      let safety = 0;
      // Normalizasyon ile kelime kontrol√º
      while (this.usedWords.has(normalize(this.words[this.idx].w)) && safety < 1000) {
        this.idx = (this.idx + 1) % this.words.length;
        safety++;
      }
      this.usedWords.add(normalize(this.words[this.idx].w));

      // Temizlik
      delete this.players[this.turnIndex].tempSlots;
      delete this.players[this.turnIndex].tempHintUsed;
    }

    this.state = STATE.IDLE;
    this.updateUI();

    // Telaffuz liginde zorunlu okuma
    if (setup.mode === 'pron') {
      this.state = STATE.SPEAKING;
      this.updateUI(); // Kilit
      this.speak(this.words[this.idx].w, () => {
        this.state = STATE.IDLE;
        this.updateUI(); // A√ß
      });
    }
  },

  action: function(type) {
    if (this.state !== STATE.IDLE) return;
    const p = this.players[this.turnIndex];

    if (type === 'pass') {
      if (p.passRight > 0) {
        p.passRight--;
        // Pas: Yeni kelime, sƒ±ra deƒüi≈ümez, saya√ß ARTMAZ
        this.idx = (this.idx + 1) % this.words.length;
        this.startTurn(); // isRetry=false
      }
    } 
    else if (type === 'hint') {
      if (p.hintRight > 0) {
        p.hintRight--;
        this.revealLetter(p);
        p.tempHintUsed = true;
        this.updateUI();
      }
    }
    else if (type === 'mic') {
      this.listen();
    }
  },

  revealLetter: function(p) {
    const target = this.words[this.idx].w;
    for(let i=0; i<target.length; i++) {
      if (p.tempSlots[i] === '_') { p.tempSlots[i] = target[i]; break; }
    }
  },

  listen: function() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("Tarayƒ±cƒ± desteklemiyor"); return; }

    this.state = STATE.LISTENING;
    this.updateUI(); // UI g√ºncellenir (mic text deƒüi≈üir)

    const rec = new SR();
    rec.lang = LANG_CODES[setup.lang];
    rec.interimResults = false;

    rec.onresult = (e) => {
      const txt = e.results[0][0].transcript;
      this.check(txt);
    };
    rec.onerror = () => { this.state = STATE.IDLE; this.updateUI(); };
    rec.onend = () => { if(this.state === STATE.LISTENING) { this.state = STATE.IDLE; this.updateUI(); } };
    rec.start();
  },

  check: function(spoken) {
    const target = this.words[this.idx].w;
    const score = getBestMatchScore(target, spoken);
    const isCorrect = score >= 90;

    this.state = STATE.RESOLVING;
    this.updateUI();
    
    const p = this.players[this.turnIndex];
    const overlay = document.getElementById('overlay');
    const title = overlay.querySelector('.res-title');
    const sub = overlay.querySelector('.res-sub');
    const actions = document.getElementById('varActions');
    const badge = document.getElementById('ovBadge');

    overlay.classList.add('show');

    if (isCorrect) {
      actions.style.display = 'none';
      badge.style.display = 'block';
      title.innerText = "HARƒ∞KA!"; title.style.color = "var(--green)";
      
      let pts = (p.tempHintUsed) ? 1 : 2; 
      sub.innerText = `+${pts} PUAN`;
      badge.innerText = `%${score} BENZERLƒ∞K`;
      badge.style.color = "var(--green)";
      
      // DOƒûRU: ANINDA ƒ∞≈ûLE
      p.score += pts;
      p.wordsPlayed++; 
      
      this.playSound('correct');
      setTimeout(() => this.finishRound(true), 1500);
    } else {
      // YANLI≈û: VAR PENCERESƒ∞ (HEN√úZ PUAN D√ú≈ûME YOK)
      this.playSound('wrong');
      title.innerText = "OLMADI"; title.style.color = "var(--red)";
      sub.innerText = `Doƒürusu: ${target}`;
      
      if (p.varRight > 0) {
        actions.style.display = 'flex';
        badge.style.display = 'none';
        actions.querySelector('.btn-object').innerText = `ƒ∞Tƒ∞RAZ (VAR: ${p.varRight})`;
      } else {
        // VAR yoksa otomatik devam (Commit burada)
        actions.style.display = 'none';
        badge.style.display = 'block';
        badge.innerText = "Hatalƒ± Telaffuz";
        badge.style.color = "var(--red)";
        
        p.score = Math.max(0, p.score - 1); // Commit Score
        p.wordsPlayed++; // Commit Word
        setTimeout(() => this.finishRound(false), 2500);
      }
    }
  },

  varObjection: function() {
    const p = this.players[this.turnIndex];
    p.varRight--;
    
    document.getElementById('overlay').classList.remove('show');
    // AYNI KELƒ∞ME, PUAN D√ú≈ûMEDƒ∞, SAYA√á ARTMAYACAK (Already safe)
    this.startTurn(true); 
  },

  varContinue: function() {
    const p = this.players[this.turnIndex];
    // Kullanƒ±cƒ± kabul etti: COMMIT
    p.score = Math.max(0, p.score - 1);
    p.wordsPlayed++;
    
    document.getElementById('overlay').classList.remove('show');
    this.idx++;
    this.nextPlayer();
  },

  finishRound: function(correct) {
    document.getElementById('overlay').classList.remove('show');
    this.idx++;
    this.nextPlayer();
  },

  nextPlayer: function() {
    this.turnIndex = (this.turnIndex + 1) % this.players.length;
    this.startTurn(); // Yeni oyuncu, yeni kelime (isRetry=false)
  },

  speak: function(txt, cb) {
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = LANG_CODES[setup.lang];
    u.onend = cb;
    window.speechSynthesis.speak(u);
  },

  playSound: function(type) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    if(type==='correct'){
      osc.type='sine'; osc.frequency.setValueAtTime(600,ctx.currentTime);
      gain.gain.setValueAtTime(0.1,ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5);
      osc.start(); osc.stop(ctx.currentTime+0.5);
    } else {
      osc.type='sawtooth'; osc.frequency.setValueAtTime(150,ctx.currentTime);
      gain.gain.setValueAtTime(0.1,ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3);
      osc.start(); osc.stop(ctx.currentTime+0.3);
    }
  },

  endSet: function() {
    this.state = STATE.PAUSED;
    document.getElementById('pauseModal').classList.remove('hidden');
    
    // KOPYA Lƒ∞STE ƒ∞LE SIRALA
    let sorted = [...this.players].sort((a,b) => b.score - a.score);
    
    let winner = null;
    // Beraberlik Kontrol√º
    if (sorted.length > 1 && sorted[0].score > sorted[1].score) {
      winner = sorted[0];
      const realP = this.players.find(p => p.id === winner.id);
      realP.setWins++;
    } else if (sorted.length === 1) { // Single player debug
       winner = sorted[0];
       this.players[0].setWins++;
    }

    let html = '';
    sorted.forEach(p => {
      html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span style="color:var(--p${p.id})">${p.name}</span><b>${p.score}</b>
      </div>`;
    });
    document.getElementById('setStats').innerHTML = html;

    const msgEl = document.getElementById('setWinnerMsg');
    const btn = document.getElementById('btnContinue');

    // MA√á KAZANAN VAR MI?
    const matchWinner = this.players.find(p => p.setWins >= 3);

    if (matchWinner) {
      document.getElementById('pauseTitle').innerText = "≈ûAMPƒ∞YON!";
      msgEl.innerText = `${matchWinner.name} MA√áI KAZANDI!`;
      btn.innerText = "YENƒ∞ MA√á";
      btn.onclick = () => location.reload();
    } else if (winner) {
      msgEl.innerText = `${winner.name} SETƒ∞ KAZANDI!`;
      btn.innerText = "SONRAKƒ∞ SET";
      btn.onclick = () => game.continueGame();
    } else {
      msgEl.innerText = "SET BERABERE!";
      btn.innerText = "SONRAKƒ∞ SET";
      btn.onclick = () => game.continueGame();
    }
  },

  continueGame: function() {
    document.getElementById('pauseModal').classList.add('hidden');
    // Yeni Set: Puanlarƒ± ve Saya√ßlarƒ± Sƒ±fƒ±rla (Ma√ß haklarƒ± KALIR)
    this.players.forEach(p => {
      p.wordsPlayed = 0; p.score = 0; p.passRight = 1; p.varRight = 1; p.tempHintUsed=false;
    });
    this.usedWords.clear(); 
    this.idx = 0;
    this.state = STATE.IDLE;
    this.startTurn();
  }
};
</script>
</body>
</html>
