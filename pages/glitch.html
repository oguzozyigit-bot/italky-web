<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY â€¢ Glitch Hunter</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050505; --cyan:#00ffff; --pink:#ff0055; --green:#00ff66;
  --panel:rgba(20,20,20,.95); --border:rgba(0,255,255,.3); --text:#fff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:sans-serif;color:var(--text)}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;background:var(--panel);border:1px solid var(--border);display:flex;flex-direction:column;z-index:5}
@media(min-width:520px){.app{height:92vh;border-radius:20px;margin-top:4vh}}

.header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px; border-bottom:1px solid var(--border)}
.title{font-size:18px; color:var(--cyan); font-weight:bold;}

.game{flex:1;padding:16px;display:none;flex-direction:column;justify-content:space-between}
.stats{display:flex;justify-content:space-between;font-size:16px;color:var(--cyan);font-weight:bold;margin-bottom:10px}

/* âœ… KOCAMAN VE OKUNAKLI CÃœMLE */
.terminal{flex:1;border:2px solid var(--border);background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;position:relative;padding:20px;text-align:center;border-radius:14px}
.sentence{
  font-family:'Space Grotesk', sans-serif;
  font-size:32px;
  color:#fff;
  line-height:1.2;
  font-weight:900;
}

.controls{display:flex;gap:16px;height:120px;margin-top:20px}
.action{flex:1;border:3px solid var(--border);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:.15s; font-weight:bold;border-radius:12px;color:#fff}
.bug{background:rgba(255,0,85,0.2);border-color:var(--pink)}
.ok{background:rgba(0,255,102,0.2);border-color:var(--green)}
.action:active{transform:scale(.95)}
.action:disabled{opacity:.35;pointer-events:none}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:200}
.card{background:#111;border:1px solid var(--cyan);padding:30px;width:85%;text-align:center;border-radius:20px}
.mainbtn{width:100%;padding:18px;margin-top:20px;border:none;background:var(--cyan);color:#000;font-weight:900;cursor:pointer;font-size:18px;border-radius:10px}

.lang-btn{font-size:28px; padding:12px; background:rgba(255,255,255,0.1); border:2px solid #444; border-radius:12px; cursor:pointer; transition:0.2s}

.hidden{display:none!important}
.glitch-anim{animation:shake 0.3s}
@keyframes shake{
  0%, 100% {transform: translateX(0)}
  25% {transform: translateX(-10px) rotate(-1deg)}
  75% {transform: translateX(10px) rotate(1deg)}
}
</style>
</head>

<body>
<div class="app" id="frame">
  <div class="header">
    <div style="cursor:pointer; color:var(--cyan); font-size:24px" onclick="location.href='/pages/game.html'">â†</div>
    <div class="title">GLITCH HUNTER</div>
    <div id="scoreDisp" style="font-weight:bold; color:var(--green)">0</div>
  </div>

  <div class="game" id="game">
    <div class="stats">
      <span>CAN: <b id="life">100%</b></span>
      <span id="setCounter">1/12</span>
    </div>

    <!-- âœ… id eklendi: handleAnswer iÃ§inde $("terminal") kullanÄ±yorsun -->
    <div class="terminal" id="terminal">
      <div class="sentence" id="sentence">YÃœKLENÄ°YOR...</div>
    </div>

    <div class="controls">
      <button class="action bug" id="btnGlitch">ğŸ HATALI</button>
      <button class="action ok" id="btnStable">ğŸ›¡ï¸ DOÄRU</button>
    </div>
  </div>
</div>

<div class="modal" id="start">
  <div class="card">
    <h2 style="color:var(--cyan); font-size:24px">Oyun BaÅŸlÄ±yor</h2>
    <p style="opacity:.8;">CÃ¼mle doÄŸru mu yanlÄ±ÅŸ mÄ± seÃ§in.</p>

    <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:25px 0">
        <button data-lang="en" class="lang-btn" style="border-color:var(--cyan)">ğŸ‡¬ğŸ‡§</button>
        <button data-lang="de" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button data-lang="fr" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button data-lang="es" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button data-lang="it" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
    </div>

    <button class="mainbtn" id="startBtn">BAÅLA</button>
  </div>
</div>

<div class="modal hidden" id="end">
  <div class="card">
    <h2 id="endTitle" style="color:var(--green)">SET BÄ°TTÄ°</h2>
    <p id="endStats" style="font-size:22px; margin:20px 0"></p>
    <button class="mainbtn" id="btnContinue">DEVAM ET</button>
    <button class="mainbtn" style="background:#333;color:#fff" id="btnExit">Ã‡IKIÅ</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);

let lang="en", score=0, integrity=100, wordList=[], currentIndex=0, busy=false, currentItem=null;

const SET_SIZE = 12;
const DMG = 25;

function setButtonsDisabled(v){
  $("btnGlitch").disabled = v;
  $("btnStable").disabled = v;
}

// Dil SeÃ§imi
document.querySelectorAll(".lang-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang-btn").forEach(x=>x.style.borderColor="#444");
    b.style.borderColor="var(--cyan)";
    lang=b.dataset.lang;
  };
});

// BaÅŸlat
$("startBtn").onclick=async()=>{
  $("start").classList.add("hidden");
  $("game").style.display="flex";
  score=0; integrity=100;
  await initGame();
};

async function initGame() {
  currentIndex=0;
  busy=false;
  setButtonsDisabled(false);

  const pool = await loadLangPool(lang);
  const items = Array.isArray(pool?.items) ? pool.items : [];

  // GÃ¼venli karÄ±ÅŸtÄ±rma
  const randomizedItems = [...items].sort(() => Math.random() - 0.5);

  const USED_KEY = "glitch_v5_" + lang;
  const { used, save } = createUsedSet(USED_KEY);

  // pick -> 12 item al
  wordList = pick({items: randomizedItems}, SET_SIZE, used, save, (it)=> {
    // âœ… sentence zorunlu, yoksa Ã¼retilir (oyun takÄ±lmasÄ±n)
    const s = String(it?.sentence || "").trim();
    return !!s && s.length >= 6;
  });

  if(wordList.length < SET_SIZE) {
    // soft reset: anahtarÄ± temizle, tekrar dene
    localStorage.removeItem(USED_KEY);
    return initGame();
  }

  // âœ… used set gerÃ§ekten kaydedilsin
  try { save(wordList.map(x => x.w)); } catch(e){}

  nextRound();
}

// Hata Ãœretici (basit ve mantÄ±klÄ±)
function produceGlitch(original) {
  let text = String(original || "");
  const rules = [
    { f: " am ", t: " is " },
    { f: " are ", t: " is " },
    { f: " have ", t: " has " },
    { f: " don't ", t: " doesn't " },
    { f: " doesn't ", t: " don't " },
    { f: " a ", t: " an " },
  ];
  const lower = text.toLowerCase();
  const rule = rules.find(r => lower.includes(r.f));
  if(rule) {
    const reg = new RegExp(rule.f, "i");
    text = text.replace(reg, rule.t);
  } else {
    // Ã‡ok agresif olmasÄ±n diye ilk eÅŸleÅŸmeyi boz
    text = text.replace(/\bis\b/i, "are")
               .replace(/\bwas\b/i, "were")
               .replace(/\bs\b(?=\s)/, "");
  }
  return text;
}

function safeSentence(it){
  const w = String(it?.w || "something").trim();
  const s = String(it?.sentence || "").trim();
  return s || `I am studying ${w}.`;
}

function nextRound() {
  if(currentIndex >= wordList.length) { finish(false); return; }

  const item = wordList[currentIndex];
  const original = safeSentence(item);

  const isCorrectSentence = Math.random() > 0.5;
  const displayText = isCorrectSentence ? original : produceGlitch(original);

  currentItem = { text: displayText, original, isOk: isCorrectSentence };

  $("sentence").textContent = currentItem.text.toUpperCase();
  $("setCounter").textContent = `${currentIndex + 1}/${SET_SIZE}`;
  $("scoreDisp").textContent = score;
  $("life").textContent = integrity + "%";
  $("life").style.color = integrity <= 25 ? "var(--pink)" : "var(--cyan)";

  // terminal border reset
  $("terminal").style.borderColor = "var(--border)";

  busy=false;
  setButtonsDisabled(false);
}

function flashBorder(colorVar){
  $("terminal").style.borderColor = colorVar;
  setTimeout(()=> $("terminal").style.borderColor = "var(--border)", 450);
}

function handleAnswer(userPickStable) {
  if(busy) return;
  busy=true;
  setButtonsDisabled(true);

  const correct = (userPickStable === currentItem.isOk);

  if(correct) {
    score += 100;
    flashBorder("var(--green)");
  } else {
    integrity -= DMG;
    $("frame").classList.add("glitch-anim");
    flashBorder("var(--pink)");
    setTimeout(()=> $("frame").classList.remove("glitch-anim"), 320);
  }

  $("scoreDisp").textContent = score;
  $("life").textContent = Math.max(0, integrity) + "%";

  if(integrity <= 0) setTimeout(() => finish(true), 500);
  else setTimeout(() => { currentIndex++; nextRound(); }, 650);
}

$("btnGlitch").onclick = () => handleAnswer(false);
$("btnStable").onclick = () => handleAnswer(true);

function finish(died) {
  $("end").classList.remove("hidden");
  $("endTitle").textContent = died ? "SÄ°STEM Ã‡Ã–KTÃœ" : "TEBRÄ°KLER";
  $("endTitle").style.color = died ? "var(--pink)" : "var(--green)";
  $("endStats").innerHTML = `SKOR: <b>${score}</b>`;
  $("btnContinue").classList.toggle("hidden", died);
  busy=false;
  setButtonsDisabled(true);
}

$("btnContinue").onclick = () => {
  $("end").classList.add("hidden");
  initGame();
};

$("btnExit").onclick = () => location.reload();
</script>
</body>
</html>
