<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY â€¢ Glitch Hunter Eternal</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050505; --cyan:#00ffff; --pink:#ff0055; --green:#00ff66;
  --panel:rgba(10,20,20,.95); --border:rgba(0,255,255,.3); --text:#fff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Outfit', sans-serif;color:var(--text)}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;background:var(--panel);border:1px solid var(--border);display:flex;flex-direction:column;z-index:5}
@media(min-width:520px){.app{height:92vh;border-radius:24px;margin-top:4vh}}

.header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px; border-bottom:1px solid var(--border)}
.title{font-size:18px; color:var(--cyan); font-weight:900; letter-spacing:1px;}
.pb-badge{font-size:10px;padding:4px 8px;background:var(--cyan);color:#000;font-weight:800;border-radius:4px}

.game{flex:1;padding:16px;display:none;flex-direction:column;justify-content:space-between}
.stats{display:flex;justify-content:space-between;font-size:13px;color:var(--cyan);font-weight:bold;margin-bottom:10px}

.terminal{flex:1;border:2px solid var(--border);background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;padding:25px;text-align:center;border-radius:20px;transition: 0.3s;}
.sentence{font-size:28px; color:#fff; line-height:1.3; font-weight:700;}

#correctionBox{font-size:15px; color:var(--green); margin-top:15px; font-weight:bold; opacity:0; transition:0.3s; background: rgba(0,255,102,0.1); padding: 12px; border-radius: 10px; width: 100%; text-align: left;}
.tr-text { color: var(--cyan); font-style: italic; font-weight: 500; margin-top: 5px; display: block; }

.controls{display:flex;gap:12px;height:100px;margin-top:20px}
.action{flex:1;border:3px solid var(--border);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:.1s; font-weight:900;border-radius:16px;color:#fff; background: transparent;}
.bug{background:rgba(255,0,85,0.1);border-color:var(--pink); color: var(--pink)}
.ok{background:rgba(0,255,102,0.1);border-color:var(--green); color: var(--green)}
.action:active{transform:scale(.95)}
.action:disabled{opacity:0.2; pointer-events:none;}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.98);display:flex;align-items:center;justify-content:center;z-index:200}
.card{background:#0a0a0a;border:1px solid var(--cyan);padding:25px;width:90%;text-align:center;border-radius:28px; max-height: 90vh; overflow-y: auto;}
.mainbtn{width:100%;padding:18px;margin-top:10px;border:none;background:var(--cyan);color:#000;font-weight:900;cursor:pointer;font-size:18px;border-radius:14px}

.lang-grid{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:15px 0}
.lang-btn{font-size:26px; padding:10px 15px; background:rgba(255,255,255,0.05); border:2px solid #333; border-radius:12px; cursor:pointer; flex: 1 1 18%;}
.lang-btn.active{border-color:var(--cyan); background:rgba(0,243,255,0.1)}

.daily-card { background: linear-gradient(135deg, rgba(255,0,255,0.1), rgba(0,243,255,0.1)); border: 1px solid var(--pink); padding: 12px; border-radius: 15px; margin-bottom: 15px; }

.hidden{display:none!important}
.glitch-anim{animation:shake 0.3s}
@keyframes shake{ 0%, 100% {transform: translateX(0)} 25% {transform: translateX(-8px)} 75% {transform: translateX(8px)} }
</style>
</head>

<body>
<div class="app" id="frame">
  <div class="header">
    <div style="cursor:pointer; color:var(--cyan); font-size:24px" onclick="location.href='/pages/game.html'">â†</div>
    <div class="title">GLITCH HUNTER</div>
    <div id="pbBadge" class="pb-badge">PB: 0</div>
  </div>

  <div class="game" id="game">
    <div class="stats">
      <span>INTEGRITY: <b id="life">100%</b></span>
      <span>SCORE: <b id="scoreDisp" style="color:var(--green)">0</b></span>
      <span id="setCounter">1/12</span>
    </div>

    <div class="terminal" id="terminal">
      <div class="sentence" id="sentence">Initializing...</div>
      <div id="correctionBox">
        CORRECTION: <span id="correctTxt"></span>
        <span id="trTxt" class="tr-text"></span>
      </div>
    </div>

    <div class="controls">
      <button class="action bug" id="btnGlitch">ğŸ HATALI</button>
      <button class="action ok" id="btnStable">ğŸ›¡ï¸ DOÄRU</button>
    </div>
  </div>
</div>

<div class="modal" id="start">
  <div class="card">
    <h2 style="color:var(--cyan); font-size:24px; margin-bottom: 5px;">Cyber Boot Eternal</h2>

    <div class="daily-card" id="dailyCard">
        <div style="font-size:10px; color:var(--pink); font-weight:900; margin-bottom:3px;">ğŸ‘‘ BUGÃœNÃœN LÄ°DERÄ°</div>
        <div id="dailyInfo" style="font-size:14px; font-weight:800;">YÃ¼kleniyor...</div>
    </div>

    <div class="lang-grid">
        <button data-lang="en" class="lang-btn active">ğŸ‡¬ğŸ‡§</button>
        <button data-lang="de" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button data-lang="fr" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button data-lang="es" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button data-lang="it" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
    </div>

    <button class="mainbtn" id="startBtn">START MISSION</button>
    <div id="leaderboardBox" style="margin-top:20px; font-size:11px; text-align:left; color:rgba(255,255,255,0.5)"></div>
  </div>
</div>

<div class="modal hidden" id="end">
  <div class="card">
    <h2 id="endTitle" style="color:var(--green)">SECTOR CLEARED</h2>
    <p id="endStats" style="font-size:22px; margin:20px 0"></p>
    <button class="mainbtn" id="btnContinue">DEVAM ET (RÄ°SK)</button>
    <button class="mainbtn" id="btnBank" style="background:var(--pink); color:#fff">BANKALA (%5 BONUS + TAMÄ°R)</button>
    <button class="mainbtn" style="background:#222;color:#fff" id="btnExit">KAYDET VE Ã‡IK</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);

let lang="en", totalScore=0, setScore=0, integrity=100, wordList=[], currentIndex=0, busy=false, currentItem=null, runActive=false;

const SET_SIZE = 12;
const DMG = 25;
const USED_KEY = (l)=>`glitch_eternal_v4_${l}`;
const HOF_KEY = "glitch_eternal_v4";
const DAILY_KEY = "glitch_daily_v4";

function setBtns(disabled){
  $("btnGlitch").disabled = disabled;
  $("btnStable").disabled = disabled;
}

function speak(text, targetLang) {
  if(!text) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const m = { en: "en-US", de: "de-DE", fr: "fr-FR", es: "es-ES", it: "it-IT" };
  u.lang = m[targetLang] || "en-US";
  u.rate = 0.85;
  window.speechSynthesis.speak(u);
}

function updateLeaderboardUI() {
  const records = JSON.parse(localStorage.getItem(HOF_KEY) || "[]");
  const today = new Date().toLocaleDateString('tr-TR');
  const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || "{}");

  // Daily
  if (daily.date !== today) {
    localStorage.removeItem(DAILY_KEY);
    $("dailyInfo").textContent = "Lider Yok";
  } else if (daily.score) {
    $("dailyInfo").textContent = `${daily.score} Puan (${daily.lang})`;
  } else {
    $("dailyInfo").textContent = "Lider Yok";
  }

  // PB: seÃ§ili dil iÃ§in max
  const pb = records
    .filter(r => r.lang === lang.toUpperCase())
    .reduce((mx, r) => Math.max(mx, Number(r.score || 0)), 0);

  $("pbBadge").textContent = `PB: ${pb}`;

  // Top 5
  $("leaderboardBox").innerHTML =
    records.slice(0,5).map((r,i)=> `<div>${i+1}. ${r.score} - ${r.lang}</div>`).join('')
    || '<div style="opacity:.5">HenÃ¼z kayÄ±t yok.</div>';
}

// Dil seÃ§imi
document.querySelectorAll(".lang-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang=b.dataset.lang;
    updateLeaderboardUI();
  };
});

$("startBtn").onclick=async()=>{
  $("start").classList.add("hidden");
  $("game").style.display="flex";

  if(!runActive){
    totalScore=0;
    integrity=100;
    runActive=true;
  }
  await initGame(false);
};

async function initGame(isBank = false) {
  currentIndex=0;
  setScore=0;
  busy=false;
  setBtns(false);

  if(isBank) integrity = 100;

  const pool = await loadLangPool(lang);
  const items = Array.isArray(pool?.items) ? pool.items : [];
  const randomizedItems = [...items].sort(() => Math.random() - 0.5);

  const { used, save } = createUsedSet(USED_KEY(lang));

  wordList = pick({items: randomizedItems}, SET_SIZE, used, save, (it) => {
    const s = String(it?.sentence || "").trim();
    return s.length > 5;
  });

  // soft reset
  if(wordList.length < SET_SIZE) {
    localStorage.removeItem(USED_KEY(lang));
    return initGame(isBank);
  }

  // âœ… used mÃ¼hÃ¼rle
  try { save(wordList.map(x => x.w)); } catch(e){}

  nextRound();
}

function produceGlitch(original) {
  let text = String(original || "");
  const rules = [
    { f: " am ", t: " is " }, { f: " are ", t: " is " }, { f: " have ", t: " has " },
    { f: " don't ", t: " doesn't " }, { f: " doesn't ", t: " don't " }, { f: " a ", t: " an " }
  ];
  const rule = rules.find(r => text.toLowerCase().includes(r.f));
  if(rule) text = text.replace(new RegExp(rule.f, "i"), rule.t);
  else text = text.replace(/\bis\b/i, "are").replace(/\bs /g, " ");
  return text;
}

function nextRound() {
  if(currentIndex >= wordList.length || integrity <= 0) { finish(integrity <= 0); return; }

  const item = wordList[currentIndex];
  const sentence = String(item?.sentence || "").trim() || `I am studying ${String(item?.w || "it")}.`;

  const isOk = Math.random() > 0.5;
  const displayText = isOk ? sentence : produceGlitch(sentence);

  currentItem = { text: displayText, original: sentence, isOk, tr: item?.tr || "" };

  $("sentence").textContent = currentItem.text;
  $("correctionBox").style.opacity = "0";

  $("setCounter").textContent = `${currentIndex + 1}/${SET_SIZE}`;
  $("scoreDisp").textContent = totalScore;
  $("life").textContent = integrity + "%";
  $("life").style.color = integrity <= 25 ? "var(--pink)" : "var(--cyan)";
  $("terminal").style.borderColor = "var(--border)";

  busy=false;
  setBtns(false);
}

function handleAnswer(userPickStable) {
  if(busy) return;
  busy=true;
  setBtns(true);

  const correct = (userPickStable === currentItem.isOk);

  if(correct) {
    totalScore += 100;
    setScore += 100;
    $("terminal").style.borderColor = "var(--green)";
    speak(currentItem.original, lang);

    setTimeout(() => { currentIndex++; nextRound(); }, 1100);
  } else {
    integrity -= DMG;
    $("frame").classList.add("glitch-anim");
    $("terminal").style.borderColor = "var(--pink)";

    $("correctTxt").textContent = currentItem.original;
    $("trTxt").textContent = currentItem.tr ? ("AnlamÄ±: " + currentItem.tr) : "";
    $("correctionBox").style.opacity = "1";

    speak(currentItem.original, lang);

    setTimeout(()=> {
      $("frame").classList.remove("glitch-anim");
      if(integrity <= 0) finish(true);
      else { currentIndex++; nextRound(); }
    }, 2600); // âœ… 4sn yerine daha akÄ±cÄ±
  }
}

$("btnGlitch").onclick = () => handleAnswer(false);
$("btnStable").onclick = () => handleAnswer(true);

function saveRecord() {
  const today = new Date().toLocaleDateString('tr-TR');
  const langUp = lang.toUpperCase();

  const records = JSON.parse(localStorage.getItem(HOF_KEY) || "[]");
  records.push({score: totalScore, lang: langUp, date: today, id: Date.now()});
  records.sort((a,b)=> Number(b.score||0) - Number(a.score||0));
  localStorage.setItem(HOF_KEY, JSON.stringify(records.slice(0,10)));

  const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || "{}");
  if (daily.date !== today || totalScore > (daily.score || 0)) {
    localStorage.setItem(DAILY_KEY, JSON.stringify({score: totalScore, lang: langUp, date: today}));
  }
}

function finish(died) {
  saveRecord();
  updateLeaderboardUI();

  $("end").classList.remove("hidden");
  $("endTitle").textContent = died ? "SYSTEM CRASHED" : "SECTOR CLEARED";
  $("endTitle").style.color = died ? "var(--pink)" : "var(--green)";
  $("endStats").innerHTML = `SCORE: <b>${totalScore}</b>`;

  if(died) {
    $("btnContinue").classList.add("hidden");
    $("btnBank").classList.add("hidden");
    runActive = false;
  } else {
    $("btnContinue").classList.remove("hidden");
    $("btnBank").classList.remove("hidden");
  }
}

$("btnContinue").onclick = () => {
  $("end").classList.add("hidden");
  initGame(false);
};

$("btnBank").onclick = () => {
  const bonus = Math.round(setScore * 0.05);
  totalScore += bonus;
  setScore = 0;          // âœ… banka sonrasÄ± setScore sÄ±fÄ±r
  integrity = 100;       // âœ… tamir net
  $("end").classList.add("hidden");
  initGame(true);
};

$("btnExit").onclick = () => location.reload();

window.addEventListener("load", updateLeaderboardUI);
</script>
</body>
</html>
