# FILE: app/models/translate.py
from __future__ import annotations

import os
import logging
from typing import Optional, Dict, Any

import requests
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, ConfigDict, Field

logger = logging.getLogger("uvicorn.error")
router = APIRouter()

# ✅ KEY FALLBACK SIRASI:
# 1) GOOGLE_API_KEY (senin mevcut)
# 2) GOOGLE_TRANSLATE_API_KEY (benim önerdiğim)
# 3) GEMINI_API_KEY (bazı projelerde sende var)
GOOGLE_API_KEY = (os.getenv("GOOGLE_API_KEY", "") or "").strip()
if not GOOGLE_API_KEY:
    GOOGLE_API_KEY = (os.getenv("GOOGLE_TRANSLATE_API_KEY", "") or "").strip()
if not GOOGLE_API_KEY:
    GOOGLE_API_KEY = (os.getenv("GEMINI_API_KEY", "") or "").strip()


# -------------------------
# MODELS
# -------------------------
class FlexibleModel(BaseModel):
    model_config = ConfigDict(extra="ignore", populate_by_name=True)


class TranslateRequest(FlexibleModel):
    text: str

    # ✅ Hem "from_lang" hem "source" kabul et
    from_lang: Optional[str] = Field(default=None, alias="source")

    # ✅ Hem "to_lang" hem "target" kabul et
    to_lang: str = Field(default="en", alias="target")


class TranslateResponse(FlexibleModel):
    ok: bool
    translated: str
    detected_source: Optional[str] = None


class TTSRequest(FlexibleModel):
    text: str
    # ✅ Hem "lang" hem "language" kabul et (ileride lazım olur)
    lang: str = Field(default="en", alias="language")
    gender: str = "FEMALE"
    speaking_rate: float = 1.0
    pitch: float = 0.0


class TTSResponse(FlexibleModel):
    ok: bool
    audio_base64: str


# -------------------------
# HELPERS
# -------------------------
def _ensure_key():
    if not GOOGLE_API_KEY:
        raise HTTPException(500, "GOOGLE_API_KEY missing (Render ENV)")

def _norm_lang(code: Optional[str]) -> Optional[str]:
    if not code:
        return None
    c = str(code).strip().lower()
    # en-US / en_US -> en
    if "-" in c:
        c = c.split("-", 1)[0]
    if "_" in c:
        c = c.split("_", 1)[0]
    return c or None


# -------------------------
# ✅ PING (en hızlı teşhis)
# GET /api/translate/_ping  (senin var)
# GET /api/translate/ping   (kolay ezber)
# -------------------------
@router.get("/translate/_ping")
def translate_ping():
    has = bool(GOOGLE_API_KEY)
    masked = (GOOGLE_API_KEY[:6] + "..." + GOOGLE_API_KEY[-4:]) if has else ""
    return {"ok": True, "has_key": has, "key": masked}

@router.get("/translate/ping")
def translate_ping2():
    return translate_ping()


# -------------------------
# ✅ GOOGLE TRANSLATE v2
# POST /api/translate
# Body: {text, to_lang|target, from_lang|source?}
# -------------------------
@router.post("/translate", response_model=TranslateResponse)
def api_translate(req: TranslateRequest):
    _ensure_key()

    text = (req.text or "").strip()
    if not text:
        raise HTTPException(400, "empty text")

    src = _norm_lang(req.from_lang)  # alias: "source" da buraya düşer
    dst = _norm_lang(req.to_lang) or "en"  # alias: "target" da buraya düşer

    url = "https://translation.googleapis.com/language/translate/v2"

    # ✅ EN STABİL: key query param, body JSON
    params = {"key": GOOGLE_API_KEY}
    payload: Dict[str, Any] = {
        "q": text,
        "target": dst,
        "format": "text",
    }
    if src:
        payload["source"] = src

    try:
        r = requests.post(url, params=params, json=payload, timeout=18)

        if r.status_code >= 400:
            body = (r.text or "")[:1200]
            logger.error("GOOGLE_TRANSLATE_FAIL status=%s body=%s", r.status_code, body)
            raise HTTPException(
                status_code=502,
                detail=f"google_translate_error status={r.status_code} body={body}"
            )

        data = r.json() or {}
        tr = (((data.get("data") or {}).get("translations")) or [])
        if not tr:
            return TranslateResponse(ok=True, translated=text, detected_source=src)

        first = tr[0] or {}
        translated = str(first.get("translatedText") or "").strip() or text
        detected = str(first.get("detectedSourceLanguage") or "").strip() or None

        # Basit HTML entity temizliği
        translated = (
            translated
            .replace("&amp;", "&")
            .replace("&quot;", '"')
            .replace("&#39;", "'")
            .replace("&lt;", "<")
            .replace("&gt;", ">")
        )

        return TranslateResponse(ok=True, translated=translated, detected_source=detected)

    except HTTPException:
        raise
    except Exception as e:
        logger.error("TRANSLATE_EXCEPTION %s", str(e))
        raise HTTPException(500, "translate error")


# -------------------------
# ✅ GOOGLE TEXT-TO-SPEECH
# POST /api/tts
# -------------------------
@router.post("/tts", response_model=TTSResponse)
def api_tts(req: TTSRequest):
    _ensure_key()

    text = (req.text or "").strip()
    if not text:
        raise HTTPException(400, "empty text")

    lang = _norm_lang(req.lang) or "en"

    voice_map = {
        "tr": {"languageCode": "tr-TR", "name": "tr-TR-Standard-A"},
        "en": {"languageCode": "en-US", "name": "en-US-Standard-C"},
        "de": {"languageCode": "de-DE", "name": "de-DE-Standard-A"},
        "fr": {"languageCode": "fr-FR", "name": "fr-FR-Standard-A"},
        "es": {"languageCode": "es-ES", "name": "es-ES-Standard-A"},
        "ar": {"languageCode": "ar-XA", "name": "ar-XA-Standard-A"},
        "ru": {"languageCode": "ru-RU", "name": "ru-RU-Standard-A"},
        "it": {"languageCode": "it-IT", "name": "it-IT-Standard-A"},
    }
    voice = voice_map.get(lang, {"languageCode": "en-US", "name": "en-US-Standard-C"})

    url = "https://texttospeech.googleapis.com/v1/text:synthesize"
    params = {"key": GOOGLE_API_KEY}

    body = {
        "input": {"text": text[:4500]},
        "voice": {
            "languageCode": voice["languageCode"],
            "name": voice["name"],
            "ssmlGender": str(req.gender or "FEMALE").upper(),
        },
        "audioConfig": {
            "audioEncoding": "MP3",
            "speakingRate": float(req.speaking_rate or 1.0),
            "pitch": float(req.pitch or 0.0),
        },
    }

    try:
        r = requests.post(url, params=params, json=body, timeout=20)

        if r.status_code >= 400:
            body_txt = (r.text or "")[:1200]
            logger.error("GOOGLE_TTS_FAIL status=%s body=%s", r.status_code, body_txt)
            raise HTTPException(
                status_code=502,
                detail=f"google_tts_error status={r.status_code} body={body_txt}"
            )

        data = r.json() or {}
        audio = str(data.get("audioContent") or "").strip()
        if not audio:
            raise HTTPException(502, "tts no audioContent")

        return TTSResponse(ok=True, audio_base64=audio)

    except HTTPException:
        raise
    except Exception as e:
        logger.error("TTS_EXCEPTION %s", str(e))
        raise HTTPException(500, "tts error")
