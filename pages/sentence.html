<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY ‚Ä¢ Sentence Builder ‚Äî Final</title>
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050005; --panel:#151520;
  --primary:#9900ff; --accent:#00f3ff;
  --ok:#00e676; --bad:#ff1744;
  --text:#fff; --border:rgba(255,255,255,.15);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;background:var(--bg);font-family:Outfit,sans-serif;overflow:hidden;color:var(--text)}
.bg{position:absolute;inset:0;background:radial-gradient(circle,#1a001a 0%,#000 100%)}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;border:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column}
@media(min-width:520px){.app{height:92vh;border-radius:32px}}

.header{height:70px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--border)}
.title{font-family:Space Grotesk;font-weight:900;color:var(--accent);letter-spacing:1px}
.badge{font-size:10px;padding:4px 8px;border-radius:6px;background:var(--primary);margin-left:8px}

.stats{display:flex;justify-content:space-between;padding:10px 16px;border-bottom:1px dashed var(--border)}
.stats div{font-size:12px;text-transform:uppercase;opacity:.7}
.stats b{font-size:16px;opacity:1}

.game{flex:1;padding:16px;display:none;flex-direction:column;gap:12px}
.hint{background:linear-gradient(135deg,rgba(153,0,255,.15),rgba(0,243,255,.08));border:1px solid rgba(153,0,255,.4);border-radius:16px;padding:14px;text-align:center;font-style:italic}

.target{min-height:90px;border:2px dashed var(--border);border-radius:20px;padding:10px;display:flex;flex-wrap:wrap;gap:8px}
.target.correct{border-color:var(--ok);background:rgba(0,230,118,.12)}
.target.wrong{border-color:var(--bad)}

.pool{flex:1;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}

.token{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.08);font-weight:700;cursor:pointer}
.token.placed{background:linear-gradient(135deg,var(--primary),var(--accent));border:none}

.actions{display:flex;gap:10px}
.btn{flex:1;padding:14px;border-radius:16px;border:none;font-weight:900;cursor:pointer}
.btn.check{background:var(--ok);color:#000}
.btn.sec{background:rgba(255,255,255,.1);color:#fff;border:1px solid var(--border)}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:50}
.card{background:#151520;border:1px solid var(--border);border-radius:24px;padding:26px;width:85%;text-align:center}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:16px}
.lang{padding:10px;border:1px solid var(--border);border-radius:10px;font-weight:900;cursor:pointer}
.lang.active{background:var(--primary)}

.hidden{display:none!important}
</style>
</head>

<body>
<div class="bg"></div>

<div class="app">
  <div class="header">
    <div class="title">SENTENCE BUILDER <span id="langBadge" class="badge">EN</span></div>
    <div id="soundBtn" style="cursor:pointer">üîä</div>
  </div>

  <div class="stats">
    <div>PUAN<br><b id="scoreVal">0</b></div>
    <div>CAN<br><b id="livesVal">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</b></div>
    <div>SEVƒ∞YE<br><b id="levelVal">1</b></div>
  </div>

  <div class="game" id="game">
    <div class="hint" id="hintText">...</div>
    <div class="target" id="target"></div>
    <div class="pool" id="pool"></div>
    <div class="actions">
      <button class="btn sec" onclick="resetLevel()">SIFIRLA</button>
      <button class="btn check" onclick="checkSentence()">KONTROL</button>
    </div>
  </div>
</div>

<div class="modal" id="langModal">
  <div class="card">
    <h3>Dƒ∞L SE√á</h3>
    <div class="langs">
      <div class="lang active" data-lang="en">EN</div>
      <div class="lang" data-lang="de">DE</div>
      <div class="lang" data-lang="fr">FR</div>
      <div class="lang" data-lang="es">ES</div>
      <div class="lang" data-lang="it">IT</div>
    </div>
  </div>
</div>

<div class="modal hidden" id="endModal">
  <div class="card">
    <h3 id="endTitle">Bƒ∞TTƒ∞</h3>
    <p id="endDesc"></p>
    <button class="btn check" onclick="restart()">TEKRAR</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $=id=>document.getElementById(id);

let lang="en";
let score=0,lives=3,level=0;
let sentence="",tokens=[],pool=[],placed=[];
let muted=false;

const LANGMAP={en:"en-US",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT"};

document.querySelectorAll(".lang").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang=b.dataset.lang;
    $("langBadge").textContent=lang.toUpperCase();
    start();
  };
});

$("soundBtn").onclick=()=>{
  muted=!muted;
  $("soundBtn").textContent=muted?"üîá":"üîä";
};

async function start(){
  $("langModal").classList.add("hidden");
  $("game").style.display="flex";
  score=0;lives=3;level=0;
  updateStats();
  await loadLevel();
}

async function loadLevel(){
  if(lives<=0){finish(false);return;}
  const data=await loadLangPool(lang);
  const {used,save}=createUsedSet("sentence_builder_"+lang);
  const picked=pick(data,1,used,save);
  const w=picked[0];
  sentence=(w.sentence || `I like ${w.w}.`).trim();
  $("hintText").textContent=w.tr;

  tokens=sentence.match(/[\w√Ä-≈æ]+|[.,!?;]/g) || [];
  pool=[...tokens].sort(()=>Math.random()-.5).map((t,i)=>({id:i,text:t}));
  placed=[];
  render();
}

function render(){
  const t=$("target"), p=$("pool");
  t.innerHTML=""; p.innerHTML="";
  placed.forEach((o,i)=>{
    const b=document.createElement("div");
    b.className="token placed";
    b.textContent=o.text;
    b.onclick=()=>{placed.splice(i,1);pool.push(o);render();};
    t.appendChild(b);
  });
  pool.forEach((o,i)=>{
    const b=document.createElement("div");
    b.className="token";
    b.textContent=o.text;
    b.onclick=()=>{pool.splice(i,1);placed.push(o);speak(o.text);render();};
    p.appendChild(b);
  });
}

function normalizeJoin(arr){
  let out="";
  arr.forEach((w,i)=>{
    if(i>0 && !/[.,!?;]/.test(w)) out+=" ";
    out+=w;
  });
  return out;
}

function checkSentence(){
  if(!placed.length) return;
  const user=normalizeJoin(placed.map(o=>o.text));
  if(user===sentence){
    score+=10; level++; play("win"); speak(sentence);
    updateStats();
    setTimeout(loadLevel,800);
  }else{
    lives--; play("error"); updateStats();
    if(lives<=0) finish(false);
  }
}

function resetLevel(){
  pool=[...pool,...placed]; placed=[]; render();
}

function updateStats(){
  $("scoreVal").textContent=score;
  $("levelVal").textContent=level+1;
  $("livesVal").textContent="‚ù§Ô∏è".repeat(lives)+"üíÄ".repeat(3-lives);
}

function finish(win){
  $("endModal").classList.remove("hidden");
  $("endTitle").textContent=win?"TAMAMLANDI":"OYUN Bƒ∞TTƒ∞";
  $("endDesc").innerHTML=`Skor: <b>${score}</b><br>Doƒüru c√ºmle:<br><i>${sentence}</i>`;
  speak(sentence);
}

function restart(){
  $("endModal").classList.add("hidden");
  start();
}

let audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function play(t){
  if(muted) return;
  if(audioCtx.state==="suspended") audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  const n=audioCtx.currentTime;
  if(t==="win"){o.frequency.value=600;g.gain.value=.1;o.start(n);o.stop(n+.25);}
  if(t==="error"){o.frequency.value=140;g.gain.value=.1;o.start(n);o.stop(n+.2);}
}

function speak(txt){
  if(muted) return;
  const u=new SpeechSynthesisUtterance(txt);
  u.lang=LANGMAP[lang]||"en-US";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
</script>
</body>
</html>
