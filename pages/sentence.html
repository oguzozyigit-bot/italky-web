<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);
let currentLang = "en", currentDiff = "A2", wordList = [], currentIndex = 0;
let mistakes = 0, lives = 3, currentWord = "", currentRaw = "", currentSentence = "", discovered = [], jokers = 2, totalScore = 0;
let streak = 0, maxStreak = 0, roundStartTime = 0, perfectCount = 0;
const SET_SIZE = 12;

function escapeRegExp(s){ return String(s ?? "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

/* ✅ KRİTİK: SADECE KELİME BİTİNCE OKU (CHECKLIST #4 FIX) */
function speakSentence(text) {
  window.speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  const langMap = { en: "en-US", de: "de-DE", fr: "fr-FR", es: "es-ES", it: "it-IT" };
  msg.lang = langMap[currentLang] || "en-US";
  msg.rate = 0.85;
  window.speechSynthesis.speak(msg);
}

window.selectLevel = (diff) => { currentDiff = diff; initGame(); };

async function initGame() {
  try {
    const rawPool = await loadLangPool(currentLang);
    
    // ✅ HAVUZU ÇEŞİTLENDİR: Her oyun modu için benzersiz 'used' listesi
    const { used, save } = createUsedSet(`used_sentence_v53_${currentLang}_${currentDiff}`);

    // ✅ SHUFFLE VE SEED: Havuzu karıştır ki hep aynıları gelmesin
    const randomizedPool = rawPool.sort(() => Math.random() - 0.5);

    wordList = pick(randomizedPool, SET_SIZE, used, save, (it) => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const target = String(currentDiff || "").toUpperCase();
      const lvlMatch = (target === "A2") ? ["A1","A2"].includes(itLvl) : (itLvl === target);
      // Diğer oyunlarda çıkan kelimeleri buradan da süzebiliriz (opsiyonel)
      return lvlMatch && it.sentence && it.w;
    });

    $("startModal").style.display = "none";
    startRound();
  } catch (e) { alert("Havuz yüklenemedi!"); }
}

function startRound() {
  if (currentIndex >= wordList.length || lives <= 0) { finishSet(); return; }
  const data = wordList[currentIndex];
  currentRaw = data.w.trim();
  currentSentence = data.sentence;
  currentWord = currentRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-ZÇĞİÖŞÜ-]/g, "");
  mistakes = 0;
  discovered = new Array(currentWord.length).fill(false);
  roundStartTime = Date.now();

  const escaped = escapeRegExp(currentRaw);
  const masked = currentSentence.toUpperCase().replace(new RegExp(`\\b${escaped}\\b`, "gi"), "____");
  
  $("sentenceDisplay").textContent = masked;
  $("translationDisplay").textContent = data.tr || "";
  renderWord();
  renderDynamicKeyboard();
  updateUI();
}

function handleGuess(char, btn) {
  if (!btn || btn.disabled) return;
  btn.disabled = true;

  if (currentWord.includes(char)) {
    btn.classList.add("correct");
    // ✅ BUG FİX: Burada sesli okuma kaldırıldı (Kopya verilmez)
    currentWord.split("").forEach((c, i) => { if (c === char) discovered[i] = true; });
    renderWord();

    if (discovered.every(v => v)) {
      calculatePuan();
      // ✅ DOĞRU AN: Kelime tamamen bitince telaffuz et
      setTimeout(() => speakSentence(currentSentence), 200);
      setTimeout(() => { currentIndex++; startRound(); }, 1500);
    }
  } else {
    btn.classList.add("wrong");
    mistakes++;
    streak = Math.max(0, streak - 2);
    updateUI();
    if (mistakes >= 8) {
      lives--;
      // Yanlışta da kelimeyi göster ve cümleyi okut (Eğitim amaçlı)
      setTimeout(() => speakSentence(currentSentence), 200);
      if (lives <= 0) finishSet();
      else { currentIndex++; setTimeout(() => startRound(), 1500); }
    }
  }
}
// ... (Kalan fonksiyonlar calculatePuan, finishSet, updateUI v5.2 ile aynı) ...
</script>
