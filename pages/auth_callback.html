<!-- FILE: /pages/auth_callback.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>italkyAI • Giriş Tamamlanıyor</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    html,body{
      margin:0;width:100%;height:100dvh;
      display:flex;align-items:center;justify-content:center;
      background:#02000f;color:#fff;font-family:Outfit,sans-serif
    }
    .box{
      width:min(520px,92vw);padding:18px;border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);text-align:center
    }
    .t{font-weight:1000;font-size:16px;margin:0 0 8px}
    .s{font-weight:800;font-size:12px;color:rgba(255,255,255,.65);margin:0}
    .spin{
      width:40px;height:40px;margin:14px auto 2px;
      border-radius:999px;border:3px solid rgba(255,255,255,.18);
      border-top-color: rgba(99,102,241,.95);
      animation:r 1s linear infinite;
    }
    @keyframes r{to{transform:rotate(360deg)}}
    .e{
      margin-top:10px;font-size:11px;color:rgba(255,255,255,.55);
      word-break:break-word;display:none
    }
  </style>
</head>
<body>
  <div class="box">
    <div class="spin" aria-hidden="true"></div>
    <p class="t">Giriş tamamlanıyor…</p>
    <p class="s">Lütfen bekleyin.</p>
    <div class="e" id="errBox"></div>
  </div>

  <script type="module">
    import { supabase } from "/js/supabase_client.js";
    import { ensureAuthAndCacheUser } from "/js/auth.js";

    const HOME  = "/pages/home.html";
    const LOGIN = "/pages/login.html";
    const errBox = document.getElementById("errBox");

    function showErr(msg){
      if(!errBox) return;
      errBox.style.display = "block";
      errBox.textContent = String(msg || "");
    }

    // ✅ Bu sayfada loop olmasın: aynı tab içinde 1 kez çalışır
    if (sessionStorage.getItem("italky_cb_lock_v2") === "1") {
      location.replace(LOGIN);
    }
    sessionStorage.setItem("italky_cb_lock_v2", "1");

    async function waitForSession(maxMs=9000){
      const start = Date.now();
      while(Date.now()-start < maxMs){
        const { data:{ session } } = await supabase.auth.getSession();
        if(session) return session;
        await new Promise(r=>setTimeout(r, 250));
      }
      return null;
    }

    try{
      const url = new URL(location.href);
      const code = url.searchParams.get("code");

      // ✅ 1) Web OAuth dönüşü: code varsa exchange şart
      if(code){
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if(error){
          console.error("exchangeCodeForSession error:", error);
          showErr("OAuth exchange hatası: " + (error.message || "unknown"));
          setTimeout(()=>location.replace(LOGIN), 900);
          throw error;
        }
      }

      // ✅ 2) Session bekle
      const s = await waitForSession();
      if(!s){
        showErr("Oturum bulunamadı. Tekrar giriş sayfasına yönlendiriliyor…");
        setTimeout(()=>location.replace(LOGIN), 900);
        throw new Error("session_not_found");
      }

      // ✅ 3) Cache + profile
      await ensureAuthAndCacheUser();

      // ✅ 4) URL temizle + HOME
      history.replaceState({}, "", HOME);
      location.replace(HOME);

    }catch(e){
      console.error("auth_callback fatal:", e);
      // burada global signOut yapmıyoruz (loop üretmesin)
      // sadece login’e dön
      setTimeout(()=>location.replace(LOGIN + "?e=auth"), 700);
    } finally {
      // Lock burada kalsın; tab yenilenirse tekrar çalışması zaten sorun değil.
      // İstersen 10 sn sonra aç:
      setTimeout(()=>{ try{ sessionStorage.removeItem("italky_cb_lock_v2"); }catch{} }, 10000);
    }
  </script>
</body>
</html>
