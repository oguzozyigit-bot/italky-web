<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>italkyAI ‚Ä¢ Y√ºz Y√ºze</title>
<link rel="icon" href="data:," />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
<style>
:root{
    --bg-void:#030014;
    --text: rgba(255,255,255,.92);
    --border: rgba(255,255,255,.10);
    --border2: rgba(255,255,255,.06);
    --shadow: 0 28px 90px rgba(0,0,0,.65);
    --gold:#ffb300;
    --pist:#bef264;
    --sheetBg: rgba(16,16,20,.92);
    --sheetBorder: rgba(255,255,255,.12);
    --logoWhite: #FFFFFF;
    --ai1: #A5B4FC;
    --ai2: #4F46E5;
}
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ margin:0; padding:0; width:100%; height:100%; overflow:hidden; position:fixed; font-family:'Outfit', sans-serif; background: var(--bg-void); color: var(--text); display:flex; align-items:center; justify-content:center; }
body{ background-image: radial-gradient(at 0% 0%, rgba(59,130,246,.16) 0px, transparent 55%), radial-gradient(at 100% 100%, rgba(79,70,229,.16) 0px, transparent 55%); }

.frame{ width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; overflow:hidden; }

/* GERƒ∞ BUTONU */
.back{ position:absolute; top: 12px; left: 12px; z-index: 80; width: 46px; height: 46px; border-radius: 16px; border: 1px solid var(--border); background: rgba(15,15,18,.50); color: #fff; font-size: 22px; font-weight: 1000; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 18px 40px rgba(0,0,0,.45); backdrop-filter: blur(10px); user-select:none; }
.back:active{ transform: translateY(1px); }

/* ANA YAPI (SPLIT) */
.split{
    position:absolute; inset: 0;
    display:grid;
    grid-template-rows: 80px 1fr auto 1fr 80px; 
    gap: 0;
}

/* Mƒ∞KROFONLAR */
.micSlot{
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    position: relative;
}
.micSlot.top{ align-items: flex-end; padding-bottom: 10px; }
.micSlot.bottom{ align-items: flex-start; padding-top: 10px; }

.micBtn{
    width: 64px; height: 64px;
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.05);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
    transition: all 0.2s ease;
}
.micBtn svg{
    width: 28px; height: 28px;
    stroke: #fff; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.micSlot.top .micBtn{ transform: rotate(180deg); }
.micSlot.top .micBtn:active{ transform: rotate(180deg) scale(0.95); }
.micSlot.bottom .micBtn:active{ transform: scale(0.95); }

.micBtn.listening{
    border-color: rgba(79,70,229,.6);
    background: rgba(79,70,229,.25);
    box-shadow: 0 0 25px rgba(79,70,229,.4);
}

/* ORTA ALAN */
.midSection{
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 60px;
    z-index: 10;
}

/* Sohbet temizle */
.clearBtn{
    position:absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    height: 36px;
    padding: 0 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.22);
    color: rgba(255,255,255,.88);
    font-weight: 900;
    font-size: 12px;
    cursor:pointer;
    backdrop-filter: blur(10px);
}
.clearBtn:active{ transform: translateY(-50%) scale(.97); }

.wave{
    position: absolute; inset: 0;
    opacity: .98; pointer-events:none;
    filter: drop-shadow(0 0 15px rgba(79,70,229,0.3));
    z-index: 1;
}
.wave svg{ width:100%; height:100%; display:block; }
.wave svg path{
    stroke-dasharray: 10 12;
    animation: waveFlow 4s linear infinite;
    opacity: .6;
}
@keyframes waveFlow{ 0%{ stroke-dashoffset: 0; } 100%{ stroke-dashoffset: -160; } }

.centerBrand{
    position: relative;
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 8px 20px;
    border-radius: 50px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
    box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(79,70,229,0.1);
    animation: brandFloat 3s ease-in-out infinite;
}
@keyframes brandFloat {
    0%, 100% { transform: translateY(0); box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(79,70,229,0.1); border-color: rgba(255,255,255,0.08); }
    50% { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(79,70,229,0.25), inset 0 0 20px rgba(79,70,229,0.2); border-color: rgba(165,180,252,0.3); }
}
.logoText{
    font-family:'Space Grotesk', sans-serif;
    font-size: 20px;
    line-height: 1;
    letter-spacing: -0.5px;
    color: #fff;
    font-weight: 700;
}
.logoAI_Center{
    font-family:'Space Grotesk', sans-serif;
    font-weight: 700;
    font-size: 20px;
    background: linear-gradient(135deg, #fff 10%, #6366f1 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
}

/* SOHBET KUTULARI */
.side{
    margin: 0 12px;
    border-radius: 24px;
    border: 1px solid var(--border);
    background: radial-gradient(800px 240px at 0% 0%, rgba(40,120,255,.12), transparent 62%), rgba(0,0,0,.12);
    overflow:hidden; display:flex; flex-direction:column; min-height:0;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
}
.side.meTint{
    background: radial-gradient(900px 420px at 30% 12%, rgba(120, 20, 35, .85), transparent 68%), linear-gradient(180deg, rgba(60, 10, 20, .55), rgba(0,0,0,.15));
}
.side.top{ transform: rotate(180deg); }

.bar{
    display:flex; align-items:center; justify-content:space-between; gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border2);
    background: rgba(0,0,0,.22);
    /* Dropdown √ºstte g√∂r√ºns√ºn diye z-index ve position:relative ekliyoruz */
    position: relative;
    z-index: 20;
}

/* --- YENƒ∞ EKLENEN DROPDOWN STƒ∞LLERƒ∞ --- */
.langWrapper {
    position: relative;
    display: inline-block;
}
.langBtn{
    height: 38px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06); color:#fff;
    font-weight: 800; font-size: 13px;
    padding: 0 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer; min-width: 140px;
}
.dropdownMenu {
    position: absolute;
    top: 115%; /* Butonun hemen altƒ± */
    left: 0;
    width: 160px;
    max-height: 220px;
    overflow-y: auto;
    background: rgba(18, 18, 24, 0.95);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 6px;
    display: none; /* Varsayƒ±lan gizli */
    flex-direction: column;
    gap: 2px;
    backdrop-filter: blur(16px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    z-index: 999;
}
.dropdownMenu.show {
    display: flex;
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn {
    from { opacity: 0; transform: translateY(-10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.dropItem {
    padding: 10px 12px;
    border-radius: 8px;
    color: rgba(255,255,255,0.9);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}
.dropItem:active { background: rgba(255,255,255,0.1); }
.dropItem:hover { background: rgba(255,255,255,0.08); }
.dropItem span { pointer-events: none; }

/* Scrollbar ayarƒ± */
.dropdownMenu::-webkit-scrollbar { width: 4px; }
.dropdownMenu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
/* -------------------------------------- */

.btnIcon{
    width: 38px; height: 38px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    display:flex; align-items:center; justify-content:center; cursor:pointer; flex: 0 0 38px;
}
.btnIcon svg{ width: 18px; height:18px; stroke:#fff; fill:none; opacity:.9; }
.btnIcon.muted{ opacity:.55; filter: grayscale(1); }

.content{
    flex: 1 1 auto; min-height:0; padding: 12px;
    overflow:auto; -webkit-overflow-scrolling: touch;
    display:flex; flex-direction:column; gap: 10px;
    scrollbar-width:none;
}
.content::-webkit-scrollbar{ width:0; height:0; }

.bubble{
    max-width: 95%; padding: 10px 12px; border-radius: 16px;
    border: 1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22);
    font-weight: 600; font-size: 14px; line-height: 1.35;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    white-space: pre-wrap;
    word-break: break-word;
}
.bubble.me{ align-self:flex-end; border-right: 3px solid var(--pist); text-align:right; }
.bubble.them{ align-self:flex-start; border-left: 3px solid var(--gold); }

.toast{
  position: fixed;
  left:50%; top:18px;
  transform: translateX(-50%) translateY(-120px);
  background: rgba(10,10,18,.92);
  border:1px solid rgba(165,180,252,.35);
  padding: 10px 14px;
  border-radius: 999px;
  color:#fff;
  z-index:100000;
  font-weight:900;
  font-size:12px;
  transition:.28s;
  backdrop-filter: blur(12px);
}
.toast.show{ transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<button class="back" id="backBtn">‚Üê</button>

<div class="frame" id="frameRoot">
  <div class="split">

    <div class="micSlot top">
      <button class="micBtn" id="topMic" aria-label="Mikrofon √úst" type="button">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
      </button>
    </div>

    <section class="side top" id="sideTop">
      <div class="bar">
        <div class="langWrapper">
            <button class="langBtn" id="topLangBtn" type="button"><span id="topLangTxt">English</span><span>‚ñæ</span></button>
            <div class="dropdownMenu" id="topDropdown"></div>
        </div>

        <button class="btnIcon" id="topSpeak" type="button" title="Geri oku / Mute">
          <svg viewBox="0 0 24 24"><path d="M11 5L6 9H3v6h3l5 4z"></path><path d="M15 9a4 4 0 0 1 0 6"></path></svg>
        </button>
      </div>
      <div class="content" id="topBody"></div>
    </section>

    <div class="midSection">
      <button class="clearBtn" id="clearBtn" type="button">Temizle</button>

      <div class="centerBrand">
        <span class="logoText">italky</span>
        <span class="logoAI_Center">AI</span>
      </div>

      <div class="wave" aria-hidden="true">
        <svg viewBox="0 0 1000 90" preserveAspectRatio="none">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="rgba(79,70,229,.10)"/>
              <stop offset="50%" stop-color="rgba(165,180,252,.4)"/>
              <stop offset="100%" stop-color="rgba(255,179,0,.22)"/>
            </linearGradient>
          </defs>
          <path d="M0,50 C150,80 350,20 500,50 C650,80 850,20 1000,50" fill="none" stroke="url(#g1)" stroke-width="6" stroke-linecap="round"/>
          <path d="M0,50 C150,80 350,20 500,50 C650,80 850,20 1000,50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <section class="side meTint" id="sideBottom">
      <div class="bar">
        <div class="langWrapper">
            <button class="langBtn" id="botLangBtn" type="button"><span id="botLangTxt">T√ºrk√ße</span><span>‚ñæ</span></button>
            <div class="dropdownMenu" id="botDropdown"></div>
        </div>

        <button class="btnIcon" id="botSpeak" type="button" title="Geri oku / Mute">
          <svg viewBox="0 0 24 24"><path d="M11 5L6 9H3v6h3l5 4z"></path><path d="M15 9a4 4 0 0 1 0 6"></path></svg>
        </button>
      </div>
      <div class="content" id="botBody"></div>
    </section>

    <div class="micSlot bottom">
      <button class="micBtn" id="botMic" aria-label="Mikrofon Alt" type="button">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
      </button>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { BASE_DOMAIN } from "/js/config.js";

  const $ = (id)=>document.getElementById(id);
  const base = String(BASE_DOMAIN||"").replace(/\/+$/,"");
  const API_TOKEN = (localStorage.getItem("italky_api_token") || "").trim();

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__to);
    window.__to = setTimeout(()=>t.classList.remove("show"), 2200);
  }

  $("backBtn").addEventListener("click", ()=>{
    if(history.length>1) history.back();
    else location.href="/pages/home.html";
  });

  /* Dil listesi */
  const LANGS = [
    { code:"en", name:"English", flag:"üá¨üáß", sr:"en-US", tts:"en-US" },
    { code:"tr", name:"T√ºrk√ße", flag:"üáπüá∑", sr:"tr-TR", tts:"tr-TR" },
    { code:"de", name:"Almanca", flag:"üá©üá™", sr:"de-DE", tts:"de-DE" },
    { code:"fr", name:"Fransƒ±zca", flag:"üá´üá∑", sr:"fr-FR", tts:"fr-FR" },
    { code:"it", name:"ƒ∞talyanca", flag:"üáÆüáπ", sr:"it-IT", tts:"it-IT" },
    { code:"es", name:"ƒ∞spanyolca", flag:"üá™üá∏", sr:"es-ES", tts:"es-ES" },
    { code:"ru", name:"Rus√ßa", flag:"üá∑üá∫", sr:"ru-RU", tts:"ru-RU" },
    { code:"ar", name:"Arap√ßa", flag:"üá∏üá¶", sr:"ar-SA", tts:"ar-SA" },
  ];
  const L = (c)=>LANGS.find(x=>x.code===c) || LANGS[0];
  const label = (c)=>`${L(c).flag} ${L(c).name}`;

  let topLang = "en";
  let botLang = "tr";

  $("topLangTxt").textContent = label(topLang);
  $("botLangTxt").textContent = label(botLang);

  // --- DROPDOWN FONKSƒ∞YONLARI ---
  
  function createDropdownItems(containerId, side) {
    const container = $(containerId);
    container.innerHTML = "";
    
    LANGS.forEach(l => {
        const item = document.createElement("div");
        item.className = "dropItem";
        item.innerHTML = `<span>${l.flag}</span> <span>${l.name}</span>`;
        item.onclick = (e) => {
            e.stopPropagation(); // Butona tƒ±klamayƒ± engelle
            if(side === "top") {
                topLang = l.code;
                $("topLangTxt").textContent = label(topLang);
                // toast("√úst dil: " + l.name);
            } else {
                botLang = l.code;
                $("botLangTxt").textContent = label(botLang);
                // toast("Alt dil: " + l.name);
            }
            closeAllDropdowns();
        };
        container.appendChild(item);
    });
  }

  // ƒ∞lk y√ºklemede listeleri olu≈ütur
  createDropdownItems("topDropdown", "top");
  createDropdownItems("botDropdown", "bot");

  function toggleDropdown(id) {
    const el = $(id);
    const isOpen = el.classList.contains("show");
    closeAllDropdowns(); // Diƒüerlerini kapat
    if(!isOpen) el.classList.add("show");
  }

  function closeAllDropdowns() {
    document.querySelectorAll(".dropdownMenu").forEach(el => el.classList.remove("show"));
  }

  // Buton Tƒ±klamalarƒ± (Eskiden cycleLang vardƒ±, ≈üimdi toggle var)
  $("topLangBtn").addEventListener("click", (e)=>{
    e.stopPropagation();
    toggleDropdown("topDropdown");
  });

  $("botLangBtn").addEventListener("click", (e)=>{
    e.stopPropagation();
    toggleDropdown("botDropdown");
  });

  // Ekranda bo≈ü yere tƒ±klayƒ±nca kapat
  window.addEventListener("click", () => {
    closeAllDropdowns();
  });

  // --- Dƒ∞ƒûER KODLAR AYNI KALIYOR ---

  function addBubble(where, role, text){
    const wrap = $(where);
    const d = document.createElement("div");
    d.className = `bubble ${role}`;
    d.textContent = text || "‚Äî";
    wrap.appendChild(d);
    wrap.scrollTop = wrap.scrollHeight;
  }

  function clearChat(){
    $("topBody").innerHTML = "";
    $("botBody").innerHTML = "";
    toast("Sohbet temizlendi");
  }
  $("clearBtn").addEventListener("click", clearChat);

  async function pingTranslate(){
    if(!base) { toast("BASE_DOMAIN yok"); return; }
    try{
      const r = await fetch(`${base}/api/translate/_ping`, { method:"GET" });
      const d = await r.json().catch(()=> ({}));
      if(d?.ok) toast("√áeviri motoru hazƒ±r");
      else toast("√áeviri hazƒ±r deƒüil");
    }catch{
      toast("API eri≈üilemiyor");
    }
  }
  pingTranslate();

  async function translateViaApi(text, source, target){
    if(!base) return text;

    const headers = { "Content-Type":"application/json" };
    if(API_TOKEN) headers["Authorization"] = `Bearer ${API_TOKEN}`;

    const body = { text, source, target, from_lang: source, to_lang: target };

    const r = await fetch(`${base}/api/translate`,{
      method:"POST",
      headers,
      body: JSON.stringify(body)
    });

    const raw = await r.text().catch(()=> "");
    if(!r.ok){
      throw new Error(`HTTP ${r.status} ${raw.slice(0,120)}`);
    }

    let data = {};
    try{ data = JSON.parse(raw || "{}"); }catch{}

    const out = String(
      data?.translated || data?.translation || data?.text || data?.translated_text || ""
    ).trim();

    return out || text;
  }

  // TTS
  const muted = { top:false, bot:false };

  function speak(text, langCode){
    const t = String(text||"").trim();
    if(!t) return;
    if(!("speechSynthesis" in window)) return;
    try{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = L(langCode).tts || "en-US";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch{}
  }

  function lastTextOf(el){
    const nodes = Array.from(el.querySelectorAll(".bubble"));
    for(let i=nodes.length-1;i>=0;i--){
      const txt = (nodes[i].textContent||"").trim();
      if(txt) return txt;
    }
    return "";
  }

  $("topSpeak").addEventListener("click", ()=>{
    muted.top = !muted.top;
    $("topSpeak").classList.toggle("muted", muted.top);
    if(!muted.top){
      const txt = lastTextOf($("topBody"));
      if(txt) speak(txt, topLang);
      else toast("√ústte okunacak mesaj yok");
    }else toast("√úst ses kapalƒ±");
  });

  $("botSpeak").addEventListener("click", ()=>{
    muted.bot = !muted.bot;
    $("botSpeak").classList.toggle("muted", muted.bot);
    if(!muted.bot){
      const txt = lastTextOf($("botBody"));
      if(txt) speak(txt, botLang);
      else toast("Altta okunacak mesaj yok");
    }else toast("Alt ses kapalƒ±");
  });

  // SpeechRecognition
  function buildRecognizer(langCode){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const rec = new SR();
    rec.lang = L(langCode).sr || "en-US";
    rec.interimResults = false;
    rec.continuous = false;
    return rec;
  }

  let busy = false;

  async function runFlow(fromSide, text){
    if(fromSide === "top"){
      addBubble("topBody", "them", text);

      const out = await translateViaApi(text, topLang, botLang);
      addBubble("botBody", "me", out);

      if(!muted.bot) speak(out, botLang);
    }else{
      addBubble("botBody", "them", text);

      const out = await translateViaApi(text, botLang, topLang);
      addBubble("topBody", "me", out);

      if(!muted.top) speak(out, topLang);
    }
  }

  async function startMic(side){
    if(busy) return;

    const lang = (side==="top") ? topLang : botLang;
    const btn = (side==="top") ? $("topMic") : $("botMic");
    const rec = buildRecognizer(lang);

    if(!rec){
      toast("Bu cihaz konu≈ümayƒ± yazƒ±ya √ßevirmiyor.");
      return;
    }

    busy = true;
    btn.classList.add("listening");

    rec.onresult = async (e)=>{
      const t = e.results?.[0]?.[0]?.transcript || "";
      const finalText = String(t||"").trim();
      if(!finalText) return;

      try{
        await runFlow(side, finalText);
      }catch(err){
        toast("√áeviri hata: " + String(err?.message || err).slice(0,120));
        if(side === "top") addBubble("botBody", "me", finalText);
        else addBubble("topBody", "me", finalText);
      }
    };

    rec.onerror = ()=>{
      toast("Mikrofon izin/HTTPS/cihaz sorunu olabilir.");
    };

    rec.onend = ()=>{
      btn.classList.remove("listening");
      busy = false;
    };

    try{ rec.start(); }
    catch{
      btn.classList.remove("listening");
      busy = false;
      toast("Mikrofon a√ßƒ±lamadƒ±");
    }
  }

  $("topMic").addEventListener("click", ()=> startMic("top"));
  $("botMic").addEventListener("click", ()=> startMic("bot"));

  addBubble("botBody","meta","Mikrofona bas ‚Üí konu≈ü ‚Üí otomatik √ßeviri.");
</script>

</body>
</html>
