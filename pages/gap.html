<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ITALKY ‚Ä¢ Gap Master</title>
  <link rel="icon" href="data:,"/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <style>
    /* --- TASARIM (Cosmos Tema) --- */
    :root { 
      --bg-deep:#020205; 
      --text-main:#fff; 
      --c-accent:#ffb800; /* Altƒ±n */
      --c-success:#00e676; 
      --c-error:#ff1744; 
      --border:rgba(255,255,255,0.1); 
    }
    
    * { box-sizing:border-box; outline:none; user-select:none; }
    html,body { margin:0; height:100dvh; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); }
    
    .cosmos-bg { position:absolute; inset:0; background:radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.3; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; animation: dustMove 100s linear infinite; } 
    @keyframes dustMove { from { transform: translateY(0); } to { transform: translateY(-500px); } }
    
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; }
    
    /* NAV */
    .nav-layer { position:absolute; top:0; left:0; width:100%; height:70px; z-index:50; display:flex; justify-content:space-between; padding:12px; pointer-events:none; }
    .nav-btn { pointer-events:auto; height:44px; padding:0 16px; border-radius:14px; background:rgba(0,0,0,0.4); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); cursor:pointer; font-weight:700; transition:0.2s; }
    .nav-btn:active { transform:scale(0.95); }
    .brand-mini { pointer-events:auto; display:flex; flex-direction:column; align-items:center; cursor:pointer; } 
    .brand-mini span { font-family:'Space Grotesk', sans-serif; font-weight:700; font-size:20px; line-height:1; } 
    .brand-mini small { font-size:9px; letter-spacing:3px; opacity:0.6; color:var(--c-accent); }
    
    /* OYUN ALANI */
    .game-stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; padding-top:60px; position:relative; }
    
    .puzzle-card { 
      width:100%; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:24px; padding:30px 20px; text-align:center; backdrop-filter:blur(10px); box-shadow:0 20px 60px rgba(0,0,0,0.5); transition:0.3s; 
    }
    
    .sentence-container { 
      font-size:26px; font-weight:600; line-height:1.6; color:rgba(255,255,255,0.9); min-height:100px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:8px; 
    }
    
    .gap-slot { 
      display:inline-block; min-width:80px; height:40px; border-bottom:3px solid var(--c-accent); color:var(--c-accent); font-weight:800; text-align:center; transition:0.3s; 
    }
    .gap-slot.filled { border-bottom-color:var(--c-success); color:var(--c-success); transform:scale(1.1); }
    .gap-slot.error { border-bottom-color:var(--c-error); animation:shake 0.4s; }
    
    .translation { 
      margin-top:24px; font-size:16px; opacity:0; transform:translateY(10px); transition:all 0.5s ease; font-weight:500; color:var(--c-success); 
    } 
    .translation.show { opacity:1; transform:translateY(0); }
    
    /* KONTROLLER */
    .controls { padding:40px; width:100%; display:flex; flex-direction:column; align-items:center; gap:20px; }
    
    .mic-btn { 
      width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.08); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; box-shadow:0 10px 40px rgba(0,0,0,0.3); 
    }
    .mic-btn svg { width:32px; height:32px; stroke:#fff; fill:none; stroke-width:2; transition:0.3s; }
    .mic-btn:active { transform:scale(0.95); }
    .mic-btn.listening { background:#fff; box-shadow:0 0 30px rgba(255,184,0,0.4); animation:pulseMic 1.5s infinite; } 
    .mic-btn.listening svg { stroke:#000; }
    
    .status-text { font-family:'Space Grotesk', sans-serif; font-weight:700; font-size:14px; opacity:0.7; letter-spacing:1px; text-transform:uppercase; height:20px; }
    
    /* MODAL */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(20px); } 
    .modal-card { width:85%; background:#101014; border:1px solid var(--border); border-radius:32px; padding:32px; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,1); animation:popIn 0.5s; }
    .modal-title { font-size:24px; font-weight:800; margin-bottom:12px; color:var(--c-accent); font-family:'Space Grotesk', sans-serif; }
    .modal-p { font-size:15px; opacity:0.7; margin-bottom:32px; line-height:1.6; }
    
    .btn-primary { width:100%; padding:16px; border-radius:16px; border:none; background:linear-gradient(135deg, var(--c-accent), #ff8800); color:#000; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 10px 30px rgba(255,184,0,0.3); transition:0.2s; }
    .btn-primary:active { transform:scale(0.98); }
    
    .loader { border:4px solid rgba(255,255,255,0.1); border-top:4px solid var(--c-accent); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px; }
    
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } } 
    @keyframes pulseMic { 0% { box-shadow:0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow:0 0 0 20px rgba(255,255,255,0); } 100% { box-shadow:0 0 0 0 rgba(255,255,255,0); } } 
    @keyframes shake { 0% { transform:translateX(0); } 25% { transform:translateX(-5px); } 50% { transform:translateX(5px); } 75% { transform:translateX(-5px); } 100% { transform:translateX(0); } } 
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>

  <div class="wrap">
    <div class="nav-layer">
      <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚Üê</button>
      <div class="brand-mini" onclick="window.location.href='/pages/home.html'">
        <span>italky<span style="color:var(--c-accent)">AI</span></span>
        <small>GAP MASTER</small>
      </div>
      <div class="nav-btn" id="scoreBadge">üèÜ 0</div>
    </div>

    <div class="game-stage">
      <div class="puzzle-card">
        <div class="sentence-container" id="sentenceBox">Y√ºkleniyor...</div>
        <div class="translation" id="translationBox"></div>
      </div>
    </div>

    <div class="controls">
      <div class="status-text" id="statusText">HAZIR</div>
      <button class="mic-btn" id="micBtn">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">C√úMLE TAMAMLAMA üß©</div>
      <div class="modal-p">
        1. C√ºmleyi Dinle (Bo≈ülukta susacak)<br>
        2. Eksik Kelimeyi S√∂yle<br>
        3. Doƒüruysa AI tamamƒ±nƒ± okur!
      </div>
      <div id="loading" style="display:none;margin-bottom:20px"><div class="loader"></div><div>Hazƒ±rlanƒ±yor...</div></div>
      <button class="btn-primary" id="startBtn">BA≈ûLA</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// SES Sƒ∞STEMƒ∞ (Lazy Load & Fix)
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = AC ? new AC() : null;
  }
  if(audioCtx && audioCtx.state === "suspended"){
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}

const SFX = {
  correct: () => {
    const ctx = ensureAudio(); if(!ctx) return;
    const t = ctx.currentTime;
    [523,659,783].forEach((f,i)=>{
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.frequency.value = f; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(.05, t+i*.1); g.gain.exponentialRampToValueAtTime(.001, t+i*.1+.3);
      o.start(t+i*.1); o.stop(t+i*.1+.3);
    });
  },
  wrong: () => {
    const ctx = ensureAudio(); if(!ctx) return;
    const t = ctx.currentTime, o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'sawtooth'; o.frequency.value = 150; 
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(.1, t); g.gain.linearRampToValueAtTime(.001, t+.3);
    o.start(t); o.stop(t+.3);
  }
};

let puzzleList = [];
let currentIndex = 0;
let score = 0;
let isBusy = false;

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// JSON Parse Helper
function safeParse(raw){
  if(Array.isArray(raw)) return raw;
  let txt = (typeof raw === "string") ? raw : (raw.text || "");
  txt = txt.replace(/```json/gi,"").replace(/```/g,"").trim();
  return JSON.parse(txt);
}

// --- API ---
async function fetchPuzzles() {
  ensureAudio(); // User Gesture
  $("loading").style.display = "block";
  $("startBtn").style.display = "none";

  try {
    const res = await fetch(`${apiBase()}/api/chat`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        text: "Bana ƒ∞ngilizce B1 seviyesinde 10 c√ºmle ver. Bir kelimeyi (fiil/isim) gizle. SADECE JSON formatƒ±nda: [{'sentence_parts':['I drink','every day.'],'hidden_word':'coffee','translation':'Her g√ºn kahve i√ßerim.'},...]",
        max_tokens: 1500 
      })
    });
    const data = await res.json();
    puzzleList = safeParse(data);
    
    if (!Array.isArray(puzzleList) || puzzleList.length < 3) throw new Error("Yetersiz veri");

  } catch (err) {
    puzzleList = [
      {sentence_parts:["The sky is","today."], hidden_word:"blue", translation:"Bug√ºn g√∂ky√ºz√º mavi."},
      {sentence_parts:["I drink","water."], hidden_word:"cold", translation:"Soƒüuk su i√ßerim."},
      {sentence_parts:["She likes","music."], hidden_word:"good", translation:"O iyi m√ºzik sever."}
    ];
  }
  
  $("startModal").style.display = "none";
  loadPuzzle();
}

function loadPuzzle() {
  if (currentIndex >= puzzleList.length) {
    alert(`Oyun Bitti! Toplam Puan: ${score}`);
    location.reload();
    return;
  }

  const p = puzzleList[currentIndex];
  $("translationBox").className = "translation";
  $("translationBox").textContent = p.translation;
  
  $("sentenceBox").innerHTML = `
    <span>${p.sentence_parts[0]}</span>
    <span class="gap-slot" id="gapSlot">_____</span>
    <span>${p.sentence_parts[1]}</span>
  `;
  
  $("statusText").textContent = "Dƒ∞NLE VE CEVAPLA";
  setTimeout(() => speakPuzzle(p), 1000);
}

// --- TTS ---
function speakPuzzle(p) {
  if (isBusy) return;
  isBusy = true;
  $("micBtn").disabled = true;
  
  // Bo≈üluk efekti
  const text = `${p.sentence_parts[0]} ... ${p.sentence_parts[1]}`;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US"; u.rate = 0.85;
  
  u.onend = () => {
    isBusy = false;
    $("micBtn").disabled = false;
    $("statusText").textContent = "Mƒ∞KROFONA BASIP S√ñYLE";
  };
  
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function speakFullSentence(p) {
  return new Promise(resolve => {
    isBusy = true;
    $("statusText").textContent = "Dƒ∞NLE VE √ñƒûREN...";
    const u = new SpeechSynthesisUtterance(`${p.sentence_parts[0]} ${p.hidden_word} ${p.sentence_parts[1]}`);
    u.lang = "en-US"; u.rate = 0.9;
    u.onend = () => { isBusy = false; resolve(); };
    window.speechSynthesis.speak(u);
  });
}

// --- STT ---
function listen() {
  if (isBusy) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return alert("Tarayƒ±cƒ± desteklemiyor.");
  
  try{ window.speechSynthesis.cancel(); }catch{}
  
  isBusy = true;
  $("micBtn").classList.add("listening");
  $("statusText").textContent = "Dƒ∞NLƒ∞YOR...";
  
  const rec = new SR();
  rec.lang = "en-US";
  rec.interimResults = false;
  let gotResult = false;
  
  rec.onresult = (e) => {
    gotResult = true;
    checkAnswer(e.results[0][0].transcript.toLowerCase().trim());
  };
  
  rec.onend = () => {
    $("micBtn").classList.remove("listening");
    if (!gotResult) { isBusy = false; $("statusText").textContent = "SES GELMEDƒ∞"; }
  };
  
  try{ rec.start(); }catch{ isBusy = false; }
}

async function checkAnswer(input) {
  isBusy = false; 
  const p = puzzleList[currentIndex];
  const target = p.hidden_word.toLowerCase().trim();
  const slot = $("gapSlot");

  // Toleranslƒ± Kontrol
  if (input.includes(target) || target.includes(input)) {
    // DOƒûRU
    SFX.correct();
    slot.textContent = target.toUpperCase();
    slot.classList.remove("error");
    slot.classList.add("filled");
    score += 10;
    $("scoreBadge").textContent = `üèÜ ${score}`;
    $("statusText").textContent = "DOƒûRU!";
    
    // √áeviri + Tam C√ºmle
    $("translationBox").classList.add("show");
    await sleep(500);
    await speakFullSentence(p);
    
    setTimeout(() => { currentIndex++; loadPuzzle(); }, 1500);

  } else {
    // YANLI≈û
    SFX.wrong();
    slot.classList.add("error");
    $("statusText").textContent = `YANLI≈û: "${input}"`;
    setTimeout(() => slot.classList.remove("error"), 1000);
  }
}

$("startBtn").onclick = fetchPuzzles;
$("micBtn").onclick = () => { ensureAudio(); listen(); };

</script>
</body>
</html>
