<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Gap Master</title>
  <link rel="icon" href="data:,"/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-deep: #020205; --text-main: #fff; --c-accent: #ffb800;
      --c-ok: #00e676; --c-bad: #ff1744; --border: rgba(255,255,255,.12);
      --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { margin: 0; width: 100%; height: 100%; background: var(--bg-deep); color: var(--text-main); font-family: 'Outfit', sans-serif; overflow: hidden; position: fixed; }
    
    .wrap { max-width: 480px; height: 100%; margin: 0 auto; display: flex; flex-direction: column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); position: relative; }
    
    /* HEADER */
    .header { text-align: center; padding: 15px 0; font-family: 'Space Grotesk', sans-serif; font-weight: 900; letter-spacing: 2px; font-size: 20px; color: var(--c-accent); text-shadow: 0 0 15px rgba(255, 184, 0, 0.3); display: flex; justify-content: center; align-items: center; position: relative; }
    
    .nav-btn { position: absolute; right: 15px; width: 36px; height: 36px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 8px; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

    /* GAME AREA */
    .stage { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
    
    .scorebar { display: flex; justify-content: space-between; font-family: 'Space Grotesk', sans-serif; font-weight: 800; font-size: 16px; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border); }
    
    .card { background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 24px; padding: 30px 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    
    .sentence { font-size: 24px; font-weight: 700; line-height: 1.5; }
    .gap { display: inline-block; min-width: 60px; border-bottom: 3px solid var(--c-accent); padding: 0 5px; color: var(--c-accent); font-weight: 800; }
    .gap.filled { border-color: var(--c-ok); color: var(--c-ok); animation: popIn 0.3s; }
    .gap.error { border-color: var(--c-bad); color: var(--c-bad); }
    .translation { margin-top: 15px; font-size: 14px; opacity: 0.6; font-style: italic; }

    .opts { display: grid; gap: 12px; margin-top: auto; }
    .opt { padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: rgba(255,255,255,.06); font-weight: 700; font-size: 18px; color: #fff; cursor: pointer; transition: 0.1s; text-transform: uppercase; }
    .opt:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
    .opt.correct { border-color: var(--c-ok); color: var(--c-ok); background: rgba(0, 230, 118, 0.15); }
    .opt.wrong { border-color: var(--c-bad); color: var(--c-bad); background: rgba(255, 23, 68, 0.15); opacity: 0.6; }

    /* MODAL */
    .modal { position: absolute; inset: 0; background: rgba(0,0,0,.95); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 20px; backdrop-filter: blur(10px); }
    .box { background: #101014; border: 1px solid var(--border); border-radius: 30px; padding: 30px; width: 100%; max-width: 360px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
    
    .modal-title { font-family: 'Space Grotesk'; font-size: 24px; font-weight: 800; margin-bottom: 20px; color: var(--c-accent); }
    
    .langs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
    .lang { border: 1px solid var(--border); border-radius: 10px; padding: 10px 0; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.05); transition: 0.2s; }
    .lang.active { background: var(--c-accent); border-color: var(--c-accent); transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 184, 0, 0.4); }
    
    .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; font-size: 16px; background: linear-gradient(135deg, var(--c-accent), #ff8800); color: #000; cursor: pointer; box-shadow: 0 5px 20px rgba(255, 136, 0, 0.3); transition: 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sec { background: rgba(255,255,255,0.1); color: #fff; margin-top: 10px; box-shadow: none; }

    .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--c-accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    GAP MASTER
    <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚úï</button>
  </div>

  <div class="stage" id="gameStage">
    <div class="scorebar">
      <div id="scoreTxt">0 PUAN</div>
      <div id="lifeTxt">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div class="card">
      <div class="sentence" id="sentence">...</div>
      <div class="translation" id="translation">...</div>
    </div>

    <div class="opts" id="opts"></div>
  </div>
</div>

<div class="modal" id="startModal">
  <div class="box">
    <div class="modal-title">GAP MASTER üß©</div>
    <div style="margin-bottom:10px; opacity:0.7">Hedef Dili Se√ß:</div>
    <div class="langs">
      <div class="lang active" data-lang="en">üá¨üáß</div>
      <div class="lang" data-lang="de">üá©üá™</div>
      <div class="lang" data-lang="fr">üá´üá∑</div>
      <div class="lang" data-lang="es">üá™üá∏</div>
      <div class="lang" data-lang="it">üáÆüáπ</div>
    </div>
    <div id="loading" style="display:none"><div class="loader"></div><div>Hazƒ±rlanƒ±yor...</div></div>
    <button class="btn" id="startBtn">BA≈ûLA</button>
  </div>
</div>

<div class="modal" id="endModal" style="display:none">
  <div class="box">
    <div class="modal-title" id="endTitle">OYUN Bƒ∞TTƒ∞</div>
    <div id="endTxt" style="font-size:18px; margin-bottom:20px; opacity:0.8"></div>
    <button class="btn" id="retryBtn">TEKRAR OYNA</button>
    <button class="btn btn-sec" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);

let currentLang = "en";
let pool = null;
let puzzles = [];
let idx = 0;
let score = 0;
let lives = 3;

const LANG_CONFIG = {
  en: { code: "en-US", defSent: "This is [w]." },
  de: { code: "de-DE", defSent: "Das ist [w]." },
  fr: { code: "fr-FR", defSent: "C'est [w]." },
  es: { code: "es-ES", defSent: "Es [w]." },
  it: { code: "it-IT", defSent: "√à [w]." }
};

// Dƒ∞L SE√áƒ∞Mƒ∞ UI
document.querySelectorAll(".lang").forEach(b => {
  b.onclick = () => {
    document.querySelectorAll(".lang").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    currentLang = b.dataset.lang;
  };
});

// OYUNU BA≈ûLAT
$("#startBtn").onclick = () => {
  initGame();
};

// YENƒ∞DEN OYNA (RETRY) - PATCH 4
$("#retryBtn").onclick = () => {
  $("#endModal").style.display = "none";
  $("#startModal").style.display = "flex"; // Loader'ƒ± g√∂rmek i√ßin ana modalƒ± a√ß
  initGame();
};

// REGEX ESCAPE - PATCH 3
function escapeRegExp(s){
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

async function initGame() {
  $("#endModal").style.display = "none";
  $("#startBtn").disabled = true;
  $("#loading").style.display = "block"; // PATCH 1: Loader g√∂r√ºn√ºr

  try {
    // 1. Havuzu Y√ºkle
    pool = await loadLangPool(currentLang);
    
    if (!pool || pool.length === 0) {
      throw new Error("Dil verisi y√ºklenemedi!");
    }

    // 2. Kullanƒ±lanlarƒ± Y√∂net (Tekrarƒ± √∂nle)
    const { used, save } = createUsedSet("gapmaster_" + currentLang);

    // 3. Kelime Se√ß (En az 3 harfli)
    const words = pick(pool, 15, used, save, it => {
      const w = String(it.w || "").trim();
      return w.length >= 3;
    });

    // 4. Puzzle Olu≈ütur
    const allWords = pool.map(x => x.w); 
    
    puzzles = words.map(it => {
      const w = it.w;
      const ew = escapeRegExp(w);
      
      let rawSent = it.sentence || it.ex || LANG_CONFIG[currentLang].defSent.replace("[w]", w);
      
      // PATCH 3: G√ºvenli Regex + Fallback
      // √ñnce case-insensitive kelime sƒ±nƒ±rƒ± ile dene
      let regex = new RegExp(`\\b${ew}\\b`, 'i');
      let finalSent = rawSent.replace(regex, "_____");
      
      // Eƒüer kelime sƒ±nƒ±rƒ± (\b) unicode y√ºz√ºnden √ßalƒ±≈ümazsa direkt replace dene
      if (!finalSent.includes("_____")) {
         regex = new RegExp(ew, 'i');
         finalSent = rawSent.replace(regex, "_____");
      }
      
      // H√¢l√¢ bo≈üluk yoksa (kelime c√ºmlede hi√ß yoksa), default c√ºmleyi kullan
      if (!finalSent.includes("_____")) {
         finalSent = LANG_CONFIG[currentLang].defSent.replace("[w]", "_____");
      }

      // PATCH 5: Benzersiz ≈ûƒ±klar
      const opts = shuffle([w, ...randomOpts(allWords, w, 3)]);
      
      return {
        sentence: finalSent,
        answer: w,
        translation: it.tr,
        opts: opts
      };
    });

    // 5. UI Sƒ±fƒ±rla ve Ba≈ülat
    idx = 0;
    score = 0;
    lives = 3;
    
    $("#loading").style.display = "none";
    $("#startBtn").disabled = false;
    $("#startModal").style.display = "none"; // Her ≈üey hazƒ±rsa kapat
    
    updateUI();
    loadPuzzle();

  } catch (err) {
    console.error(err);
    alert("Oyun ba≈ülatƒ±lamadƒ±: " + err.message);
    $("#startBtn").disabled = false;
    $("#loading").style.display = "none";
  }
}

// PATCH 5: BENZERSƒ∞Z YANLI≈û ≈ûIK √úRETƒ∞Cƒ∞
function randomOpts(allList, correct, count) {
  // Doƒüru cevabƒ± hari√ß tut
  const filtered = allList.filter(x => x && x.toLowerCase() !== correct.toLowerCase());
  const shuffled = shuffle(filtered);
  const uniq = [];
  
  for(const x of shuffled){
    // ≈ûƒ±klar arasƒ±nda tekrar olmasƒ±n
    if(!uniq.some(u => u.toLowerCase() === String(x).toLowerCase())) {
        uniq.push(x);
    }
    if(uniq.length === count) break;
  }
  return uniq;
}

function loadPuzzle() {
  // PATCH 2: Win Condition
  if (lives <= 0) { 
      endGame(false); // Kaybetti
      return; 
  }
  if (idx >= puzzles.length) { 
      endGame(true); // Kazandƒ±
      return; 
  }

  const p = puzzles[idx];
  
  // C√ºmleyi Yerle≈ütir
  $("#sentence").innerHTML = p.sentence.replace("_____", "<span class='gap'>_____</span>");
  $("#translation").textContent = p.translation || "";
  
  // ≈ûƒ±klarƒ± Yerle≈ütir
  const grid = $("#opts");
  grid.innerHTML = "";
  
  p.opts.forEach(o => {
    const b = document.createElement("button");
    b.className = "opt";
    b.textContent = o;
    b.onclick = () => handleChoice(b, o, p);
    grid.appendChild(b);
  });
}

async function handleChoice(btn, choice, p) {
  // T√ºm butonlarƒ± kilitle
  document.querySelectorAll(".opt").forEach(x => x.disabled = true);

  if (choice.toLowerCase() === p.answer.toLowerCase()) {
    // DOƒûRU
    btn.classList.add("correct");
    score += 10;
    
    // Bo≈üluƒüu doldur
    const gap = document.querySelector(".gap");
    if(gap) {
        gap.textContent = p.answer;
        gap.classList.add("filled");
    }
    
    await speak(p.answer);
  } else {
    // YANLI≈û
    btn.classList.add("wrong");
    lives--;
    
    // Doƒüruyu g√∂ster
    document.querySelectorAll(".opt").forEach(x => {
      if (x.textContent.toLowerCase() === p.answer.toLowerCase()) x.classList.add("correct");
    });
    
    const gap = document.querySelector(".gap");
    if(gap) {
        gap.textContent = p.answer;
        gap.classList.add("error");
    }
  }

  updateUI();
  
  // Sonraki soruya ge√ß
  setTimeout(() => {
    idx++;
    loadPuzzle();
  }, 1200);
}

function updateUI() {
  $("#scoreTxt").textContent = `${score} PUAN`;
  $("#lifeTxt").textContent = lives > 0 ? "‚ù§Ô∏è".repeat(lives) + "ü§ç".repeat(3 - lives) : "üíÄüíÄüíÄ";
}

// PATCH 2: Parametreli EndGame
function endGame(win) {
  $("#endModal").style.display = "flex";
  $("#endTitle").textContent = win ? "TEBRƒ∞KLER! üèÜ" : "OYUN Bƒ∞TTƒ∞";
  $("#endTitle").style.color = win ? "var(--c-ok)" : "var(--c-bad)";
  $("#endTxt").innerHTML = `Skor: <b style="color:#fff">${score}</b><br>${win ? 'Harika i≈ü √ßƒ±kardƒ±n!' : 'Bir dahaki sefere!'}`;
}

function speak(t) {
  return new Promise(res => {
    try { speechSynthesis.cancel(); } catch {}
    const u = new SpeechSynthesisUtterance(t);
    u.lang = LANG_CONFIG[currentLang].code || "en-US";
    u.rate = 0.9;
    u.onend = res;
    u.onerror = res;
    try { speechSynthesis.speak(u); } catch { res(); }
  });
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
</script>
</body>
</html>
