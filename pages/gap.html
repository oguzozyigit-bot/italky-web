<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Gap Master Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-deep: #020205; --c-neon-blue: #00f3ff; --c-neon-pink: #ff00ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --border: rgba(255, 255, 255, 0.12);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); z-index:0; }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }

    .nav-top { display:flex; align-items:center; justify-content:space-between; padding: 15px 18px; }
    .back-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); width:40px; height:40px; border-radius:12px; color:#fff; text-decoration:none; display:flex; align-items:center; justify-content:center; }

    .stats-row { padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: center; }
    
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 10px 20px; gap: 20px; }
    
    .sentence-card { 
      width:100%; background: rgba(255,255,255,0.04); 
      border: 1px solid var(--border); border-radius: 28px; padding: 40px 20px; text-align: center; backdrop-filter: blur(20px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .sentence-text { font-size: 24px; font-weight: 700; line-height: 1.6; margin-bottom: 25px; }
    .gap-placeholder { color: var(--c-neon-blue); border-bottom: 2px solid var(--c-neon-blue); padding: 0 10px; }
    .translation-text { font-size: 16px; color: var(--c-neon-green); font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
    
    /* OPTIONS GRID */
    .options-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 10px; }
    .opt-btn { 
      width: 100%; padding: 18px; background: rgba(255,255,255,0.07); 
      border: 1px solid var(--border); border-radius: 16px; color: #fff; 
      font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    }
    .opt-btn.correct { background: var(--c-neon-green) !important; color: #000; border-color: transparent; }
    .opt-btn.wrong { background: var(--c-error) !important; color: #fff; border-color: transparent; }
    .opt-btn:active { transform: scale(0.98); }

    /* MODALS */
    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-card { width: 100%; max-width: 340px; background: #08080c; border: 1px solid var(--border); border-radius: 30px; padding: 30px; text-align: center; }
    .btn-main { width: 100%; padding: 16px; background: var(--c-neon-green); color: #000; border: none; border-radius: 18px; font-weight: 900; cursor: pointer; margin-top: 10px; }
    .lang-btn { font-size: 24px; padding: 8px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid transparent; cursor: pointer; margin: 5px; }
    .lang-btn.active { border-color: var(--c-neon-blue); background: rgba(0,243,255,0.1); }
  </style>
</head>
<body>

  <div class="cosmos-bg"></div>

  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">‚Üê</a>
      <div style="font-size:22px; font-weight:900;">italky<span style="color:var(--c-neon-blue)">AI</span></div>
      <div id="scoreTxt" style="color:var(--c-neon-green); font-weight:800;">0 PUAN</div>
    </div>

    <div class="stats-row">
      <div id="lifeDisplay" style="color:var(--c-neon-pink); font-size:18px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div class="stage">
      <div class="sentence-card">
        <div id="sentenceDisplay" class="sentence-text"></div>
        <div id="translationDisplay" class="translation-text"></div>
      </div>
      <div class="options-grid" id="optionsGrid"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin-bottom:20px">Dilinizi Se√ßin</h2>
      <div id="langSelector">
        <button onclick="setLang('en',this)" class="lang-btn active">üá¨üáß</button>
        <button onclick="setLang('de',this)" class="lang-btn">üá©üá™</button>
        <button onclick="setLang('fr',this)" class="lang-btn">üá´üá∑</button>
        <button onclick="setLang('es',this)" class="lang-btn">üá™üá∏</button>
        <button onclick="setLang('it',this)" class="lang-btn">üáÆüáπ</button>
      </div>
      <button class="btn-main" onclick="initGame('A2')">BA≈ûLA (KOLAY)</button>
      <button class="btn-main" style="margin-top:10px" onclick="initGame('B1')">ORTA SEVƒ∞YE</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let currentLang = 'en', puzzles = [], currentIdx = 0;
let score = 0, lives = 3, isBusy = false;

// SES EFEKTLERƒ∞ ‚úÖ
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type = 'sine', duration = 0.1) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + duration);
}

window.setLang = (l, btn) => {
    currentLang = l;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

window.initGame = async (diff) => {
    try {
        const rawPool = await loadLangPool(currentLang);
        const { used, save } = createUsedSet(`gapmaster_v6_${currentLang}_${diff}`);
        
        // C√ºmlesi olan kelimeleri se√ß
        puzzles = pick(rawPool, 15, used, save, it => it.sentence && it.lvl === diff);

        $('startModal').style.display = 'none';
        loadPuzzle();
    } catch (e) { alert("Hata olu≈ütu."); }
};

function loadPuzzle() {
    if (lives <= 0 || currentIdx >= puzzles.length) {
        alert("Oyun Bitti. Toplam Puan: " + score);
        location.reload();
        return;
    }

    const p = puzzles[currentIdx];
    const sentence = p.sentence.toUpperCase();
    const word = p.w.toUpperCase();
    
    // C√ºmleyi ve √ßeviriyi hazƒ±rla
    $('sentenceDisplay').innerHTML = sentence.replace(new RegExp(`\\b${word}\\b`, 'g'), '<span class="gap-placeholder">____</span>');
    $('translationDisplay').textContent = p.tr;

    // ≈ûƒ±klarƒ± olu≈ütur (1 doƒüru + 4 yanlƒ±≈ü) ‚úÖ
    const options = [p.w];
    const pool = puzzles.filter(x => x.w !== p.w);
    for(let i=0; i<4; i++) {
        if(pool[i]) options.push(pool[i].w);
        else options.push(["WATER", "HOUSE", "FRIEND", "GO", "TIME"][i]);
    }
    
    renderOptions(options.sort(() => Math.random() - 0.5));
}

function renderOptions(opts) {
    const grid = $('optionsGrid');
    grid.innerHTML = '';
    opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn';
        btn.textContent = opt.toUpperCase();
        btn.onclick = () => handleChoice(opt.toUpperCase(), btn);
        grid.appendChild(btn);
    });
}

function handleChoice(val, btn) {
    if (isBusy) return;
    const correctVal = puzzles[currentIdx].w.toUpperCase();
    isBusy = true;

    if (val === correctVal) {
        playSound(600, 'sine', 0.2); // Ba≈üarƒ± sesi
        btn.classList.add('correct');
        score += 10;
        $('scoreTxt').textContent = `${score} PUAN`;
        speak(puzzles[currentIdx].sentence);
    } else {
        playSound(200, 'square', 0.2); // Hata sesi
        btn.classList.add('wrong');
        lives--;
        $('lifeDisplay').textContent = "‚ù§Ô∏è".repeat(lives);
        // Doƒüru ≈üƒ±kkƒ± g√∂ster
        document.querySelectorAll('.opt-btn').forEach(b => {
            if(b.textContent === correctVal) b.classList.add('correct');
        });
    }

    setTimeout(() => {
        currentIdx++;
        isBusy = false;
        loadPuzzle();
    }, 1800);
}

function speak(t) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    const m = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    u.lang = m[currentLang];
    u.rate = 0.8;
    window.speechSynthesis.speak(u);
}
</script>
</body>
</html>
