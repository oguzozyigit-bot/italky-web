<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI â€¢ Gap Master Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-deep: #020205; --c-neon-blue: #00f3ff; --c-neon-pink: #ff00ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --border: rgba(255, 255, 255, 0.12);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); z-index:0; }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }

    .nav-top { display:flex; align-items:center; justify-content:space-between; padding: 10px 18px; }
    .back-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; color:#fff; text-decoration:none; font-size: 13px; }

    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 10px 20px; gap: 15px; }
    
    .sentence-card { 
      width:100%; background: rgba(255,255,255,0.04); 
      border: 1px solid var(--border); border-radius: 28px; padding: 30px 20px; text-align: center; backdrop-filter: blur(20px);
    }
    .sentence-text { font-size: 22px; font-weight: 700; line-height: 1.5; margin-bottom: 20px; }
    .translation-text { font-size: 16px; color: var(--c-neon-green); font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
    
    .gap-word-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin: 15px 0; }
    .letter-slot { width: 28px; height: 36px; border-bottom: 2px solid var(--c-neon-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; }
    .letter-slot.filled { border-bottom: none; color: #fff; text-shadow: 0 0 10px var(--c-neon-blue); }

    .keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; margin-top: 10px; }
    .key-btn { aspect-ratio: 1; background: rgba(255,255,255,0.08); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .key-btn.wrong { opacity: 0.2; pointer-events: none; }

    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; }
    .modal-card { width: 90%; max-width: 340px; background: #0a0a10; border: 1px solid var(--border); border-radius: 30px; padding: 30px; text-align: center; }
    .btn-main { width: 100%; padding: 16px; background: var(--c-neon-green); color: #000; border: none; border-radius: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; }
    .lang-btn { font-size: 22px; padding: 8px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid transparent; cursor: pointer; margin: 5px; }
    .lang-btn.active { border-color: var(--c-neon-blue); background: rgba(0,243,255,0.1); }
  </style>
</head>
<body>

  <div class="cosmos-bg"></div>
  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">â† Geri</a>
      <div style="font-size:20px; font-weight:900;">italky<span style="color:var(--c-neon-blue)">AI</span></div>
      <div id="scoreTxt" style="color:var(--c-neon-green); font-weight:800;">0 PUAN</div>
    </div>

    <div class="stage">
      <div class="sentence-card">
        <div id="sentenceDisplay" class="sentence-text">...</div>
        <div id="gapContainer" class="gap-word-container"></div>
        <div id="translationDisplay" class="translation-text">...</div>
      </div>
      <div class="keyboard" id="keyboard"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin-top:0">GAP MASTER</h2>
      <div id="langSelector">
        <button onclick="setLang('en',this)" class="lang-btn active">ğŸ‡¬ğŸ‡§</button>
        <button onclick="setLang('de',this)" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button onclick="setLang('fr',this)" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button onclick="setLang('es',this)" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button onclick="setLang('it',this)" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
      </div>
      <button class="btn-main" onclick="initGame('A2')">KOLAY SEVÄ°YE</button>
      <button class="btn-main" onclick="initGame('B1')">ORTA SEVÄ°YE</button>
      <button class="btn-main" onclick="initGame('B2')">ZOR SEVÄ°YE</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let currentLang = 'en', puzzles = [], currentIdx = 0;
let score = 0, mistakes = 0, discoveredLetters = [];

window.setLang = (l, btn) => {
    currentLang = l;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

window.initGame = async (diff) => {
    try {
        const rawPool = await loadLangPool(currentLang);
        const { used, save } = createUsedSet(`gapmaster_v5_${currentLang}_${diff}`);
        
        const selected = pick(rawPool, 15, used, save, it => {
          const match = (diff === "A2") ? ["A1","A2"].includes(it.lvl) : (it.lvl === diff);
          return match && it.sentence;
        });

        puzzles = selected.map(it => ({
            word: it.w.toUpperCase(),
            fullSent: it.sentence.toUpperCase(),
            displaySent: it.sentence.toUpperCase().replace(new RegExp(`\\b${it.w}\\b`, 'gi'), '_____'),
            tr: it.tr // âœ… AnlamÄ± aÃ§Ä±k yazÄ±yoruz baÅŸkanÄ±m
        }));

        $('startModal').style.display = 'none';
        loadPuzzle();
    } catch (e) { alert("Hata oluÅŸtu!"); }
};

function loadPuzzle() {
    if (currentIdx >= puzzles.length) { alert("BaÅŸarÄ±yla tamamladÄ±nÄ±z! Skor: " + score); location.reload(); return; }
    const p = puzzles[currentIdx];
    mistakes = 0;
    discoveredLetters = new Array(p.word.length).fill(false);
    $('sentenceDisplay').textContent = p.displaySent;
    $('translationDisplay').textContent = p.tr;
    renderGapSlots();
    renderKeyboard();
}

function renderGapSlots() {
    const container = $('gapContainer'); container.innerHTML = '';
    const word = puzzles[currentIdx].word;
    for (let i = 0; i < word.length; i++) {
        const slot = document.createElement('div');
        slot.className = 'letter-slot' + (discoveredLetters[i] ? ' filled' : '');
        slot.textContent = discoveredLetters[i] ? word[i] : '';
        container.appendChild(slot);
    }
}

function renderKeyboard() {
    const kb = $('keyboard'); kb.innerHTML = '';
    const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const wordSet = new Set(puzzles[currentIdx].word.split(''));
    const shuffleAlpha = alpha.split('').filter(c => !wordSet.has(c)).sort(() => 0.5 - Math.random()).slice(0, 10);
    const finalKeys = [...wordSet, ...shuffleAlpha].sort();
    finalKeys.forEach(char => {
        const btn = document.createElement('button');
        btn.className = 'key-btn'; btn.textContent = char;
        btn.onclick = () => handleGuess(char, btn);
        kb.appendChild(btn);
    });
}

function handleGuess(char, btn) {
    const p = puzzles[currentIdx];
    if (p.word.includes(char)) {
        p.word.split('').forEach((l, idx) => { if (l === char) discoveredLetters[idx] = true; });
        renderGapSlots();
        if (discoveredLetters.every(l => l)) {
            score += (3 - Math.min(mistakes, 2)) * 10;
            $('scoreTxt').textContent = `${score} PUAN`;
            speak(p.fullSent);
            setTimeout(() => { currentIdx++; loadPuzzle(); }, 1500);
        }
    } else {
        btn.classList.add('wrong'); mistakes++;
    }
}

function speak(t) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    const m = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    u.lang = m[currentLang]; u.rate = 0.8;
    window.speechSynthesis.speak(u);
}
</script>
</body>
</html>
