<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>ITALKY â€¢ Duo Friend</title>
<link rel="icon" href="data:,"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
--bg:#020205;--text:#fff;
--p1:#00f3ff;--p2:#ff0066;
--green:#00e676;--red:#ff1744;--gold:#ffb800;
--border:rgba(255,255,255,.12)
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;background:var(--bg);color:var(--text);font-family:Outfit,sans-serif;overflow:hidden}
.wrap{max-width:480px;height:100%;margin:0 auto;display:flex;flex-direction:column;position:relative}

.header{height:70px;display:flex;align-items:center;justify-content:center;font-family:Space Grotesk;font-weight:900;letter-spacing:2px}
.grid{flex:1;display:grid;grid-template-rows:1fr 60px 1fr;gap:8px;padding:10px}

.pane{border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;overflow:hidden;background:linear-gradient(160deg,rgba(255,255,255,.04),rgba(0,0,0,.5))}
#paneB{transform:rotate(180deg)}
#paneB>*{transform:rotate(180deg)}

.bar{height:40px;padding:0 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);font-family:Space Grotesk;font-size:13px}
.score{font-weight:800}
.body{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:6px}
.word{font-size:28px;font-weight:900}
.mean{font-size:16px;opacity:.6}

.actions{height:60px;display:flex;gap:8px;padding:8px}
.mic{flex:2;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.08);color:#fff;font-weight:800}
.pass{flex:1;border-radius:12px;border:1px solid var(--border);background:transparent;color:#aaa}

.wave{height:60px;border:1px solid var(--border);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10}
.card{background:#101014;border:1px solid var(--border);border-radius:20px;padding:24px;text-align:center;width:90%}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:16px}
.lang{border:1px solid var(--border);border-radius:8px;padding:10px;font-size:20px;cursor:pointer}
.lang.active{background:var(--p1);color:#000}
.btn{width:100%;padding:14px;border-radius:14px;border:none;font-weight:900;margin-top:10px}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">DUO FRIEND</div>

  <div class="grid">
    <section class="pane" id="paneB">
      <div class="bar">
        <div>OYUNCU B</div>
        <div class="score" id="scoreB">0</div>
      </div>
      <div class="body">
        <div class="word" id="wordB">---</div>
        <div class="mean" id="meanB">---</div>
      </div>
      <div class="actions">
        <button class="pass" id="passB">PAS</button>
        <button class="mic" id="micB">ğŸ™ï¸</button>
      </div>
    </section>

    <div class="wave" id="wave">HAZIR</div>

    <section class="pane" id="paneA">
      <div class="bar">
        <div>OYUNCU A</div>
        <div class="score" id="scoreA">0</div>
      </div>
      <div class="body">
        <div class="word" id="wordA">---</div>
        <div class="mean" id="meanA">---</div>
      </div>
      <div class="actions">
        <button class="pass" id="passA">PAS</button>
        <button class="mic" id="micA">ğŸ™ï¸</button>
      </div>
    </section>
  </div>
</div>

<div class="modal" id="startModal">
  <div class="card">
    <h3>DÄ°L SEÃ‡</h3>
    <div class="langs">
      <div class="lang active" data-lang="en">ğŸ‡¬ğŸ‡§</div>
      <div class="lang" data-lang="de">ğŸ‡©ğŸ‡ª</div>
      <div class="lang" data-lang="fr">ğŸ‡«ğŸ‡·</div>
      <div class="lang" data-lang="es">ğŸ‡ªğŸ‡¸</div>
      <div class="lang" data-lang="it">ğŸ‡®ğŸ‡¹</div>
    </div>
    <button class="btn" id="startBtn">BAÅLA</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $=id=>document.getElementById(id);

let lang="en";
let pool=null;
let list=[];
let idx=0;
let turn="A";
let score={A:0,B:0};

const LANG_MAP={en:"en-US",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT"};

document.querySelectorAll(".lang").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang=b.dataset.lang;
  };
});

$("#startBtn").onclick=async()=>{
  $("#startModal").style.display="none";
  pool=await loadLangPool(lang);
  const {used,save}=createUsedSet("used_duofriend_"+lang);
  list=pick(pool,30,used,save,it=>{
    const w=String(it.w||"").replace(/[^a-zA-Z]/g,"");
    return w.length>=3 && w.length<=10;
  });
  idx=0;turn="A";score={A:0,B:0};
  nextWord();
};

function nextWord(){
  if(idx>=list.length){ idx=0; }
  const w=list[idx];
  $("#wordA").textContent=w.w;
  $("#wordB").textContent=w.w;
  $("#meanA").textContent="???";
  $("#meanB").textContent="???";
  $("#wave").textContent="SIRA: "+turn;
}

function normalize(s){
  return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

function listen(player){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return;
  const rec=new SR();
  rec.lang="tr-TR";
  rec.onresult=e=>{
    const said=e.results[0][0].transcript;
    check(player,said);
  };
  rec.start();
}

function check(player,spoken){
  const w=list[idx];
  const ok=normalize(spoken).includes(normalize(w.tr));
  if(ok){
    score[player]+=10;
    $("#score"+player).textContent=score[player];
    speak(w.tr,"tr-TR");
  }
  turn=turn==="A"?"B":"A";
  idx++;
  nextWord();
}

function speak(t,lang){
  const u=new SpeechSynthesisUtterance(t);
  u.lang=lang;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

$("#micA").onclick=()=>listen("A");
$("#micB").onclick=()=>listen("B");
$("#passA").onclick=()=>{turn="B";idx++;nextWord();};
$("#passB").onclick=()=>{turn="A";idx++;nextWord();};
</script>
</body>
</html>
