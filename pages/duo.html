<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ITALKY ‚Ä¢ Duo Battle AI</title>
  <link rel="icon" href="data:,"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS (COSMOS TEMA) --- */
    :root { 
      --bg-deep: #020205; 
      --text-main: #ffffff; 
      --c-cyan: #00f3ff; 
      --c-green: #beF264; 
      --c-red: #ff5252; 
      --border: rgba(255, 255, 255, 0.1); 
    }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; user-select:none; }
    html, body { margin:0; height:100dvh; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); }
    
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.4; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; animation: dustMove 100s linear infinite; }
    @keyframes dustMove { from { transform: translateY(0); } to { transform: translateY(-500px); } }
    
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; }
    
    /* NAV */
    .nav-layer { position:absolute; top:0; left:0; width:100%; height:70px; z-index:50; display:flex; justify-content:space-between; padding:12px; pointer-events:none; }
    .nav-btn { pointer-events:auto; height:44px; padding:0 16px; border-radius:14px; background:rgba(0,0,0,0.4); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); cursor:pointer; font-weight:700; font-size:14px; gap:6px; transition:0.2s; }
    .nav-btn:active { transform:scale(0.95); }
    .brand-mini { pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .brand-mini span { font-family:'Space Grotesk', sans-serif; font-weight: 700; font-size: 20px; line-height: 1; }
    .brand-mini small { font-size: 9px; letter-spacing: 3px; opacity: 0.6; margin-top: 2px; }
    
    /* GRID */
    .grid { flex:1; display:grid; grid-template-rows: 1fr 80px 1fr; gap:12px; padding:70px 12px 20px; }
    
    /* KARTLAR */
    .pane { position:relative; border-radius:24px; border:1px solid var(--border); background: linear-gradient(160deg, rgba(255,255,255,0.03), rgba(0,0,0,0.4)); backdrop-filter:blur(10px); display:flex; flex-direction:column; overflow:hidden; transition: 0.3s; }
    .pane.active { border-color:var(--c-cyan); box-shadow: 0 0 30px rgba(0,243,255,0.15); }
    .pane.top { transform: rotate(180deg); }
    
    .bar { padding:12px 16px; background:rgba(0,0,0,0.3); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-family:'Space Grotesk', sans-serif; }
    .p-name { font-weight:700; font-size:15px; opacity:0.9; }
    .p-score { font-weight:700; color:var(--c-green); }
    
    .prog-wrap { padding:12px 16px 0; }
    .prog-track { height:6px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; }
    .prog-fill { height:100%; width:0%; background:var(--c-green); transition: width 0.3s ease; }
    .prog-meta { display:flex; justify-content:space-between; margin-top:6px; font-size:11px; opacity:0.6; font-weight:600; text-transform:uppercase; }
    
    .body { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px; padding:10px; }
    .word { font-size:32px; font-weight:800; color:#fff; font-family:'Space Grotesk', sans-serif; text-align:center; }
    .meaning { font-size:16px; color:rgba(255,255,255,0.6); font-weight:500; }
    .hint { font-size:12px; color:var(--c-cyan); font-weight:700; margin-top:8px; opacity:0; transition:0.3s; text-transform:uppercase; letter-spacing:1px; }
    .pane.active .hint { opacity:1; }
    
    .actions { padding:16px; display:flex; justify-content:center; }
    .mic-btn { width:100%; padding:14px; border-radius:16px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:#fff; font-weight:700; font-size:16px; cursor:pointer; transition:0.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
    .pane.active .mic-btn { background: linear-gradient(135deg, var(--c-cyan), #0066ff); border:none; box-shadow: 0 10px 30px rgba(0,243,255,0.3); }
    .mic-btn:disabled { opacity:0.3; cursor:not-allowed; background:rgba(255,255,255,0.05) !important; box-shadow:none !important; }
    .mic-btn:active { transform:scale(0.96); }
    
    /* WAVE */
    .wave-box { border-radius:20px; background:rgba(0,0,0,0.6); border:1px solid var(--border); backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; position:relative; overflow:hidden; }
    .wave-status { font-size:12px; font-weight:700; opacity:0.8; letter-spacing:1px; text-transform:uppercase; color:var(--c-cyan); }
    .bars { display:flex; gap:4px; height:24px; align-items:center; }
    .b { width:4px; height:8px; background:rgba(255,255,255,0.3); border-radius:4px; transition:0.2s; }
    .wave-box.speaking .b { background:var(--c-green); animation: bounce 0.6s infinite ease-in-out; }
    .wave-box.listening .b { background:var(--c-cyan); animation: bounce 0.5s infinite ease-in-out; }
    @keyframes bounce { 0%,100%{height:8px} 50%{height:24px} }
    .b:nth-child(1){animation-delay:0s} .b:nth-child(2){animation-delay:0.1s} .b:nth-child(3){animation-delay:0.2s} .b:nth-child(4){animation-delay:0.3s} .b:nth-child(5){animation-delay:0.4s}
    
    /* OVERLAY */
    .result-overlay { position:absolute; inset:0; z-index:20; background:rgba(0,0,0,0.8); display:none; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(5px); animation:fadeIn 0.3s; }
    .result-overlay.show { display:flex; }
    .res-icon { font-size:64px; margin-bottom:10px; animation:popIn 0.4s; }
    .res-text { font-size:18px; font-weight:800; font-family:'Space Grotesk', sans-serif; text-transform:uppercase; letter-spacing:2px; }
    .ok .res-text { color:var(--c-green); } .bad .res-text { color:var(--c-red); }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} } @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    
    /* MODAL */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(15px); }
    .modal-card { width:85%; background:#101014; border:1px solid var(--border); border-radius:24px; padding:24px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.8); animation: popIn 0.5s; }
    .modal-title { font-size:20px; font-weight:800; margin-bottom:16px; font-family:'Space Grotesk', sans-serif; }
    .modal-p { font-size:14px; opacity:0.7; margin-bottom:24px; line-height:1.5; }
    .btn-primary { width:100%; padding:16px; border-radius:16px; border:none; background:linear-gradient(135deg, var(--c-cyan), #0066ff); color:#fff; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 10px 30px rgba(0,100,255,0.3); transition:0.2s; }
    .btn-primary:active { transform:scale(0.98); }
    .btn-sec { background:rgba(255,255,255,0.1); margin-top:10px; color:#fff; }
    .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--c-cyan); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>

  <div class="wrap">
    <div class="nav-layer">
      <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚Üê</button>
      <div class="brand-mini" onclick="window.location.href='/pages/home.html'">
        <span>italky<span style="color:#6366f1">AI</span></span>
        <small>DUO AI</small>
      </div>
      <button class="nav-btn" style="opacity:0">.</button>
    </div>

    <div class="grid">
      <section class="pane top" id="paneB">
        <div class="bar"><div class="p-name">√ñƒûRETMEN AI</div><div class="p-score" id="scoreB"></div></div>
        <div class="prog-wrap">
          <div class="prog-track"><div class="prog-fill" id="fillB"></div></div>
          <div class="prog-meta"><span id="corrB"></span><span id="turnB">Bekliyor</span></div>
        </div>
        <div class="body">
          <div class="word" id="wordB">---</div>
          <div class="meaning" id="meanB">---</div>
          <div class="hint">OKUYOR...</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micB" disabled>üéôÔ∏è</button></div>
      </section>

      <div class="wave-box" id="waveBox">
        <div class="wave-status" id="waveStatus">HAZIR</div>
        <div class="bars"><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div></div>
      </div>

      <section class="pane" id="paneA">
        <div class="bar"><div class="p-name">SEN</div><div class="p-score" id="scoreA"></div></div>
        <div class="prog-wrap">
          <div class="prog-track"><div class="prog-fill" id="fillA"></div></div>
          <div class="prog-meta"><span id="corrA"></span><span id="turnA">Bekliyor</span></div>
        </div>
        <div class="body">
          <div class="word" id="wordA">---</div>
          <div class="meaning" id="meanA">---</div>
          <div class="hint">SENƒ∞N SIRAN</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micA" disabled>üéôÔ∏è KONU≈û</button></div>
        <div class="result-overlay" id="ovA"></div>
      </section>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">DUO BATTLE AI ü•ä</div>
      <div class="modal-p">
        Yapay Zeka kelimeleri hazƒ±rlƒ±yor...<br>
        √ñƒüretmen kelimeyi okuyacak, sen tekrar edeceksin.
      </div>
      <div id="loading" style="display:none"><div class="loader"></div><div style="font-size:12px;opacity:0.6">Kelimeler √úretiliyor...</div></div>
      <button class="btn-primary" id="startBtn">BA≈ûLA</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <div class="modal-title">MA√á Bƒ∞TTƒ∞! üéâ</div>
      <div class="modal-p" id="endResult"></div>
      <button class="btn-primary" onclick="location.reload()">YENƒ∞ KELƒ∞MELERLE OYNA</button>
      <button class="btn-primary btn-sec" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

let wordList = [];
let currentIndex = 0;
let isBusy = false;
let score = 0;

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// Ses Motorunu Isƒ±t (iOS Fix)
async function warmUpVoices(){
  try{
    window.speechSynthesis.getVoices();
    await sleep(150);
    window.speechSynthesis.getVoices();
  }catch{}
}

function setWave(s, t) {
  $("waveBox").className = "wave-box " + (s || "");
  $("waveStatus").textContent = t || "HAZIR";
}

function safeParseWordList(raw){
  if(Array.isArray(raw)) return raw;
  let txt = "";
  if(typeof raw === "string") txt = raw;
  else if(raw && typeof raw === "object"){
    txt = raw.text || raw.message || raw.output || raw.result || "";
  }
  txt = String(txt || "").trim();
  txt = txt.replace(/```json/gi,"").replace(/```/g,"").trim();
  const parsed = JSON.parse(txt);
  if(!Array.isArray(parsed)) throw new Error("wordList not array");
  return parsed;
}

async function fetchWordsFromAI() {
  $("loading").style.display = "block";
  $("startBtn").style.display = "none";
  setWave("idle","Hazƒ±rlanƒ±yor...");

  try {
    const res = await fetch(`${apiBase()}/api/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: "Bana ƒ∞ngilizce B1 seviyesinde 20 kelime ve T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ±nƒ± SADECE JSON array formatƒ±nda ver: [[\"apple\",\"elma\"], ...]. Kod bloƒüu kullanma.",
        max_tokens: 1000
      })
    });

    const data = await res.json();
    wordList = safeParseWordList(data);

    // Temizlik
    wordList = wordList
      .filter(x => Array.isArray(x) && x.length >= 2)
      .map(x => [String(x[0]||"").trim(), String(x[1]||"").trim()])
      .filter(x => x[0] && x[1]);

    if (wordList.length < 5) throw new Error("too few words");

  } catch (err) {
    // Yedek (Fallback)
    wordList = [
      ["Hello", "Merhaba"], ["Friend", "Arkada≈ü"], ["Love", "A≈ük"], ["Money", "Para"],
      ["Time", "Zaman"], ["Future", "Gelecek"], ["Silent", "Sessiz"], ["Power", "G√º√ß"]
    ];
  }

  $("startModal").style.display = "none";
  await warmUpVoices();
  startGameLoop(true);
}

function startGameLoop(startWithTeacherNow = false) {
  currentIndex = 0;
  score = 0;
  updateUI();
  if(startWithTeacherNow){ teacherPhase(); }
  else{ setTimeout(teacherPhase, 600); }
}

function updateUI() {
  if (currentIndex >= wordList.length) { endSet(); return; }
  const w = wordList[currentIndex];

  $("wordA").textContent = w[0]; $("meanA").textContent = w[1];
  $("wordB").textContent = w[0]; $("meanB").textContent = w[1];
  $("fillA").style.width = (score / wordList.length * 100) + "%";
  $("corrA").textContent = score + " Doƒüru";
  
  $("paneA").classList.remove("active");
  $("paneB").classList.remove("active");
  $("micA").disabled = true;
  setWave("idle","Hazƒ±r");
}

function speakBrowser(text, lang) {
  return new Promise((resolve) => {
    try{ window.speechSynthesis.cancel(); }catch{}
    const u = new SpeechSynthesisUtterance(String(text||""));
    u.lang = lang || "en-US";
    u.rate = 0.9;
    u.onend = resolve;
    u.onerror = resolve;
    try { window.speechSynthesis.speak(u); } catch { resolve(); }
  });
}

async function teacherPhase() {
  if(isBusy) return;
  isBusy = true;
  $("paneB").classList.add("active");
  setWave("speaking", "√ñƒüretmen Okuyor...");
  await speakBrowser(wordList[currentIndex][0], "en-US");
  $("paneB").classList.remove("active");
  $("paneA").classList.add("active");
  setWave("idle", "Sƒ±ra Sende");
  isBusy = false;
  $("micA").disabled = false;
}

function normalize(s){
  return String(s||"").toLowerCase().trim().replace(/[‚Äô']/g,"").replace(/[.,!?]/g,"").replace(/\s+/g," ");
}

function similarity(a,b){
  a = normalize(a); b = normalize(b);
  if(!a || !b) return 0;
  if(a === b) return 1;
  const min = Math.min(a.length,b.length);
  let same = 0;
  for(let i=0;i<min;i++){ if(a[i]===b[i]) same++; else break; }
  return same / Math.max(a.length,b.length);
}

function listen() {
  if (isBusy) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("Tarayƒ±cƒ± desteklemiyor."); return; }
  try { window.speechSynthesis.cancel(); } catch {}

  isBusy = true;
  $("micA").disabled = true;
  setWave("listening", "Dinleniyor...");

  const rec = new SR();
  rec.lang = "en-US";
  rec.interimResults = false;
  let gotResult = false;

  rec.onresult = (e) => {
    gotResult = true;
    checkResult(e.results?.[0]?.[0]?.transcript || "");
  };
  rec.onerror = () => { cleanupAfterListen(); };
  rec.onend = () => { if(!gotResult) cleanupAfterListen(); };
  try { rec.start(); } catch { cleanupAfterListen(); }
}

function cleanupAfterListen(){
  isBusy = false;
  $("micA").disabled = false;
  setWave("idle", "Sƒ±ra Sende");
}

async function checkResult(spokenText) {
  const target = wordList[currentIndex][0];
  const s = normalize(spokenText);
  const t = normalize(target);
  
  // Toleranslƒ± kontrol
  const ok = (s.includes(t) || similarity(s,t) >= 0.55);
  showResultOverlay(ok);
  if (ok) score++;
  
  await sleep(1200);
  currentIndex++;
  updateUI();
  await sleep(500);
  isBusy = false;
  teacherPhase();
}

function showResultOverlay(isOk) {
  const ov = $("ovA");
  ov.innerHTML = `<div class="res-icon">${isOk ? "‚úÖ" : "‚ùå"}</div><div class="res-text">${isOk ? "M√úKEMMEL" : "TEKRAR DENE"}</div>`;
  ov.className = "result-overlay show " + (isOk ? "ok" : "bad");
  setTimeout(() => ov.classList.remove("show"), 1200);
}

function endSet() {
  $("endModal").style.display = "flex";
  $("endResult").textContent = `Skorun: ${score}/${wordList.length}`;
  setWave("idle","Ma√ß bitti");
}

$("startBtn").onclick = fetchWordsFromAI;
$("micA").onclick = listen;
setWave("idle","HAZIR");
</script>
</body>
</html>
